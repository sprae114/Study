## ìƒì„±/ìˆ˜ì • ìë™í™”í•˜ê¸°
ì¶œì²˜ : [[ë°°ì›Œë³´ì Spring Data JPA] JPA Auditing ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì„œ ìƒì„±, ìˆ˜ì • ì¼ì ìë™í™”í•˜ê¸° (tistory.com)](https://wonit.tistory.com/484),
![[Pasted image 20230106164758.jpg]]

#### ğŸ“Œ ì§ì ‘ ë“±ë¡
=> ì§ì ‘ ë‚ ì§œë¥¼ ë„£ì§€ ì•Šìœ¼ë©´ ê°’ì´ X.
- User
```java
public class User {  
	...
    private LocalDateTime createdAt;  
	private LocalDateTime updatedAt;  
}
```

- Test
```java
@Test  
void checkTime(){  
    User userA = new User("kang", "david@fastcampus.com");  
    userA.setCreatedAt(LocalDateTime.now());  
    userA.setUpdatedAt(LocalDateTime.now());  
  
    User userB = new User("kim", "david@fastcampus.com");  
  
    userRepository.save(userA);  
    userRepository.save(userB);  
  
    userRepository.findAll().forEach(System.out::println);  
}
```

```
...
User(id=1, name=kang, email=david@fastcampus.com, createdAt=2023-01-05T23:15:14.507797, updatedAt=2023-01-05T23:15:14.507797)
User(id=2, name=kim, email=david@fastcampus.com, createdAt=null, updatedAt=null)
```


#### ğŸ“Œ @PrePersist
=>ê°’ì„ ì„¸íŒ…í•˜ì§€ ì•Šì•„ë„ PrePersistì „ì— ë“±ë¡í•´ì¤Œ. í•˜ì§€ë§Œ Entityë§ˆë‹¤ ë°˜ë³µì ìœ¼ë¡œ ì½”ë“œë¥¼ ìƒì„±í•´ì•¼ë˜ëŠ” ë¬¸ì œ
- User
```java
public class User {  
	...
    private LocalDateTime createdAt;  
  
	private LocalDateTime updatedAt;  
	  
	@PrePersist  
	public void prePersist(){  
	    createdAt = LocalDateTime.now();  
	    updatedAt = LocalDateTime.now(); 

	@PreUpdate  
	public void preUpdate(){  
	    updatedAt = LocalDateTime.now();  
	}
}
```

- Test
```java
@Test  
void checkTime2(){  
    User userA = new User("kang", "david@fastcampus.com");  
    userRepository.findAll().forEach(System.out::println);  
}
```

```
...
User(id=1, name=kang, email=david@fastcampus.com, createdAt=2023-01-05T23:18:37.056332, updatedAt=2023-01-05T23:18:37.056332)
```


#### ğŸ“Œ Listener
ì¶œì²˜ : [Spring boot :: JPA @EntityListeners ì •ë¦¬ (tistory.com)](https://wave1994.tistory.com/161), [[Spring JPA] Entity Listener (velog.io)](https://velog.io/@seongwon97/Spring-Boot-Entity-Listener)
=> `Entity Listener` : ì—”í‹°í‹°ì˜ ë³€í™”ë¥¼ ê°ì§€í•˜ê³  ë°ì´ë¸”ì˜ ë°ì´í„°ë¥¼ ì¡°ì‘í•˜ëŠ” ì¼
=> ìƒì†ì„ ì´ìš©í•´ì„œ ë‹¤ë¥¸ ì—”í‹°í‹°ì—ë„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•¨.

- User
```java
@EntityListeners(value = MyEntityListener.class)  
public class User implements Auditable {  
	...
  
    private LocalDateTime createdAt;  
    private LocalDateTime updatedAt;  
}


public interface Auditable {  
    LocalDateTime getCreatedAt();  
    LocalDateTime getUpdatedAt();  
  
    void setCreatedAt(LocalDateTime createdAt);  
    void setUpdatedAt(LocalDateTime updatedAt);  
}


public class MyEntityListener {  
    @PrePersist  
    public void prePersist(Object o) {  
        if (o instanceof Auditable) {  
            ((Auditable) o).setCreatedAt(LocalDateTime.now());  
            ((Auditable) o).setUpdatedAt(LocalDateTime.now());  
        }  
    }  
  
    @PreUpdate  
    public void preUpdate(Object o) {  
        if (o instanceof Auditable) {  
            ((Auditable) o).setUpdatedAt(LocalDateTime.now());  
        }  
    }  
}
```

- Test
```java
@Test  
void checkTime3(){  
    User userA = new User("kang", "david@fastcampus.com");  
    userRepository.save(userA);  
  
    userRepository.findAll().forEach(System.out::println);  
  
    Book book = new Book();  
    book.setName("Jpa ì´ˆê²©ì°¨ íŒ¨í‚¤ì§€");  
    book.setAuthor("íŒ¨ìŠ¤íŠ¸ìº í¼ìŠ¤");  
  
    bookRepository.save(book);  
    System.out.println(bookRepository.findAll());  
}
```

```
...
User(id=6, name=kang, email=david@fastcampus.com, createdAt=2023-01-06T00:21:02.300407, updatedAt=2023-01-06T00:21:02.300407)
Book(id=7, name=Jpa ì´ˆê²©ì°¨ íŒ¨í‚¤ì§€, author=íŒ¨ìŠ¤íŠ¸ìº í¼ìŠ¤, createdAt=2023-01-06T00:21:02.502403, updatedAt=2023-01-06T00:21:02.502403)
```


#### ğŸ“Œ @EnableJpaAuditing
- ìŠ¤í”„ë§ì—ì„œ ì œê³µí•˜ëŠ” @EnableJpaAuditingë¥¼ ì¨ë³´ì
```java
@SpringBootApplication
@EnableJpaAuditing  
public class JpaTestApplication {  
    public static void main(String[] args) {  
        ...
    }  
}


@EntityListeners(value = {AuditingEntityListener.class, UserEntityListener.class})  
public class User implements Auditable {  
	...
	
    //private LocalDateTime createdAt;  
    //private LocalDateTime updatedAt;  
}


@EntityListeners(value = AuditingEntityListener.class)  
public class UserHistory implements Auditable{  
	...
	
    //private LocalDateTime createdAt;  
    //private LocalDateTime updatedAt;  
}
```

- í…ŒìŠ¤íŠ¸
```java
@Test  
void checkTime4() throws Exception{  
    User user = new User();  
    user.setEmail("martin-new@fastcampus.com");  
    user.setName("martin-new");  
  
    userRepository.save(user);  //ì €ì¥  
  
    Thread.sleep(2000); //ì§€ì—°ì‹œí‚¤ê¸°  
  
    user.setName("martin-new-new");  
    userRepository.save(user);  //ì—…ë°ì´íŠ¸  
  
    userRepository.findAll().forEach(System.out::println);  
    userHistoryRepository.findAll().forEach(System.out::println);  
}
```

```
User(id=1, name=martin-new-new, email=martin-new@fastcampus.com, createdAt=2023-01-06T17:39:14.176784, updatedAt=2023-01-06T17:39:16.315623)
UserHistory(id=2, userId=1, name=martin-new-new, email=martin-new@fastcampus.com, createdAt=2023-01-06T17:39:16.318615, updatedAt=2023-01-06T17:39:16.318615)
```


#### ğŸ“Œ BaseEntity
ì¶œì²˜ : [[JPA] @MappedSuperclass (tistory.com)](https://ict-nroo.tistory.com/129), 

- 
```java
@MappedSuperclass  
@EntityListeners(value = AuditingEntityListener.class)  
public class BaseEntity implements Auditable{  
  
    @CreatedDate  
    private LocalDateTime createdAt;  
  
    @LastModifiedDate  
    private LocalDateTime updatedAt;  
}


@ToString(callSuper = true)  
@EqualsAndHashCode(callSuper = true)  
@Entity  
@EntityListeners(value = UserEntityListener.class)  
public class User extends BaseEntity {  
    @Id  
    @GeneratedValue    private Long id;  
  
    @NonNull  
    private String name;  
  
    @NonNull  
    private String email;  
}


@ToString(callSuper = true)  
@EqualsAndHashCode(callSuper = true)  
public class UserHistory extends BaseEntity {  
    @Id  
    @GeneratedValue    private Long id;  
  
    private Long userId;  
  
    private String name;  
  
    private String email;  
  
}
```
- `@MappedSuperclass` : ê³µí†µ ë§¤í•‘ ì •ë³´ê°€ í•„ìš”í•  ë•Œ, ë¶€ëª¨ í´ë˜ìŠ¤ì— ì„ ì–¸í•˜ê³  ì†ì„±ë§Œ ìƒì† ë°›ì•„ì„œ ì‚¬ìš©í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•œë‹¤.


- test
```java
@Test  
void checkTime4() throws Exception{  
    User user = new User();  
    user.setEmail("martin-new@fastcampus.com");  
    user.setName("martin-new");  
  
    userRepository.save(user);  //ì €ì¥  
  
    user.setName("martin-new-new");  
    userRepository.save(user);  //ì—…ë°ì´íŠ¸  
  
    userRepository.findAll().forEach(System.out::println);  
    userHistoryRepository.findAll().forEach(System.out::println);  
}
```

```
User(super=BaseEntity(createdAt=2023-01-06T21:51:49.125318, updatedAt=2023-01-06T21:51:49.258960), id=1, name=martin-new-new, email=martin-new@fastcampus.com)
UserHistory(super=BaseEntity(createdAt=2023-01-06T21:51:49.263945, updatedAt=2023-01-06T21:51:49.263945), id=2, userId=1, name=martin-new-new, email=martin-new@fastcampus.com)
```


## ë³€ê²½ì  ì €ì¥í•˜ê¸°
- Userê°€ ë³€ê²½ë˜ì—ˆì„ë•Œ, UserHistoryë¡œ ì €ì¥í•˜ê¸° ìœ„í•œ ë°©ë²•
```java
@EntityListeners(value = {MyEntityListener.class, UserEntityListener.class})  
public class User implements Auditable {  
    @Id  
    @GeneratedValue    
    private Long id;  
  
    @NonNull  
    private String name;  
  
    @NonNull  
    private String email;  
  
    private LocalDateTime createdAt;  
    private LocalDateTime updatedAt;  
}


@EntityListeners(value = MyEntityListener.class)  
public class UserHistory implements Auditable{  
    @Id  
    @GeneratedValue    private Long id;  
  
    private Long userId;  
  
    private String name;  
  
    private String email;  
  
    private LocalDateTime createdAt;  
    private LocalDateTime updatedAt;  
}


public class UserEntityListener {  
  
    @PreUpdate  
    public void preUpdate(Object o){  
        //ì»¨í…Œì´ë„ˆì—ì„œ ë¹ˆì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ  
        UserHistoryRepository userHistoryRepository = BeanUtils.getBean(UserHistoryRepository.class);  
  
        User user = (User) o;  
  
        UserHistory userHistory = new UserHistory();  
        userHistory.setUserId(user.getId());  
        userHistory.setName(user.getName());  
        userHistory.setEmail(user.getEmail());  
  
        userHistoryRepository.save(userHistory);  
    }  
}
```

- í…ŒìŠ¤íŠ¸
```java
@Test  
void checkTime4() throws Exception{  
    User user = new User();  
    user.setEmail("martin-new@fastcampus.com");  
    user.setName("martin-new");  
  
    userRepository.save(user);  //ì €ì¥  
  
    Thread.sleep(2000); //ì§€ì—°ì‹œí‚¤ê¸°  
  
    user.setName("martin-new-new");  
    userRepository.save(user);  //ì—…ë°ì´íŠ¸  
  
    userRepository.findAll().forEach(System.out::println);  
    userHistoryRepository.findAll().forEach(System.out::println);  
}
```

```
User(id=1, name=martin-new-new, email=martin-new@fastcampus.com, createdAt=2023-01-06T17:21:16.945565, updatedAt=2023-01-06T17:21:19.074363)

UserHistory(id=2, userId=1, name=martin-new-new, email=martin-new@fastcampus.com, createdAt=2023-01-06T17:21:19.077391, updatedAt=2023-01-06T17:21:19.077391)
```


## Listener ì£¼ì˜ì 

- userì˜ ì •ë³´ê°€ ì €ì¥ë ë•Œë§ˆë‹¤, ê¸°ë¡í•˜ê¸° ìœ„í•œ Entity
```java
@Component  
public class UserEntityListener {  
    @Autowired  
    private  UserHistoryRepository userHistoryRepository;  
  
    @PreUpdate  
    public void preUpdate(Object o){  
        User user = (User) o;  
  
        UserHistory userHistory = new UserHistory();  
        userHistory.setUserId(user.getId());  
        userHistory.setName(user.getName());  
        userHistory.setEmail(user.getEmail());  
  
        userHistoryRepository.save(userHistory);  
    }  
}

@EntityListeners(value = {MyEntityListener.class, UserEntityListener.class})  
public class User implements Auditable {  
  ..
}
```
ğŸ’¥`@Autowired` ë¥¼ í•˜ê¸° ìœ„í•´ì„œëŠ” `@Component`ë¥¼ ì¨ì•¼í•¨. ê·¸ ì´ìœ ëŠ” ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ì£¼ì…í•˜ê¸° ìœ„í•¨. 
ğŸ’¥EntityListenerëŠ” ìŠ¤í”„ë§ ë¹ˆì„ ì£¼ì…ë°›ì§€ ëª»í•¨. why? ì•„ë§ˆë„ ì‹œì‘í• ë•Œ ëª¨ë“  ë¹ˆì„ ì»¨í…Œì´ë„ˆì— ì£¼ì…í•˜ê³  ì˜ì¡´ê´€ê³„ë¥¼ ì£¼ì… ë°›ëŠ”ë° ListenerëŠ” ê·¸ ì´í›„ì— ì¼ì–´ë‚˜ëŠ” ì¼ì´ë‹ˆê¹ ì£¼ì…ë°›ì§€ ëª»í•˜ëŠ” ê²ƒì´ ì•„ë‹ê¹Œ ìƒê°í•¨.


