ë§í¬ : [[ìë°” orm í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë°.pdf]]
í•´ì‹œíƒœí¬ : #ì—°ê´€ê´€ê³„ , #mappedBy

----
#### ğŸ“Œ ì—°ê´€ê´€ê³„ì˜ í•„ìš”ì„±í•œ ì´ìœ ëŠ”?
=> ê°ì²´ì§€í–¥ ì„¤ê³„ì˜ ëª©í‘œëŠ” ììœ¨ì ì¸ ê°ì²´ë“¤ì˜Â **í˜‘ë ¥ ê³µí†µì²´**ë¥¼ ë§Œë“œëŠ” ê²ƒì„.ê°ì²´ë¥¼ í…Œì´ë¸”ì— ë§ì¶° ë°ì´í„° ì¤‘ì‹¬ìœ¼ë¡œ ëª¨ë¸ë§í•˜ë©´, í˜‘ë ¥ ê´€ê³„ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ëŠ” í•œê³„ì .


#### ğŸ“Œ ê°ì²´ì§€í–¥ê³¼ DBëŠ” ì–´ë–¤ì ì´ ë‹¤ë¥¼ê¹Œ?
ì¶œì²˜ : [JPA, ê°ì²´ì§€í–¥ê³¼ RDB (tistory.com)](https://tang-co.tistory.com/106)

![[Pasted image 20230110172802.png]]
1) DBì—ëŠ” **ê°ì²´**ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ. ê·¸ë˜ì„œ Â ìƒì†, ê°ì²´ ê°„ ì°¸ì¡° ë°œìƒ ì‹œ ì €ì¥ì´ ì–´ë ¤ì›€.
2) **ì—°ê´€ê´€ê³„**ì˜ ì°¨ì´ì . ê°ì±„ëŠ” ì°¸ì¡°ì‚¬ìš©, í…Œì´ë¸”ì€ ì™œë˜í‚¤ ì‚¬ìš©í•¨
3) ê°ì²´ëŠ” ììœ ë¡­ê²Œ ê·¸ë˜í”„ **íƒìƒ‰** ê°€ëŠ¥í•¨.


#### ğŸ“Œ ì—°ê´€ê´€ê³„ ë§¤í•‘ì‹œ ê³ ë ¤í•´ì•¼ë  3ê°€ì§€ëŠ”?
1) **ë°©í–¥** : ê°ì²´ê´€ê³„ì—ë§Œ ë°©í–¥ì´ ì¡´ì¬í•˜ê³ , í…Œì´ë¸”ì€ í•­ìƒ ì–‘ë°©í–¥ê´€ê³„ì´ë‹¤.
2) **ë‹¤ì¤‘ì„±** : ë‹¤ëŒ€ì¼, ì¼ëŒ€ì¼.. ì—°ê´€ê´€ê³„ë¥¼ ì–´ë–»ê²Œ ë§ºì„ê²ƒì¸ì§€ ê³ ë ¤í•´ì•¼í•¨.
3) **ì—°ê´€ê´€ê³„ì£¼ì¸** : ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì„ ì •í•´ì•¼í•¨.


#### ğŸ“Œ (ì½”ë“œ) ìˆœìˆ˜í•œ ê°ì²´ì¼ë•Œ ì—°ê´€ê´€ê³„ëŠ”?
- ê·¸ë¦¼
![[Pasted image 20230115155708.png]]

- í´ë˜ìŠ¤ êµ¬ì„±
```java
public class Member {

    private Long id;
    private String username;
    
    private Team team;

	public void setTeam(Team team){
		this.team = team;
	}

	//Getter, Setter
}


public class Team{

    private Long id;
    private String name;

	//Getter, Setter
}
```

- ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§
```java
public static void main(String[] args) {  
  
    Member member1 = new Member("member1", "íšŒì›1");  
    Member member2 = new Member("member1", "íšŒì›2");  
    Team team1 = new Team("team1", "íŒ€1");  
  
    member1.setTeam(team1);  
    member2.setTeam(team1);  
  
    Team findTeam = member1.getTeam();  
}
```

#### ğŸ“Œ (ì½”ë“œ) í…Œì´ë¸”ë§Œ ìˆëŠ” ì—°ê´€ê´€ê³„ëŠ”?
- ê·¸ë¦¼
![[Pasted image 20230115155609.png]]

- DDL
```sql
CREATE TABLE MEMBER (
	MEMBER_ID VARCHAR (255) NOT NULL,
	TEAM_ID VARCHAR (255),
	USERNAME VARCHAR (255),
	PRIMARY KEY (MEMBER_ID)
)

CREATE TABLE TEAM (
	TEAM_ID VARCHAR (255) NOT NULL,
	NAME VARCHAR (255),
	PRIMARY KEY (TEAM_ID)
)

##ì™¸ë˜í‚¤ ì œì•½ì¡°ê±´ ì¶”ê°€
ALTER TABLE MEMBER ADD CONSTRAINT FK_MEMBER_TEAM
	FOREIGN KEY (TEAM_ID)
	REFERENCES TEAM
```


#### ğŸ“Œ (ì½”ë“œ) ê°ì²´ì™€ í…Œì´ë¸”ì„ ì—°ê´€ê´€ê³„ ì‹œí‚¤ì§€ ì•Šìœ¼ë©´?
- ê·¸ë¦¼
![[Pasted image 20230110172241.png]]

- íšŒì› ì—”í‹°í‹°
```java
@Entity
public class Member {
    
    @Id @GeneratedValue
    @Column(name = "MEMBER_ID")
    private Long id;
    
    @Column(name = "USERNAME")
    private String name;
    
    @Column(name = "TEAM_ID")
    private Long teamId;
}

/* íŒ€(Team) ì—”í‹°í‹° */
@Entity
public class Team{
    @Id @GeneratedValue
    @Column(name = "TEAM_ID")
    private Long id;

    private String name;
}
```

- ìƒì„±ëœ SQL
![[Pasted image 20230110173047.png]]
=>TEAM_IDê°€ TABLEì— ê·¸ëŒ€ë¡œ ìƒì„±ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. ì§€ê¸ˆì€Â ì°¸ì¡°ê°€ ì•„ë‹Œ, **ì™¸ë˜í‚¤(FK)ë¥¼ ì‚¬ìš©**í•´ì„œ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ê³  ìˆëŠ” ë¬¸ì œ

- íŒ€ì— íšŒì› ì €ì¥í•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
```java
transaction.begin();
try {
    //íŒ€ ì €ì¥
    Team team = new Team();
    team.setName("TeamA");
    entityManager.persist(team);
    
    //íšŒì› ì €ì¥
    Member member = new Member();
    member.setName("member1");
    member.setTeamId(team.getId()); // member.setTeam(team); ì´ë ‡ê²Œ ê³ ì¹˜ê³  ì‹¶ì–´
    entityManager.persist(member);

    transaction.commit();
}catch (Exception e){
    transaction.rollback();
}finally {
    entityManager.close();
}
```
=> `team.getId()`ì™€ ê°™ì´ Teamì˜ ì‹ë³„ìë¥¼ ì§ì ‘ ê°€ì ¸ì™€ì„œ ë“±ë¡í•¨. ê·¸ë˜ì„œ ê°ì²´ì§€í–¥ì ìœ¼ë¡œ ë°”ê¾¸ê¸° ìœ„í•´ `member.setTeam(team)`ì™€ ê°™ì´ ë³€ê²½í•˜ê³  ì‹¶ìŒ.


#### ğŸ“Œ (ì½”ë“œ) JPAë¥¼ ì‚¬ìš©í•´ì„œ ê°ì²´ì™€ í…Œì´ë¸” ì—°ê´€ê´€ê³„ ë§¤í•‘ì˜ˆì‹œ
- ê·¸ë¦¼
![[Pasted image 20230115160200.png]]

```java
/* íšŒì›(Member) ì—”í‹°í‹°*/
@Entity
public class Member {
    
    @Id
    @Column(name = "MEMBER_ID")
    private Long id;
    private String username;

	//ì—°ê´€ê´€ê³„ë§¤í•‘
	@ManyToOne
    @JoinColumn(name = "TEAM_ID")
    private Team team;

	//ì—°ê´€ê´€ê³„ ì„¤ì •
	public void setTeam(Team team){
		this.team = team;
	}

	//Getter, Setter
}

/* íŒ€(Team) ì—”í‹°í‹° */
@Entity
public class Team{
    @Id @GeneratedValue
    @Column(name = "TEAM_ID")
    private Long id;

    private String name;
    
	//Getter, Setter
}
```
=> Member : Team = N : 1 ì´ê¸° ë•Œë¬¸ì—Â **@ManyToOne**Â ì„ ì ìš©í•¨.
=> Member ê°ì²´ì˜ Team ë ˆí¼ëŸ°ìŠ¤ì™€Â Member í…Œì´ë¸”ì˜ FKì™€Â **mapping**ì„ í•´ì•¼í•¨ìœ¼ë¡œ, **@JoinColumn(name = "TEAM_ID")**Â ì¶”ê°€í•¨.


- íŒ€ì— íšŒì› ì €ì¥í•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
```java
Team team = new Team();
team.setName("TeamA");
entityManager.persist(team);

//íšŒì› ì €ì¥
Member member = new Member();
member.setName("member1");
member.setTeam(team);
entityManager.persist(member);

transaction.commit();
```


#### ğŸ“Œ (ì½”ë“œ) DBì—ì„œ ê°€ì ¸ì˜¤ëŠ” ì¿¼ë¦¬ë¥¼ ê°€ì ¸ì˜¤ê³  ì‹¶ë‹¤ë©´?
=> flushë¥¼ í†µí•´ DBì— ë¨¼ì € ë³´ë‚¸í›„ 1ì°¨ ìºì‰¬ì˜ ë‚´ìš©ì„ ì§€ìš°ê³  ì°¾ì•„ì™€ì•¼ í•œë‹¤.

```java
//íšŒì› ì €ì¥
Member member = new Member();
member.setName("member1");
member.setTeam(team);
entityManager.persist(member);

// Flush ë¨¼ì €í•˜ê¸°
entityManager.flush();
entityManager.clear();

// íšŒì›ì¡°íšŒ
Member findMember = entityManager.find(Member.class, member.getId());

// íŒ€ ì¡°íšŒ
Team findTeam = findMember.getTeam();
System.out.println("findTeam = " + findTeam.getName());
```

- ì¿¼ë¦¬ ìƒì„±
![[Pasted image 20230115221330.png]]


#### ğŸ“Œ (ì½”ë“œ) ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ ë§ºëŠ” ë²•ì€?
![[Pasted image 20230116144809.png]]
=>**DB ì—ì„œëŠ” FKë¥¼ ê°–ê³  ì–‘ìª½ ëª¨ë‘ì—ì„œ ì„œë¡œì—ê²Œ ì ‘ê·¼ì´ ê°€ëŠ¥**í•˜ë‹¤. ë”°ë¼ì„œ ê°ì²´ì—ì„œëŠ” ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ ìœ„í•´ Team ìª½ì—ë„ Member ì˜ Listì¸ membersë¼ëŠ” ì°¸ì¡°ê°’ì„ ê°–ê³ ìˆì–´ì•¼ í•œë‹¤.

- í´ë˜ìŠ¤ êµ¬ì„±
```java
@Entity
public class Team{
    ...
    @OneToMany(mappedBy = "team")
    private List<Member> members = new ArrayList<>();
    ...
}
```

- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
```csharp
// íšŒì›ì¡°íšŒ
Member findMember = entityManager.find(Member.class, member.getId());

// ë§´ë²„ ì¡°íšŒ
List<Member> members = findMember.getTeam().getMembers();
for (Member m : members) {
    System.out.println("member = " + m.getName());
}
```

- ìƒì„±ëœ SQL
![[Pasted image 20230116150239.png]]

#### ğŸ“Œ mappedByë€?
=> ê°ì²´ì™€ í…Œì´ë¸”ê°„ ì—°ê´€ê´€ê³„ë¥¼ ë§ºëŠ”Â **ì°¨ì´**ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ë°©ë²•. ì¦‰, ë‘˜ì¤‘ í•˜ë‚˜ë¥¼Â **ì£¼ì¸(Owner)ì„ ì •í•´ì•¼ í•œë‹¤**

**ê°ì²´**ë¥¼ ì–‘ë°©í–¥ìœ¼ë¡œ ì°¸ì¡°í•˜ë ¤ë©´ **ë‹¨ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ 2ê°œ** ë§Œë“¤ì–´ì•¼ í•œë‹¤.
```css
A â†’ B (a.getB())
B â†’ A (b.getA())
```

**í…Œì´ë¸”**ì—ì„œ ì–‘ë°©í–¥ìœ¼ë¡œ ì°¸ì¡°í• ê²½ìš°Â **ì™¸ë˜ í‚¤(FK) í•˜ë‚˜**ë¡œ ì—°ê´€ê´€ê³„ê°€ í˜•ì„±ëœë‹¤. 
```sql
SELECT * 
FROM MEMBER M
JOIN TEAM T ON M.TEAM_ID = T.TEAM_ID

SELECT * 
FROM TEAM T
JOIN MEMBER M ON T.TEAM_ID = M.TEAM_ID
```

![[Pasted image 20230116150346.png]]
=> **MEMBER Tableì˜ FKëŠ”**Â member ê°ì²´ì˜ teamê°’ì„ ì—…ë°ì´íŠ¸ í–ˆì„ë•Œ ìˆ˜ì •ì´ ë˜ì–´ì•¼í• ê¹Œ? ì™¸ë˜ í‚¤(FK)ê°€ ìˆëŠ”ê³³ì„ ì£¼ì¸ìœ¼ë¡œ ê²°ì •í•˜ì


#### ğŸ“Œ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì´ë€?
=> ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ë§Œì´ **ì™¸ë˜ í‚¤ë¥¼ ê´€ë¦¬(ë“±ë¡, ìˆ˜ì •)** í•˜ë©°, ì£¼ì¸ì´ ì•„ë‹Œìª½ì€ ì½ê¸°ë§Œ ê°€ëŠ¥í•˜ë‹¤.
=> ì£¼ì¸ì€ mappedBy ì†ì„±ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.Â ì£¼ì¸ì´ ì•„ë‹ˆë©´ mappedByì†ì„±ìœ¼ë¡œ ì£¼ì¸ì„ ì§€ì •í•œë‹¤.

#### ğŸ“Œ (ì½”ë“œ) ì—°ê´€ê´€ê³„ ì£¼ì¸ì— ê°’ì„ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´?
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
```java
// Member ìƒì„±
Member member = new Member();
member.setName("mamber1");
entityManager.persist(member);

// Team ìƒì„±
Team team = new Team();
team.setName("teamA");
team.getMembers().add(member); // ì—­ë°©í–¥(ì£¼ì¸ì´ ì•„ë‹Œ ë°©í–¥)ë§Œ ì—°ê´€ê´€ê³„ ì„¤ì •

entityManager.persist(team);

// 1ì°¨ ìºì‹œì™€ DB ë™ê¸°í™”
entityManager.flush();
entityManager.clear();

transaction.commit();
```

- ì‹¤í–‰ì¿¼ë¦¬
![[Pasted image 20230116205928.png]]

- DB ìƒíƒœ
![[Pasted image 20230116210002.png]]
=> ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ì—ì„œÂ ì£¼ì¸ì´ ì•„ë‹Œìª½ì€Â **ì½ê¸°ë§Œ**Â ê°€ëŠ¥í•˜ë‹¤. ì“°ê¸°ë¥¼ í•´ë„ ì¿¼ë¦¬ì— ë³€ê²½ì´ ì—†ë‹¤.

#### ğŸ“Œ (ì½”ë“œ) í•´ê²°ì±…ì€?
```java
eam team = new Team();
team.setName("teamA");
entityManager.persist(team);

Member member = new Member();
member.setName("mamber1");
member.setTeam(team); // ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ìª½ì—ì„œ ê°’ ì—…ë°ì´íŠ¸
entityManager.persist(member);

// team.getMembers().add(member); ë°˜ëŒ€ ë°©í–¥ì˜ ì¶”ê°€

entityManager.flush(); // 1ì°¨ ìºì‹œ DBì™€ ë™ê¸°í™”
entityManager.clear();

System.out.println("====================");
Team findTeam = entityManager.find(Team.class, team.getId());
System.out.println("====================");
List<Member> members = findTeam.getMembers();
for (Member m : members) {
    System.out.println("m = " + m.getName());
}
System.out.println("====================");

transaction.commit();
```
=> `member.setTeam(team)`ì™€ ê°™ì´ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ìª½ì—ì„œ ê°’ ì—…ë°ì´íŠ¸í•¨.

- SQL
![[Pasted image 20230116210154.png]]
=> ì²« selectëŠ” teamì„ DBì—ì„œ ì°¾ì•„ì˜¤ëŠ” ì¿¼ë¦¬ì´ê³ , ë‘ë²ˆì§¸ ëŠ” teamìœ¼ë¡œ ë¶€í„° membersë¥¼ ì–»ì–´ì˜¤ëŠ” ì¿¼ë¦¬ì´ë‹¤. memberë¥¼ ì‚¬ìš©í•˜ëŠ” ì‹œì ì— ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ì£¼ì—ˆë‹¤.

#### ğŸ“Œ(ì½”ë“œ) ê°ì²´ë¥¼ ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ í•˜ì§€ ì•Šì•˜ì„ë•Œ, ìƒê¸°ëŠ” ë¬¸ì œì ì€?
1) flush(), clear()ë¥¼ ìƒëµí•˜ëŠ” ê²½ìš°, ë™ê¸°í™”ë¬¸ì œ ë°œìƒ

- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
```java
Team team = new Team();
team.setName("teamA");
entityManager.persist(team);

Member member = new Member();
member.setName("mamber1");
member.setTeam(team); // ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ìª½ì—ì„œ ê°’ ì—…ë°ì´íŠ¸
entityManager.persist(member);

Team findTeam = entityManager.find(Team.class, team.getId());
List<Member> members = findTeam.getMembers();

System.out.println("====================");
for (Member m : members) {
    System.out.println("m = " + m.getName());
}
System.out.println("====================");

transaction.commit();
```
=> **flush(), clear()ë¥¼ ìƒëµ**í•œ ì½”ë“œì´ë‹¤. ì¦‰, **DBì™€ 1ì°¨ ìºì‹œì˜ ë™ê¸°í™” ê³¼ì •ì´ ë¹ ì ¸ìˆë‹¤.**
=> 1ì°¨ìºì‹œ ê³¼ì •ì€ persistì´ê³ , 1ì°¨ ìºì‹œì˜ ë™ê¸°í™” ê³¼ì •ì€ DBì— ë³€ê²½ë‚´ìš©ì„ ë°˜ì˜í•˜ëŠ” ê²ƒì´ë‹¤.

- ê²°ê³¼
![[Pasted image 20230117130324.png]]
=> ê°ì²´ë¶€ë¶„ì—ì„œ, Teamì—ì„œ Memberë¡œ ê°€ëŠ” ì—°ê´€ê´€ê³„ë¥¼ ì„¤ì •í•´ì£¼ì§€ ì•Šì•˜ë‹¤.

2) ê°ì²´ë¥¼ ë³€ê²½ ë˜ëŠ” ì‚­ì œí• ë•Œ ìƒê¸°ëŠ” ë¬¸ì œ
member1ì˜ íŒ€ì„ teamA ì—ì„œ Bë¡œ ë³€ê²½í•  ë•Œ teamA -> member1 ì— ëŒ€í•œ ê´€ê³„ê°€ ì œê±°ë˜ì§€ ì•ŠëŠ” ë¬¸ì œì  ë°œìƒ
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
```java
member1.setTeam(teamA);
member1.setTeam(teamB);
Member findMember = teamA.getMember();
```

- ê·¸ë¦¼
![[Pasted image 20230117131439.png]]



#### ğŸ“Œ (ì½”ë“œ) í•´ê²°ì±…ì€?
- í´ë˜ìŠ¤ êµ¬ì„± 
```java
class Member {
    // ìƒëµ...
    public void changeTeam(Team team) {
        if(this.team != null) {
            this.team.getMembers().remove(this);
        }
       
        this.team = team;
        team.getMembers().add(this);
    }

}
```
=> ê¸°ì¡´ íŒ€ì´ ìˆìœ¼ë©´ ê¸°ì¡´ íŒ€ê³¼ íšŒì›ì˜ ì—°ê´€ê´€ê³„ë¥¼ ì‚­ì œí•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•¨.
=>Â í•œë²ˆì˜ ë“±ë¡ìœ¼ë¡œ ì–‘ìª½ ëª¨ë‘ì— ë“±ë¡ë˜ë„ë¡ ë©”ì„œë“œ ì„¤ì •í•¨.


