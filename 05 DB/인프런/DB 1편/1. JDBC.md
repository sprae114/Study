ë§í¬ : [[[ì¸í”„ëŸ°]ìŠ¤í”„ë§DB 1í¸.pdf]]
í•´ì‹œíƒœí¬ : #H2, #JDBC

----
## H2 ì„¤ì •
#### ğŸ“Œ(ì½”ë“œ) Intelijì™€ ì—°ê²°í•˜ê¸°
- ì˜ì¡´ì„± ì¶”ê°€í•˜ê¸°(build.gradle)
```
dependencies {
	...
	runtimeOnly 'com.h2database:h2'
	...
}
```


#### ğŸ“Œ(ì½”ë“œ) H2 ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ ì‹¤í–‰
- íŒŒì¼ ìƒì„± ë°©ë²•
jdbc:h2:~/test (ìµœì´ˆ í•œë²ˆ) ì´í›„ë¶€í„°ëŠ” jdbc:h2:tcp://localhost/~/test ì´ë ‡ê²Œ ì ‘ì†


#### ğŸ“Œ(ì½”ë“œ) í…Œì´ë¸” ìƒì„±í•˜ê¸°
``` SQL
drop table member if exists cascade;

create table member (
	 member_id varchar(10),
	 money integer not null default 0,
	 primary key (member_id)
);

insert into member(member_id, money) values ('hi1',10000);
insert into member(member_id, money) values ('hi2',20000);
```


## JDBC ì´í•´
#### ğŸ“Œë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì“°ëŠ” ì´ìœ ëŠ”?  
- ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°œë°œí•  ë•Œ ì¤‘ìš”í•œ **ë°ì´í„°ëŠ” ëŒ€ë¶€ë¶„ ë°ì´í„°ë² ì´ìŠ¤ì— ë³´ê´€**í•¨. ìë°”ì½”ë“œì— ë³´ê´€í•˜ë©´, ìë°”ê°€ ì¢…ë£Œë˜ë©´ ë°ì´í„°ê°€ ë‚ ë¼ê°.

#### âœ” ì„œë²„ì™€ DB ì—°ê²° ë§¤ì»¤ë‹ˆì¦˜ì€?
- ë™ì‘ ê³¼ì • ê·¸ë¦¼ìœ¼ë¡œ ì´í•´
![[Pasted image 20221130152811.png]]
- ë§¤ì»¤ë‹ˆì¦˜  
    - 1. **ì»¤ë„¥ì…˜ ì—°ê²°**: ì£¼ë¡œ TCP/IPë¥¼ ì‚¬ìš©í•´ì„œ ì»¤ë„¥ì…˜ì„ ì—°ê²°í•œë‹¤.  
    - 2. **SQL ì „ë‹¬**: ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ëŠ” DBê°€ ì´í•´í•  ìˆ˜ ìˆëŠ” SQLì„ ì—°ê²°ëœ ì»¤ë„¥ì…˜ì„ í†µí•´ DBì— ì „ë‹¬í•œë‹¤.  
    - 3. **ê²°ê³¼ ì‘ë‹µ**: DBëŠ” ì „ë‹¬ëœ SQLì„ ìˆ˜í–‰í•˜ê³  ê·¸ ê²°ê³¼ë¥¼ ì‘ë‹µí•œë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ëŠ” ì‘ë‹µ ê²°ê³¼ë¥¼ í™œìš©í•œë‹¤.


#### ğŸ“ŒJDBC ì—­í• ì€?
- ë°ì´í„°ë² ì´ìŠ¤ì™€ ìë°”ë¥¼ **ì—°ê²°í•˜ëŠ” ë§¤ê°œì²´**ê°€ JDBC API.


#### ğŸ“ŒJDBCì˜ 2ê°€ì§€ ë¬¸ì œì 
- 1) ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ë°ì´í„°ë² ì´ìŠ¤ë¡œ **ë³€ê²½í•˜ë©´** ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ì— ê°œë°œëœ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì½”ë“œë„ í•¨ê»˜ ë³€ê²½í•´ì•¼ í•œë‹¤.  
- 2) ê°ê°ì˜ ë°ì´í„°ë² ì´ìŠ¤ë§ˆë‹¤ ì»¤ë„¥ì…˜ ì—°ê²°, SQL ì „ë‹¬, ê·¸ë¦¬ê³  ê·¸ ê²°ê³¼ë¥¼ ì‘ë‹µ ë°›ëŠ” ë°©ë²•ì„ ìƒˆë¡œ í•™ìŠµí•´ì•¼ í•œë‹¤.  ì¦‰, ë°ì´í„° ë² ì´ìŠ¤ë§ˆë‹¤ **í†µí•© X**


#### ğŸ“ŒJDBC í‘œì¤€ ì¸í„°í˜ì´ìŠ¤ì˜ í•´ê²°ë°©ë²•ì€?  
- ì²«ë²ˆì§¸ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´, ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì€ ì´ì œ **JDBC í‘œì¤€ ì¸í„°í˜ì´ìŠ¤**ì—ë§Œ ì˜ì¡´í•œë‹¤.  ë”°ë¼ì„œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ë³€ê²½í•˜ê³  ì‹¶ìœ¼ë©´ JDBC êµ¬í˜„ ë¼ì´ë¸ŒëŸ¬ë¦¬ë§Œ ë³€ê²½í•˜ë©´ ëœë‹¤.
- ë‘ë²ˆì§¸ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´, JDBC **í‘œì¤€ ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©ë²•**ë§Œ í•™ìŠµí•˜ë©´ ëœë‹¤.  í•œë²ˆ ë°°ì›Œë‘ë©´ ìˆ˜ì‹­ê°œì˜ ë°ì´í„°ë² ì´ìŠ¤ì— ëª¨ë‘ ë™ì¼í•˜ê²Œ ì ìš©í•  ìˆ˜ ìˆë‹¤.


#### ğŸ“ŒJDBC í‘œì¤€ ì¸í„°í˜ì´ìŠ¤ ë™ì‘ ë°©ë²•ì€?
- ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
![[Pasted image 20221130152951.png]]
- ê¸°ì¡´ ë°©ì‹ê³¼ ì—°ê²°í•˜ëŠ” ë°©ë²•ì€ ë™ì¼í•¨.
![[Pasted image 20221130153011.png]]


## JDBCì™€ ìµœì‹  ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ 
#### ğŸ“Œìµœì‹  ê¸°ìˆ ì„ ì™œ ì¨ì•¼í• ê¹Œ?  
- ì‘ì„±í•´ì•¼ë  ì½”ë“œê°€ ë„ˆë¬´ ë§ê³  ë°˜ë³µì ì´ë¼ì„œ ì‚¬ìš©í•˜ê¸°ì— **ë³µì¡í•¨**
- JDBC ì‚¬ìš©í•˜ëŠ” ê²½ìš° ë¡œì§
    ![[Pasted image 20221130153045.png]]


#### ğŸ“ŒSQL Mapper
- ë¡œì§ì€? ê°ì²´ì™€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì˜ ë°ì´í„°ë¥¼ **ê°œë°œìê°€ ì‘ì„±í•œ SQLë¡œ ë§¤í•‘ì‹œì¼œì£¼ëŠ” í”„ë ˆì„ì›Œí¬**
![[Pasted image 20221130153129.png]]
- ì¥ì   
    - SQL ì‘ë‹µ ê²°ê³¼ë¥¼ **ê°ì²´ë¡œ í¸ë¦¬í•˜ê²Œ ë³€í™˜**í•´ì¤€ë‹¤.  
    - JDBCì˜ **ë°˜ë³µ ì½”ë“œë¥¼ ì œê±°**í•´ì¤€ë‹¤.  
-   ë‹¨ì   
    - ê°œë°œìê°€ **SQLì„ ì§ì ‘ ì‘ì„±**í•´ì•¼í•œë‹¤.


#### ğŸ“ŒORM ê¸°ìˆ   
- ë¡œì§ì€? ê°ì²´ì™€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì˜ ë°ì´í„°ë¥¼ **ìë™ìœ¼ë¡œ ë§¤í•‘**ì‹œì¼œì£¼ëŠ” í”„ë ˆì„ì›Œí¬
![[Pasted image 20221130153226.png]]
- ì¥ì   
    - ì¬ì‚¬ìš© **ìœ ì§€ ë³´ìˆ˜ í¸ë¦¬ì„±ì´ ì¦ê°€**í•œë‹¤.  
    - ê°ì²´ ì§€í–¥ì ì¸ ì½”ë“œë¡œ **ì§ê´€ì ì¸ ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§**ì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.  
- ë‹¨ì   
	- ì´ˆê¸° ì ìš©ì— ëŸ¬ë‹ ì»¤ë¸Œê°€ ì–´ëŠ ì •ë„ ìˆë‹¤.  
	- **ë³µì¡í•œ SQL**ì˜ ì‚¬ìš©í•˜ì§€ ëª»í•  ìˆ˜ ë„ ìˆë‹¤.


#### ğŸ“Œ(ì½”ë“œ) H2 ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
1) ì ‘ì† ê¸°ë³¸ì •ë³´ ê¸°ì…
ì ‘ì†í•˜ëŠ”ë° í•„ìš”í•œ ê¸°ë³¸ ì •ë³´ë¥¼ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ìƒìˆ˜ë§Œë“¤ê¸°.
```java
public abstract class ConnectionConst {  
    public static final String URL = "jdbc:h2:tcp://localhost/~/test";  
    public static final String USERNAME = "sa";  
    public static final String PASSWORD = "";  
}
```


2) ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²° ì½”ë“œ
JDBCë¥¼ ì‚¬ìš©í•´ì„œ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ëŠ” ì½”ë“œ ë§Œë“¤ê¸°. 
H2 ë°ì´í„°ë² ì´ìŠ¤ ë“œë¼ì´ë²„ê°€ ì‘ë™í•´ì„œ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ì»¤ë„¥ì…˜ì„ ë§ºê³  ê·¸ ê²°ê³¼ë¥¼ ë°˜í™˜í•´ì¤€ë‹¤. (ìë™ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì°¾ìŒ)
```java
@Slf4j  
public class DBConnectionUtil {  
    public static Connection getConnection() {  
        try {  
            Connection connection = DriverManager.getConnection(URL, USERNAME, PASSWORD);  
            log.info("get connection={}, class={}", connection, connection.getClass());  
            return connection;  
        } catch (SQLException e) {  
            throw new IllegalStateException(e);  
        }  
    }  
}
```


#### ğŸ“ŒJDBC DriverManager ì—°ê²° ì´í•´
![[Pasted image 20221130160330.png]]
- ë§¤ì»¤ë‹ˆì¦˜
	- 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì—ì„œ **ì»¤ë„¥ì…˜ì„ ìš”ì²­**í•˜ë©´ DriverManager. getConnection() ì„ í˜¸ì¶œ  why? í•´ë‹¹ ë°ì´í„° ë² ì´ìŠ¤ ì—°ê²°í•˜ê¸° ìœ„í•¨
	- 2. DriverManager ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ë“±ë¡ëœ ë“œë¼ì´ë²„ **ëª©ë¡ì„ ìë™ìœ¼ë¡œ ì¸ì‹**í•œë‹¤. ì´ ë“œë¼ì´ë²„ë“¤ì—ê²Œ ìˆœì„œëŒ€ë¡œ ë‹¤ìŒ ì •ë³´(URL, ID, PASSWORD)ë¥¼ ë„˜ê²¨ì„œ **ì»¤ë„¥ì…˜ì„ íšë“í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸**.  
	- 3. êµ¬í˜„ì²´ê°€ í´ë¼ì´ì–¸íŠ¸ì— **ì°¾ì€ ì»¤ë„¥ì…˜ ë°˜í™˜**.


## JDBC ê°œë°œ
#### ğŸ“Œ(ì½”ë“œ) ë¡œì§ ë§Œë“¤ê¸°ì „ì— ì‘ì„±í•  ê²ƒë“¤
- SQL
í…Œì´ë¸”ê³¼ ìƒ˜í”Œ ë°ì´í„° ë§Œë“¤ê¸°ë¥¼ í†µí•´ì„œ member í…Œì´ë¸”ì„ ë¯¸ë¦¬ ë§Œë“¤ì–´ë‘ì–´ì•¼ í•œë‹¤.
```sql
drop table member if exists cascade;
create table member (
	 member_id varchar(10),
	 money integer not null default 0,
	 primary key (member_id)
);
```

- Member : íšŒì› ê°ì²´ ë§Œë“¤ê¸°
```java
@Data  
public class Member {  
  
    private String memberId;  
    private int money;  
  
    public Member() {  
    }  
  
    public Member(String memberId, int money) {  
        this.memberId = memberId;  
        this.money = money;  
    }  
}
```


#### ğŸ“Œ(ì½”ë“œ) ë“±ë¡ ë¡œì§ 
- MemberRepositoryV0 : íšŒì› ê°ì²´ë¥¼ ë°ì´í„° ë² ì´ìŠ¤ì— ë“±ë¡. (ì´í•´ë§Œ)
```java
public Member save(Member member) throws SQLException {  
    String sql = "insert into member(member_id, money) values (?, ?)";  
  
    Connection con = null;  
    PreparedStatement pstmt = null;  
  
    try {  
        con = getConnection();  
        pstmt = con.prepareStatement(sql);  
        pstmt.setString(1, member.getMemberId());  
        pstmt.setInt(2, member.getMoney());  
        pstmt.executeUpdate();  
        return member;  
  
    } catch (SQLException e) {  
        log.error("db error", e);  
        throw e;  
  
    } finally {  
        close(con, pstmt, null);  
    }  
  
}

private void close(Connection con, Statement stmt, ResultSet rs) {  
  
    if (rs != null) {  
        try {  
            rs.close();  
        } catch (SQLException e) {  
            log.info("error", e);  
        }  
    }  
  
    if (stmt != null) {  
        try {  
            stmt.close();  
        } catch (SQLException e) {  
            log.info("error", e);  
        }  
    }  
  
    if (con != null) {  
        try {  
            con.close();  
        } catch (SQLException e) {  
            log.info("error", e);  
        }  
    }  
}
```

#### ğŸ“Œë“±ë¡ ë§¤ì»¤ë‹ˆì¦˜ ì„¤ëª…  
1) ì „ë‹¬í•  **SQL ì •ì˜**í•¨  
2) 2ê°€ì§€ ì¤€ë¹„í•˜ê¸°  
	- ë°ì´í„°ë² ì´ìŠ¤ì— **ì»¤ë„¥ì…˜ ì¤€ë¹„**. (Connetion)ê³¼ ì „ë‹¬í•  SQL  
	- **PreparedStatement** -> (1) DBì— ì „ë‹¬í•  SQLê³¼ (2)íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•  ë°ì´í„°ë“¤ì„ ì¤€ë¹„í•¨.  
3) ì»¤ë„¥ì…˜ ì—°ê²°ì€ con, íŒŒë¼ë¯¸í„° ì „ë‹¬ì€ pstmtë¥¼ í†µí•´ **ë°”ì¸ë”©**í•¨.  
	- ë°”ì¸ë”©ì´ë€ ì˜¤ë¸Œì íŠ¸ì˜ í”„ë¡œí¼í‹°(ë©”ì„œë“œ set)ì— ê°’ì„ ë„£ëŠ” ê²ƒì„ ë§í•œë‹¤.  
4) SQLì„ ì»¤ë„¥ì…˜ì„ í†µí•´ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— **ì „ë‹¬**í•œë‹¤.  
5) **ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì—­ìˆœ**ìœ¼ë¡œ í•˜ê¸°


#### ğŸ“Œ(ì½”ë“œ) ì¡°íšŒ ë¡œì§
- MemberRepositoryV0 : íšŒì› ê°ì²´ë¥¼ ë°ì´í„° ë² ì´ìŠ¤ì— ì¡°íšŒ. (ì´í•´ë§Œ)
```java
public Member findById(String memberId) throws SQLException {  
    String sql = "select * from member where member_id = ?";  
  
    Connection con = null;  
    PreparedStatement pstmt = null;  
    ResultSet rs = null;  
  
    try {  
        con = getConnection();  
        pstmt = con.prepareStatement(sql);  
        pstmt.setString(1, memberId);   //ì°¾ì„ memberIdë¥¼ pstmtì— ì €ì¥  

		//ì¡°íšŒí• ë•Œ ì‚¬ìš©í•˜ëŠ” ëª…ë ¹ë¬¸ìœ¼ë¡œ ê²°ê³¼ë¥¼ ë°˜í™˜í•¨.  
        rs = pstmt.executeQuery();  
        if (rs.next()) {        //nextê°€ ì•Œì•„ì„œ ë£¨í”„ë¥¼ ëŒë ¤ì£¼ëŠ” êµ°. +  
            Member member = new Member();  
            member.setMemberId(rs.getString("member_id"));  
            member.setMoney(rs.getInt("money"));  
            return member;  
        } else {  
            throw new NoSuchElementException("member not found memberId=" + memberId);  
        }  
    } catch (SQLException e) {  
        log.error("db error", e);  
        throw e;  
    } finally {  
        close(con, pstmt, rs);  
    }  
}
```


#### ğŸ“Œì¡°íšŒ ë§¤ì»¤ë‹ˆì¦˜ ì„¤ëª…  
1) ì „ë‹¬í•  **SQL ì •ì˜**í•¨. 
2) 3ê°€ì§€ ì¤€ë¹„í•˜ê¸°  
	- ë°ì´í„°ë² ì´ìŠ¤ì— **ì»¤ë„¥ì…˜** ì¤€ë¹„. (Connetion)  
	- **PreparedStatement** -> (1) DBì— ì „ë‹¬í•  SQLê³¼ (2)íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•  ë°ì´í„°ë“¤ì„ ì¤€ë¹„í•¨. ì„œë²„ì—ì„œ DBë¡œ ë„£ëŠ” input  
	- **ResultSet** -> select ì¿¼ë¦¬ì˜ ê²°ê³¼ê°€ ìˆœì„œëŒ€ë¡œ ë“¤ì–´ê°„ë‹¤ .  DBì—ì„œ ì„œë²„ë¡œ ë‚˜ì˜¤ëŠ” output.
	- ì˜ˆì‹œ) select member_id, money ë¼ê³  ì§€ì •í•˜ë©´ member_id , money ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë°ì´í„°ê°€ ì €ì¥í•¨.  
3) ì»¤ë„¥ì…˜ì„ í†µí•´ **SQL ì „ë‹¬**
4) **rs. next** -> if/whileì„ í†µí•´ ì»¤ì„œ ì´ë™.
5) ë¹ˆì¹¸ì´ë©´, ìƒˆë¡œìš´ **íšŒì› ê°ì²´ë§Œë“¤ê³ **, ìƒíƒœê°’ ë„£ê¸° í›„ ë¦¬í„´  
6) **ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì—­ìˆœ**ìœ¼ë¡œ í•˜ê¸°


#### ğŸ“ŒExecuteQuery, ExecuteUpdate ì°¨ì´ì 
 - ExecuteQuery -> ìˆ˜í–‰ê²°ê³¼ë¡œ **ResultSet ê°ì²´ì˜ ê°’**ì„ ë°˜í™˜  
 - ExecuteUpdate -> ìˆ˜í–‰ê²°ê³¼ë¡œ **Int íƒ€ì…ì˜ ê°’**ì„ ë°˜í™˜  
ì¶œì²˜ : [[JAVA] Execute, ExecuteQuery, ExecuteUpdate ì°¨ì´ì  ì•Œì•„ë³´ê¸° ](https://mozi.tistory.com/26)


#### ğŸ“Œrs .nextëŠ” ì™œ ìˆì§€?  
- rsëŠ” í˜„ì¬ **ì»¤ì„œì˜ ìœ„ì¹˜**ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤ê³  ìƒê°í•˜ë©´ ëŒ.  
- rs. nextë¥¼ í†µí•´ì„œ ì»¤ì„œê°€ ì´ë™í•¨(ifëŠ” ë‹¨ì¼, while ë³µìˆ˜ ì¼ë•Œ)
- ë°ì´í„°ë² ì´ìŠ¤ ì°¾ëŠ” íë¦„  
![[Pasted image 20221130163139.png]]


#### ğŸ“Œ(ì½”ë“œ) ìˆ˜ì •/ì‚­ì œ ë¡œì§
- ìˆ˜ì • ë¡œì§
```java
public void update(String memberId, int money) throws SQLException {  
    String sql = "update member set money=? where member_id=?";  
  
    Connection con = null;  
    PreparedStatement pstmt = null;  
  
    try {  
        con = getConnection();  
        pstmt = con.prepareStatement(sql);  
        pstmt.setInt(1, money);  
        pstmt.setString(2, memberId);  
        int resultSize = pstmt.executeUpdate();  
        log.info("resultSize={}", resultSize);  
    } catch (SQLException e) {  
        log.error("db error", e);  
        throw e;  
    } finally {  
        close(con, pstmt, null);  
    }  
  
}
```

- ì‚­ì œ ë¡œì§
```java
public void delete(String memberId) throws SQLException {  
    String sql = "delete from member where member_id=?";  
  
    Connection con = null;  
    PreparedStatement pstmt = null;  
  
    try {  
        con = getConnection();  
        pstmt = con.prepareStatement(sql);  
        pstmt.setString(1, memberId);  
        pstmt.executeUpdate();  
    } catch (SQLException e) {  
        log.error("db error", e);  
        throw e;  
    } finally {  
        close(con, pstmt, null);  
    }  
  
}
```
