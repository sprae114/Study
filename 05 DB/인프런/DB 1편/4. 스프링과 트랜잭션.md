ë§í¬ : [[[ì¸í”„ëŸ°]ìŠ¤í”„ë§DB 1í¸.pdf]]
í•´ì‹œíƒœí¬ : #íŠ¸ëœì­ì…˜

----

## ê°œë…ì¡ê¸°
#### ğŸ“Œì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¡°ëŠ”?
-   ê·¸ë¦¼
![[Pasted image 20221230165212.png]]

1) **í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µ**  
	-   UIì™€ ê´€ë ¨ëœ ì²˜ë¦¬ ë‹´ë‹¹  
	-   ì›¹ ìš”ì²­ê³¼ ì‘ë‹µ  
	-   ì‚¬ìš©ì ìš”ì²­ì„ ê²€ì¦  
	-   ì£¼ ì‚¬ìš© ê¸°ìˆ : ì„œë¸”ë¦¿ê³¼ HTTP ê°™ì€ ì›¹ ê¸°ìˆ , ìŠ¤í”„ë§ MVC  

2) **ì„œë¹„ìŠ¤ ê³„ì¸µ**  
	-   ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹  
	-   ì£¼ ì‚¬ìš© ê¸°ìˆ : ê°€ê¸‰ì  íŠ¹ì • ê¸°ìˆ ì— ì˜ì¡´í•˜ì§€ ì•Šê³ , ìˆœìˆ˜ ìë°” ì½”ë“œë¡œ ì‘ì„±  

3) **ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ**  
	-   ê³„ì¸µì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•˜ëŠ” ì½”ë“œ  
	-   ì£¼ ì‚¬ìš© ê¸°ìˆ : JDBC, JPA, File, Redis, Mongo ...


#### ğŸ“Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ 3ê°€ì§€ ë¬¸ì œì ì€?
-   **íŠ¸ëœì­ì…˜ ë¬¸ì œ**  
    -   1) JDBC êµ¬í˜„ ê¸°ìˆ ì´ **ì„œë¹„ìŠ¤ ê³„ì¸µì— ëˆ„ìˆ˜**ë˜ëŠ” ë¬¸ì œ  
        -   ì„œë¹„ìŠ¤ ê³„ì¸µì€ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì† X  why? íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ë˜ë©´ ìœ ì§€ë³´ìˆ˜í•˜ê¸° í˜ë“¦
    -   2) **íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë¬¸ì œ**  
        -   ê°™ì€ íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì•¼ í•œë‹¤. ê·¸ë˜ì„œ ë˜‘ê°™ì€ ê¸°ëŠ¥ë„ íŠ¸ëœì­ì…˜ìš© ê¸°ëŠ¥ê³¼ íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ”ê¸°ëŠ¥ìœ¼ë¡œ ë¶„ë¦¬í–ˆìŒ.  
    -   3) **íŠ¸ëœì­ì…˜ ì ìš© ë°˜ë³µ ë¬¸ì œ**  
        -   try, catch, finally...  
-   **ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ**  
    -   SQLException ì€ JDBC ì „ìš© ê¸°ìˆ ì´ì§€ë§Œ, **ì„œë¹„ìŠ¤ ê³„ì¸µìœ¼ë¡œ ì „íŒŒ**ëœë‹¤.  
-   **JDBC ë°˜ë³µ ë¬¸ì œ**  
    -   try , catch , finally ...



#### ğŸ“Œ ìš©ì–´ì •ë¦¬  
-   ëˆ„ìˆ˜ë˜ì–´ ìˆë‹¤  = ì„ì—¬ìˆë‹¤ê³  ìƒê°í•˜ì  
-   JDBC ê¸°ìˆ ì— ì˜ì¡´í•˜ëŠ” ê²ƒë“¤  =  javax.sql ~ ë¡œ êµ¬ì„±ë˜ì–´ ìˆëŠ” ê²ƒë“¤  
		-   javax.sql.DataSource  
		-   java.sql.Connection  
		-   java.sql.SQLException  
-   ë™ê¸°í™”  = ì¼ì¹˜í™”í•˜ëŠ” ê²ƒ


#### ğŸ“Œ íŠ¸ëœì­ì…˜ ì¶”ìƒí™”ë€?
=> ë‹¤ë¥¸ ë°ì´í„° **ì ‘ê·¼ ê¸°ìˆ ë¡œ ë³€ê²½**í•˜ë©´, ì„œë¹„ìŠ¤ ê³„ì¸µì˜ íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œë„ ëª¨ë‘ í•¨ê»˜ ìˆ˜ì •í•´ì•¼ í•œë‹¤. íŠ¸ëœì­ì…˜ ê¸°ìˆ ì˜ ê³µí†µì ì„ ë‹´ì€ íŠ¸ëœì­ì…˜ ì¶”ìƒí™” ê¸°ìˆ ì„ ì œê³µí•˜ì—¬ í•´ê²°í•¨.

#### âœ”  íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë€?
=>PlatformTransactionManager ì¸í„°í˜ì´ìŠ¤ì™€ êµ¬í˜„ì²´ë¥¼ í¬í•¨í•´ì„œ **íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €**ë¼ê³  í•¨.

- ì¶”ìƒí™” ì´ì „
![[Pasted image 20221230165851.png]]

- ì¶”ìƒí™” ì´í›„
![[Pasted image 20221230165730.png]]

- PlatformTransactionManager ì¸í„°í˜ì´ìŠ¤ ì½”ë“œ
``` java
package org.springframework.transaction;  
public interface PlatformTransactionManager extends TransactionManager {  
    TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException;  
    void commit(TransactionStatus status) throws TransactionException;   
	void rollback(TransactionStatus status) throws TransactionException;  
}
```
- getTransaction() : íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤
- commit() : íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•œë‹¤.
- rollback() : íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±í•œë‹¤.

## íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €
ì¶œì²˜ : [[ë°ì´í„°ë² ì´ìŠ¤] ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ì˜ í•µì‹¬ ê¸°ìˆ ](https://steady-coding.tistory.com/570)

#### âœ”  íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ë€?
=> Â íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê¸° ìœ„í•œ **Connection ê°ì²´ë¥¼ íŠ¹ë³„í•œ ì €ì¥ì†Œì— ë³´ê´€**í•´ ë‘ê³  í•„ìš”í•  ë•Œ êº¼ë‚´ ì“¸ ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê¸°ìˆ ì´ë‹¤.


#### âœ” íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì˜ ì—­í• ì€?
- íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì € ì‚¬ìš©ì´ì „
![[Pasted image 20221230173026.png]]
- ê°™ì€ ì»¤ë„¥ì…˜ì„ ë™ê¸°í™”(ë§ì¶”ì–´ ì‚¬ìš©)í•˜ê¸° ìœ„í•´ì„œ ì´ì „ì—ëŠ” **íŒŒë¼ë¯¸í„°ë¡œ ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•˜ëŠ” ë°©ë²•**ì„ ì‚¬ìš©í•¨.
- ì½”ë“œê°€ **ì§€ì €ë¶„í•´ì§€ëŠ” ê²ƒ**, ì»¤ë„¥ì…˜ì„ ë„˜ê¸°ëŠ” ë©”ì„œë“œì™€ ë„˜ê¸°ì§€ ì•ŠëŠ” ë©”ì„œë“œë¥¼ **ì¤‘ë³µ**í•´ì„œ ë§Œë“¤ì–´ì•¼ í•˜ëŠ” ë“±.. ë‹¨ì ë“¤ì´ ë§ë‹¤.


- íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì € ì‚¬ìš©ì´í›„
![[Pasted image 20221230174249.png]]
- ì“°ë ˆë“œ ë¡œì»¬ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— **ë©€í‹°ì“°ë ˆë“œ ìƒí™©ì— ì•ˆì „**í•˜ê²Œ ì»¤ë„¥ì…˜ì„ ë™ê¸°í™” í•  ìˆ˜ ìˆë‹¤. 
- ì»¤ë„¥ì…˜ì´ í•„ìš”í•˜ë©´ íŠ¸ëœì­ì…˜ **ë™ê¸°í™” ë§¤ë‹ˆì €ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ì„ íšë“**í•˜ë©´ ëœë‹¤. ë”°ë¼ì„œ ì´ì „ì²˜ëŸ¼ íŒŒë¼ë¯¸í„°ë¡œ ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.


#### âœ” íŠ¸ëœì­ì…˜ ë©”ì»¤ë‹ˆì¦˜ì€?
- í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ìœ¼ë¡œ ì„œë¹„ìŠ¤ ë¡œì§ì„ ì‹¤í–‰ì „
![[Pasted image 20221230174233.png]]
1. **ì„œë¹„ìŠ¤ ê³„ì¸µ**ì—ì„œ transactionManager.getTransaction() ì„ í˜¸ì¶œí•´ì„œ **íŠ¸ëœì­ì…˜ì„ ì‹œì‘**í•œë‹¤. 
2. íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ë ¤ë©´ ë¨¼ì € ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì´ í•„ìš”í•˜ë‹¤. íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” ë‚´ë¶€ì—ì„œ **ë°ì´í„°ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•´ì„œ ì»¤ë„¥ì…˜ì„ ìƒì„±**í•œë‹¤.  
3. ì»¤ë„¥ì…˜ì„ ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œë¡œ ë³€ê²½í•´ì„œ ì‹¤ì œ **ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ì„ ì‹œì‘**í•œë‹¤.  
4. íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì— **ì»¤ë„¥ì…˜ì„ ë³´ê´€**í•œë‹¤.  
5. íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ëŠ” **ì“°ë ˆë“œ ë¡œì»¬ì— ì»¤ë„¥ì…˜ì„ ë³´ê´€**í•œë‹¤. ë”°ë¼ì„œ ë©€í‹° ì“°ë ˆë“œ í™˜ê²½ì— ì•ˆì „í•˜ê²Œ ì»¤ë„¥ì…˜ì„ ë³´ê´€í•  ìˆ˜ ìˆë‹¤.

 - ë¡œì§ ì‹¤í–‰
![[Pasted image 20221230174307.png]]
 6. ì„œë¹„ìŠ¤ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•˜ë©´ì„œ **ë¦¬í¬ì§€í† ë¦¬ì˜ ë©”ì„œë“œë“¤ì„ í˜¸ì¶œ**í•œë‹¤. ì´ë•Œ ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•˜ì§€ ì•ŠëŠ”ë‹¤.  
 7. ë¦¬í¬ì§€í† ë¦¬ ë©”ì„œë“œë“¤ì€ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ëœ ì»¤ë„¥ì…˜ì´ í•„ìš”í•˜ë‹¤. ë¦¬í¬ì§€í† ë¦¬ëŠ” DataSourceUtils.getConnection() ì„ ì‚¬ìš©í•´ì„œ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì— **ë³´ê´€ëœ ì»¤ë„¥ì…˜ì„ êº¼ë‚´ì„œ ì‚¬ìš©**í•œë‹¤. ì´ ê³¼ì •ì„ í†µí•´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ê°™ì€ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•˜ê³ , íŠ¸ëœì­ì…˜ë„ ìœ ì§€ëœë‹¤.  
8. íšë“í•œ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•´ì„œ **SQLì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì „ë‹¬í•´ì„œ ì‹¤í–‰**í•œë‹¤.


- íŠ¸ëœì­ì…˜ ì¢…ë£Œ
![[Pasted image 20221230174400.png]]
-   9. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ëë‚˜ê³  **íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œ**í•œë‹¤. íŠ¸ëœì­ì…˜ì€ ì»¤ë°‹í•˜ê±°ë‚˜ ë¡¤ë°±í•˜ë©´ ì¢…ë£Œëœë‹¤.  
-   10. íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•˜ë ¤ë©´ ë™ê¸°í™”ëœ ì»¤ë„¥ì…˜ì´ í•„ìš”í•˜ë‹¤. íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ë¥¼ í†µí•´ **ë™ê¸°í™”ëœ ì»¤ë„¥ì…˜ì„ íšë“**í•œë‹¤. 
-   11. íšë“í•œ ì»¤ë„¥ì…˜ì„ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ì— **íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ê±°ë‚˜ ë¡¤ë°±**í•œë‹¤.  
-   12. ì „ì²´ **ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬**í•œë‹¤.  
    -   íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ë¥¼ ì •ë¦¬í•œë‹¤.  
    -   ì“°ë ˆë“œ ë¡œì»¬ì€ ì‚¬ìš©í›„ ê¼­ ì •ë¦¬í•´ì•¼ í•œë‹¤. con.setAutoCommit(true) ë¡œ ë˜ëŒë¦°ë‹¤. ì»¤ë„¥ì…˜ í’€ì„ ê³ ë ¤í•´ì•¼ í•œë‹¤.  
    -   con.close() ë¥¼ í˜¸ì¶œí•´ì…” ì»¤ë„¥ì…˜ì„ ì¢…ë£Œí•œë‹¤. ì»¤ë„¥ì…˜ í’€ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° con.close() ë¥¼ í˜¸ì¶œí•˜ë©´ ì»¤ë„¥ì…˜ í’€ì— ë°˜í™˜ëœë‹¤.



#### ğŸ“Œ (ì½”ë“œ) íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì € ì˜ˆì‹œ
- ê°„ë‹¨íˆ ì´í•´ë§Œ
```java
public class AccountService {  
  
    public void accountTransfer(String sender, String receiver, int money) throws SQLException{  
        // íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì‘ì—… ì´ˆê¸°í™”  
        TransactionSynchronizationManager.initSynchronization();  
  
        // Connection ì˜¤ë¸Œì íŠ¸ ìƒì„±, ì €ì¥ì†Œ ë°”ì¸ë”©, ì°¸ì¡°ë³€ìˆ˜ ê°’ ë¦¬í„´  
        Connection conn = DataSourceUtils.getConnection(dataSource);  
  
        // íŠ¸ëœì­ì…˜ ì‹œì‘  
        conn.setAutoCommit(false);  
  
        try {  
            accountDAO.minus(sender, money);  
            accountDAO.plus(receiver, money);  
            conn.commit();  
        } catch (SQLException e) {  
            conn.rollback();  
        } finally {  
            DataSourceUtils.releaseConnection(conn, dataSource); // ì»¤ë„¥ì…˜ì„ ë‹«ìŒ  
            // ë™ê¸°í™” ì‘ì—…ì„ ì¢…ë£Œí•˜ê³  ì €ì¥ì†Œë¥¼ ë¹„ìš´ë‹¤  
            TransactionSynchronizationManager.unbindResource(this.dataSource);  
            TransactionSynchronizationManager.clearSynchronization();  
        }  
    } else {  
        throw new NoMoneyException();  
    }  
}
```

## íŠ¸ëœì­ì…˜ í…œí”Œë¦¿
#### ğŸ“Œ íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ì´ë€?
ì¶œì²˜ : [Transaction Template (tistory.com)](https://kchanguk.tistory.com/74)
=> Â Transactionì˜ ì‹œì‘ ë° ì¢…ë£Œ ì‹œì ì„ ëª…ì‹œì ìœ¼ë¡œ ê²°ì •í•  ìˆ˜ ìˆë„ë¡ Springì—ì„œ ì œê³µí•˜ëŠ” ë°©ë²•

#### ğŸ“Œ íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ”?
=> íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ë ¤ë©´ try , catch , finally ë¥¼ í¬í•¨í•œ ì„±ê³µì‹œ ì»¤ë°‹, ì‹¤íŒ¨ì‹œ ë¡¤ë°± ì½”ë“œê°€ ë°˜ë³µë  ê²ƒì´ë‹¤. ì´ëŸ´ ë•Œ í…œí”Œë¦¿ ì½œë°± íŒ¨í„´ì„ í™œìš©í•˜ë©´ ì´ëŸ° ë°˜ë³µ ë¬¸ì œë¥¼ ê¹”ë”í•˜ê²Œ í•´ê²°í•¨.


#### ğŸ“Œ (ì½”ë“œ) ì½œë°±íŒ¨í„´ì´ë€?
ì¶œì²˜ : [í…œí”Œë¦¿/ì½œë°± íŒ¨í„´ì´ë€? (tistory.com)](https://siyoon210.tistory.com/131)

- ê°„ë‹¨í•œ ë¡œì§ ì˜ˆì‹œ
```java
class MyClass {  
    void myMethod1() {  
        a();  
        System.out.println("B1");
        c();  
    }  
  
    void myMethod2() {  
        a();  
        System.out.println("B2");  
        c();  
    }  
  
    void a() {System.out.println("A");}  
  
    void c() {System.out.println("C");}  
}
  
public class Main {  
    public static void main(String[] args) {  
        MyClass myClass = new MyClass();  
  
        myClass.myMethod1();  
        myClass.myMethod2();  
    }  
}
```


-  ì „ëµíŒ¨í„´ ì ìš©
=>ë³€í™” ë  ìˆ˜ ìˆëŠ” ì™¸ë¶€ì˜ ìš”êµ¬ì‚¬í•­ë“¤ì„ í•˜ë‚˜ì˜ ì¸í„°í˜ì´ìŠ¤ë¡œ ë§Œë“¤ì–´ì„œ ëŒ€ì‘ í•  ìˆ˜ ìˆë„ë¡ ë§Œë“œëŠ” ë””ìì¸ íŒ¨í„´
```java
class MyClass {  
    void myMethod(PrintB printB) {  
        a();  
        printB.b();  
        c();  
    }  
  
    void a() {System.out.println("A");}  
  
    void c() {System.out.println("C");}  
}  
  
interface PrintB {void b();}  
  
class B1 implements PrintB {  
    @Override  
    public void b() {System.out.println("B1");}  
}  
  
class B2 implements PrintB {  
    @Override  
    public void b() {System.out.println("B2");}  
}

public class Main {  
    public static void main(String[] args) {  
        MyClass myClass = new MyClass();  
  
        B1 b1 = new B1();  
        B2 b2 = new B2();  
  
        myClass.myMethod(b1);  
        myClass.myMethod(b2);  
    }  
}
```


- í…œí”Œë¦¿-ì½œë°± íŒ¨í„´ ì ìš©
=> ì „ëµíŒ¨í„´ì˜ ê¸°ë³¸ì  êµ¬ì¡°ì— ë³€í™”ë˜ëŠ” ë¶€ë¶„ì„ ë§¤ë²ˆ í´ë˜ìŠ¤ë¡œ ë§Œë“¤ì§€ ì•Šê³ , ëŒë‹¤ë¡œ ìƒì„±í•˜ì—¬ ì´ìš©
```java
class MyClass {  
    void myMethod(PrintB printB) {  
        a();  
        printB.b();  
        c();  
    }  
  
    void a() {System.out.println("A");}  
  
    void c() {System.out.println("C");}  
}  
  
interface PrintB { void b();}  
  
public class Main {  
    public static void main(String[] args) {  
        MyClass myClass = new MyClass();  
  
        myClass.myMethod(()-> System.out.println("B1"));  
        myClass.myMethod(()-> System.out.println("B2"));  
    }
```


#### ğŸ“Œ (ì½”ë“œ) íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ ì ìš©í•´ë³´ê¸°
- í…œí”Œë¦¿ ì ìš©ì „ ì½”ë“œ
=> íŠ¸ëœì­ì…˜ì‹œì‘, ì»¤ë°‹, ì‹¤íŒ¨ì‹œ ì»¤ë°‹ ì½”ë“œ ì¤„ì´ê¸°
```java
private final PlatformTransactionManager transactionManager;  //íŠ¸ëœì­ì…˜ë§¤ë‹ˆì €
private final MemberRepositoryV3 memberRepository;  
  
public void accountTransfer(String fromId, String toId, int money) throws SQLException {  
    //íŠ¸ëœì­ì…˜ ì‹œì‘  
    TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());  
  
    try {  
        //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§  
        bizLogic(fromId, toId, money);  
        transactionManager.commit(status); //ì„±ê³µì‹œ ì»¤ë°‹  
    } catch (Exception e) {  
        transactionManager.rollback(status); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±  
        throw new IllegalStateException(e);  
    }  
}
```


- í…œí”Œë¦¿ ì ìš©í›„ ì½”ë“œ
=> ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ê³¼ ì˜ˆì™¸ì²˜ë¦¬ë§Œ ë‚¨ìŒ.
```java
private final TransactionTemplate txTemplate; //ìŠ¤í”„ë§ì—ì„œ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ ì¸í„°í˜ì´ìŠ¤
private final MemberRepositoryV3 memberRepository;  
  
public MemberServiceV3_2(PlatformTransactionManager transactionManager, MemberRepositoryV3 memberRepository) {  
    this.txTemplate = new TransactionTemplate(transactionManager);  
    this.memberRepository = memberRepository;  
}  
  
public void accountTransfer(String fromId, String toId, int money) throws SQLException {  
    txTemplate.executeWithoutResult((status) -> {  
        //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§  
        try {  
            bizLogic(fromId, toId, money);  
        } catch (SQLException e) {  
            throw new IllegalStateException(e);  
        }  
    });  
}
```
-> statusëŠ” íŠ¸ëœì­ì…˜ ì‹œì‘ì„ ì•Œë ¤ì£¼ëŠ” ë³€ìˆ˜

## íŠ¸ëœì­ì…˜ AOP
ì¶œì²˜ :  , [[í† ë¹„ì˜ ìŠ¤í”„ë§] 6. AOP (1) (tistory.com)](https://wbluke.tistory.com/17) , [AOP ì •ë¦¬ (3) (tistory.com)](https://jojoldu.tistory.com/71)
#### âœ”  íŠ¸ëœì­ì…˜ AOPë€?
=> ì—¬ëŸ¬ ê°œì˜ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì™¸ì— **ê³µí†µìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ì•¼ í•˜ëŠ” ë¡œì§**(ex.ë¡œê·¸ ì¶œë ¥, ë³´ì•ˆ ì²˜ë¦¬, ì˜ˆì™¸ ì²˜ë¦¬) ì½”ë“œë¥¼ ë³„ë„ë¡œ ë¶„ë¦¬í•´ì„œ **í•˜ë‚˜ì˜ ë‹¨ìœ„ë¡œ ë¬¶ëŠ” ëª¨ë“ˆí™”ì˜ ê°œë…**
![[Pasted image 20221231141021.png]]


#### âœ” íŠ¸ëœì­ì…˜ AOPë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ”?
=> ì„œë¹„ìŠ¤ ê³„ì¸µì— **ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**ë§Œ ë‚¨ê¸´ë‹¤ëŠ” ëª©í‘œëŠ” ì•„ì§ ë‹¬ì„±í•˜ì§€ ëª»í–ˆë‹¤. **@Transactional ì„ ì‚¬ìš©í•˜ë©´** ìŠ¤í”„ë§ì´ AOPë¥¼ ì‚¬ìš©í•´ì„œ íŠ¸ëœì­ì…˜ì„ í¸ë¦¬í•˜ê²Œ ì²˜ë¦¬í•´ì¤€ë‹¤.

#### ğŸ“Œ AOPê°€ ì‚¬ìš©ëœ ì „ì²´ íë¦„
![[Pasted image 20221231154143.png]]


#### ğŸ“Œ (ì½”ë“œ) íŠ¸ëœì­ì…˜ AOPì ìš©í•˜ê¸°

- íŠ¸ëœì­ì…˜ AOPë¥¼ ì‚¬ìš©í•˜ê¸°ì „
![[Pasted image 20221231144521.png]]

```java
public void accountTransfer(String fromId, String toId, int money) throws SQLException {  
    txTemplate.executeWithoutResult((status) -> {  
        //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§  
        try {  
            bizLogic(fromId, toId, money);  
        } catch (SQLException e) {  
            throw new IllegalStateException(e);  
        }  
    });  
}
```


- íŠ¸ëœì­ì…˜ AOPë¥¼ ì‚¬ìš©í•œ í›„
![[Pasted image 20221231144608.png]]

```java
@Transactional  
public void accountTransfer(String fromId, String toId, int money) throws SQLException {  
    bizLogic(fromId, toId, money);  
}
```


#### ğŸ“Œ (ì½”ë“œ) AOP í…ŒìŠ¤íŠ¸
=> AOPë¥¼ ì‚¬ìš©í• ë ¤ë©´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¥¼ ì‚¬ìš©í•´ì•¼ ì´ìš©í•  ìˆ˜ ìˆìŒ.

```java
@SpringBootTest  
class MemberServiceV3_3Test {
	@Autowired  
	private MemberRepositoryV3 memberRepository;  
	@Autowired  
	private MemberServiceV3_3 memberService;  
  
	@TestConfiguration  
	static class TestConfig {  
	    @Bean  
	    DataSource dataSource() {  
	        return new DriverManagerDataSource(URL, USERNAME, PASSWORD);  
	    }  
	  
	    @Bean  
	    PlatformTransactionManager transactionManager() {  
	        return new DataSourceTransactionManager(dataSource());  
	    }  
	  
	    @Bean  
	    MemberRepositoryV3 memberRepositoryV3() {  
	        return new MemberRepositoryV3(dataSource());  
	    }  
  
	    @Bean  
	    MemberServiceV3_3 memberServiceV3_3() {  
	        return new MemberServiceV3_3(memberRepositoryV3());  
	    }  
	}
	
	@Test  
	@DisplayName("ì •ìƒ ì´ì²´")  
	void accountTransfer() throws SQLException {  
	    //given  
	    Member memberA = new Member(MEMBER_A, 10000);  
	    Member memberB = new Member(MEMBER_B, 10000);  
	    memberRepository.save(memberA);  
	    memberRepository.save(memberB);  
	  
	    //when  
	    memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);  
	  
	    //then  
	    Member findMemberA = memberRepository.findById(memberA.getMemberId());  
	    Member findMemberB = memberRepository.findById(memberB.getMemberId());  
	    assertThat(findMemberA.getMoney()).isEqualTo(8000);  
	    assertThat(findMemberB.getMoney()).isEqualTo(12000);  
	}
}
```

`@SpringBootTest` : ìŠ¤í”„ë§ AOPë¥¼ ì ìš©í•˜ë ¤ë©´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ í•„ìš”í•¨.
`@Autowired` : ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ê´€ë¦¬í•˜ëŠ” ë¹ˆë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
`@TestConfiguration` : ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ë¹ˆë“¤ì— ì¶”ê°€ë¡œ í•„ìš”í•œ ìŠ¤í”„ë§ ë¹ˆë“¤ì„ ë“±ë¡í•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŒ.

#### ğŸ“Œ (ì½”ë“œ) ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ìë™ ë¦¬ì†ŒìŠ¤ ë“±ë¡
test ì½”ë“œì—ì„œ ì§ì ‘ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ì„œ ì‚¬ìš©í•˜ëŠ”ê±° ë¶ˆí¸í•¨. ê·¸ë˜ì„œ ë°ì´í„°ì†ŒìŠ¤ë‚˜ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ìŠ¤í”„ë§ë¶€íŠ¸ë¡œ ìë™ë“±ë¡ í•´ë³´ì

1) ë°ì´í„°ì†ŒìŠ¤ - ìë™ ë“±ë¡
=> ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ë°ì´í„°ì†ŒìŠ¤( DataSource )ë¥¼ ìŠ¤í”„ë§ ë¹ˆì— ìë™ìœ¼ë¡œ ë“±ë¡í•œë‹¤

-   ìë™ìœ¼ë¡œ ë“±ë¡ë˜ëŠ” ìŠ¤í”„ë§ ë¹ˆ ì´ë¦„: dataSource  
-   ê¸°ë³¸ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ë°ì´í„°ì†ŒìŠ¤ëŠ” ì»¤ë„¥ì…˜í’€ì„ ì œê³µí•˜ëŠ” HikariDataSource
```
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.username=sa 
spring.datasource.password=
```

2) íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € - ìë™ ë“±ë¡
=> í”„ë§ ë¶€íŠ¸ëŠ” ì ì ˆí•œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ìë™ìœ¼ë¡œ ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡í•œë‹¤.

- ìë™ìœ¼ë¡œ ë“±ë¡ë˜ëŠ” ìŠ¤í”„ë§ ë¹ˆ ì´ë¦„: transactionManager
-   ì–´ë–¤ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì„ íƒí• ì§€ëŠ” í˜„ì¬ ë“±ë¡ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë³´ê³  íŒë‹¨í•¨  
    -   JDBC ê¸°ìˆ  -> DataSourceTransactionManager  
    -   JPA ê¸°ìˆ  -> JpaTransactionManager  
    -   JDBC + JPA ê¸°ìˆ  -> JpaTransactionManager