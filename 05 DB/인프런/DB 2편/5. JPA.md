ë§í¬ : [[[ì¸í”„ëŸ°]ìŠ¤í”„ë§DB 2í¸.pdf]]
í•´ì‹œíƒœí¬ : #JPA

----
## âœ” Â JPAë€?
ì¶œì²˜ : [[Spring JPA] JPA ë€? (tistory.com)](https://dbjh.tistory.com/77)
Â ìë°” ì§„ì˜ì—ì„œ **ORM**(Object-Relational Mapping) ê¸°ìˆ  í‘œì¤€ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì¸í„°í˜ì´ìŠ¤ì˜ ëª¨ìŒ. ORMì€ Â ì• í”Œë¦¬ì¼€ì´ì…˜ Classì™€ RDB(Relational DataBase)ì˜ í…Œì´ë¸”ì„ ë§¤í•‘(ì—°ê²°)í•œë‹¤ëŠ” ì˜ë¯¸ë‹¤.


## âœ” ì™œ JPAë¥¼ ì‚¬ìš©í•´ì•¼ í• ê¹Œ?
- ê°ì²´ì™€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì˜ ì°¨ì´ëŠ” ìƒì†, ì—°ê´€ê´€ê³„, ë°ì´í„° íƒ€ì…, ë°ì´í„° ì‹ë³„ë°©ë²• ë“±ì´ ìˆë‹¤. **ê°ì²´ì™€ ê´€ê³„í˜• ë°ì´íƒ€ë² ì´ìŠ¤ì˜ íŒ¨ëŸ¬ë‹¤ì„ ë¶ˆì¼ì¹˜ ë¬¸ì œë¥¼ í•´ê²°**í•˜ëŠ”ë° ì‹œê°„ê³¼ ì½”ë“œ ì†Œë¹„í•¨. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ JPAì‚¬ìš©í•¨.
![[Pasted image 20230103120203.png]]

## âœ” ORMì¥ì ì€?
- SQLë¬¸ì´ ì•„ë‹Œ **Methodë¥¼ í†µí•´ DBë¥¼ ì¡°ì‘**í•  ìˆ˜ ìˆì–´, ê°œë°œìëŠ” ê°ì²´ ëª¨ë¸ì„ ì´ìš©í•˜ì—¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ êµ¬ì„±í•˜ëŠ”ë°ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆìŒ. (ë‚´ë¶€ì ìœ¼ë¡œëŠ” ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ì—¬ DBë¥¼ ì¡°ì‘í•¨. í•˜ì§€ë§Œ ê°œë°œìê°€ ì´ë¥¼ ì‹ ê²½ ì“°ì§€ ì•Šì•„ë„ë¨)
- Queryì™€ ê°™ì´ í•„ìš”í•œ ì„ ì–¸ë¬¸, í• ë‹¹ ë“±ì˜ **ë¶€ìˆ˜ì ì¸ ì½”ë“œê°€ ì¤„ì–´ë“¤ì–´**, ê°ì¢… ê°ì²´ì— ëŒ€í•œ ì½”ë“œë¥¼ ë³„ë„ë¡œ ì‘ì„±í•˜ì—¬ ì½”ë“œì˜ ê°€ë…ì„±ì„ ë†’ì„
- ê°ì²´ì§€í–¥ì ì¸ ì½”ë“œ ì‘ì„±ì´ ê°€ëŠ¥í•˜ë‹¤. ì˜¤ì§ **ê°ì²´ì§€í–¥ì  ì ‘ê·¼ë§Œ ê³ ë ¤**í•˜ë©´ ë˜ê¸°ë•Œë¬¸ì— ìƒì‚°ì„± ì¦ê°€
- ë§¤í•‘í•˜ëŠ” ì •ë³´ê°€ Classë¡œ ëª…ì‹œ ë˜ì—ˆê¸° ë•Œë¬¸ì— ERDë¥¼ ë³´ëŠ” ì˜ì¡´ë„ë¥¼ ë‚®ì¶œ ìˆ˜ ìˆê³  **ìœ ì§€ë³´ìˆ˜ ë° ë¦¬íŒ©í† ë§ì— ìœ ë¦¬**


## âœ” ORMë‹¨ì ì€?
- ë³µì¡í•˜ê³  ë¬´ê±°ìš´ QueryëŠ” ì†ë„ë¥¼ ìœ„í•´ ë³„ë„ì˜ íŠœë‹ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ê²°êµ­ **SQLë¬¸ì„ ì¨ì•¼í•  ìˆ˜ë„ ìˆìŒ**
- **í•™ìŠµë¹„ìš©**ì´ ë¹„ìŒˆ


## (ì½”ë“œ) JPA ì„¤ì •
**build.gradle**
```java
// JDBCë¥¼ ì£¼ì„ì²˜ë¦¬í•˜ê³  JPA, ìŠ¤í”„ë§ ë°ì´í„° JPA ì¶”ê°€
implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
```

**application.properties**
```java
//í•˜ì´ë²„ë„¤ì´íŠ¸ê°€ ìƒì„±í•˜ê³  ì‹¤í–‰í•˜ëŠ” SQLì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
logging.level.org.hibernate.SQL=DEBUG
//SQLì— ë°”ì¸ë”© ë˜ëŠ” íŒŒë¼ë¯¸í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
```


## (ì½”ë“œ) JPA ì ìš©
#### ğŸ“Œ Item
=> í…Œì´ë¸”ê³¼ ê°ì²´ë¥¼ ì—°ê²°í•˜ëŠ” ê¸°ë³¸ë§¤í•‘
```java
@Data
@Entity
public class Item {
 	@Id @GeneratedValue(strategy = GenerationType.IDENTITY)
 	private Long id;
 	
 	@Column(name = "item_name", length = 10) // ìƒëµê°€ëŠ¥
 	private String itemName;    
 	private Integer price;
 	private Integer quantity;
    
 	public Item() {}
 
 	public Item(String itemName, Integer price, Integer quantity) {
 		this.itemName = itemName;
 		this.price = price;
 		this.quantity = quantity;
 	}
}
```

- `@Entity`Â : JPAê°€ ì‚¬ìš©í•˜ëŠ” ê°ì²´ë¼ëŠ” ëœ»ì´ë‹¤. ì´ ì—ë…¸í…Œì´ì…˜ì´ ìˆì–´ì•¼ JPAê°€ ì¸ì‹í•  ìˆ˜ ìˆìŒ.
- `@GeneratedValue(strategy = GenerationType.IDENTITY)`  : PK ìƒì„± ê°’ì„ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìƒì„±í•˜ëŠ” IDENTITY ë°©ì‹ì„ ì‚¬ìš©
- `@Id`Â : í…Œì´ë¸”ì˜ PKì™€ í•´ë‹¹ í•„ë“œë¥¼ ë§¤í•‘í•¨.
- `@Column`Â : ê°ì²´ì˜ í•„ë“œë¥¼ í…Œì´ë¸”ì˜ ì»¬ëŸ¼ê³¼ ë§¤í•‘í•¨. (`itemName`Â ->Â `item_name`Â ìë™ ë³€í™˜ ê°€ëŠ¥)
- JPAëŠ”Â `public`Â ë˜ëŠ”Â `protected`Â ì˜ ê¸°ë³¸ ìƒì„±ìê°€ í•„ìˆ˜

#### ğŸ“Œ JpaItemRepositoryV1
```java
@Slf4j
@Repository
@Transactional
public class JpaItemRepositoryV1 implements ItemRepository {
 	private final EntityManager em;
    
 	public JpaItemRepositoryV1(EntityManager em) {
 		this.em = em;
 	
    }
    
 	@Override
 	public Item save(Item item) {
 		em.persist(item);
 		return item;
 	}
    
 	@Override
 	public void update(Long itemId, ItemUpdateDto updateParam) {
 		Item findItem = em.find(Item.class, itemId);
 		findItem.setItemName(updateParam.getItemName());
 		findItem.setPrice(updateParam.getPrice());
 		findItem.setQuantity(updateParam.getQuantity());
 	}
    
 	@Override
 	public Optional<Item> findById(Long id) {
 		Item item = em.find(Item.class, id);
 		return Optional.ofNullable(item);
 	}
    
 	@Override
 	public List<Item> findAll(ItemSearchCond cond) {
 		String jpql = "select i from Item i";
 		//ë™ì  ì¿¼ë¦¬ ìƒëµ
 		TypedQuery<Item> query = em.createQuery(jpql, Item.class);
 		return query.getResultList();
    }
}
```

- `private final EntityManager em ` 
    - JPAì˜ ëª¨ë“  ë™ì‘ì€ ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ í†µí•´ì„œ ì´ë£¨ì–´ì§„ë‹¤.  
    - ì—”í‹°í‹°ë§¤ë‹ˆì €ëŠ” ë‚´ë¶€ì— ë°ì´í„°ì†ŒìŠ¤ë¥¼ ê°€ì§€ê³  ìˆê³ , ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.
- `@ Transactional`  :  JPAì˜ ëª¨ë“  ë°ì´í„° ë³€ê²½(ë“±ë¡, ìˆ˜ì •, ì‚­ì œ)ì€ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì´ë£¨ì–´ì ¸ì•¼ í•œë‹¤. ì¡°íšŒëŠ” ì—†ì–´ë„ ê°€ëŠ¥  


#### ğŸ“Œ save ì„¤ëª…
- `em.persist(item)`  : JPAì—ì„œ ê°ì²´ë¥¼ í…Œì´ë¸”ì— ì €ì¥í•  ë•Œ ì‚¬ìš©  
- JPAê°€ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•œ SQL
=>PK í‚¤ ìƒì„± ì „ëµì„ IDENTITY ë¡œ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì„. JPAê°€ INSERT SQL ì‹¤í–‰ ì´í›„ì— ìƒì„±ëœ ID ê²°ê³¼ë¥¼ ë°›ì•„ì„œ ë„£ì–´ì¤€ë‹¤
```sql
insert into item (id, item_name, price, quantity) values (null, ?, ?, ?) 
ë˜ëŠ”
insert into item (id, item_name, price, quantity) values (default, ?, ?, ?) 
ë˜ëŠ”
insert into item (item_name, price, quantity) values (?, ?, ?)
```


#### ğŸ“Œ update ì„¤ëª…
- em.update() ê°™ì€ ë©”ì„œë“œë¥¼ ì „í˜€ í˜¸ì¶œí•˜ì§€ ì•Šì•˜ë‹¤. JPAëŠ” íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ” ì‹œì ì—, ë³€ê²½ëœ ì—”í‹°í‹° ê°ì²´ê°€ ìˆëŠ”ì§€ í™•ì¸ ê°€ëŠ¥í•¨. íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— JPAê°€ ë³€ê²½ëœ ì—”í‹°í‹° ê°ì²´ë¥¼ ì°¾ì•„ì„œ UPDATE SQLì„ ìˆ˜í–‰í•œë‹¤ê³  ì´í•´í•˜ì.


#### ğŸ“Œ findById ì„¤ëª…
- ì—”í‹°í‹° ê°ì²´ë¥¼ PKë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒí•  ë•Œ ì‚¬ìš©  
- JPAê°€ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•œ SQL
```sql
select
	item0_.id as id1_0_0_, 
	item0_.item_name as item_nam2_0_0_, 
	item0_.price as price3_0_0_, 
	item0_.quantity as quantity4_0_0_
from item item0_ 
where item0_.id=?
```


#### ğŸ“Œ findAll ì„¤ëª…
ì¶œì²˜ : [[JPA] ê°ì²´ì§€í–¥ ì¿¼ë¦¬, JPQL (tistory.com)](https://ict-nroo.tistory.com/116)
- JPQL  
	- ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´ë¡œ ì£¼ë¡œ ì—¬ëŸ¬ ë°ì´í„°ë¥¼ **ë³µì¡í•œ ì¡°ê±´ìœ¼ë¡œ ì¡°íšŒ**í•  ë•Œ ì‚¬ìš©  
	- SQLì´ í…Œì´ë¸”ì„ ëŒ€ìƒìœ¼ë¡œ í•œë‹¤ë©´, **JPQLì€ ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ SQLì„ ì‹¤í–‰í•œë‹¤ ìƒê°**í•˜ë©´ ëœë‹¤.

ì‹¤í–‰ëœ JPQL
```sql
select i from Item i
where i.itemName like concat('%',:itemName,'%')
 	and i.price <= :maxPrice
```

JPQLì„ í†µí•´ ì‹¤í–‰ëœ SQL
```sql
select
 	item0_.id as id1_0_,
 	item0_.item_name as item_nam2_0_,
 	item0_.price as price3_0_,
 	item0_.quantity as quantity4_0_
from item item0_
where (item0_.item_name like ('%'||?||'%'))
 	and item0_.price<=?
```
- JPQLì—ì„œ íŒŒë¼ë¯¸í„° ì…ë ¥ :Â `where price <= :maxPrice`  
- íŒŒë¼ë¯¸í„° ë°”ì¸ë”© :Â `query.setParameter("maxPrice", maxPrice)`


#### ğŸ“Œ JpaConfig
```java
@Configuration   
public class JpaConfig {  
    private final EntityManager em;  
    public JpaConfig(EntityManager em) {   
        this.em = em;  
    }  
      
    @Bean public ItemService itemService() {   
        return new ItemServiceV1(itemRepository());  
    }  
      
    @Bean public ItemRepository itemRepository() {   
        return new JpaItemRepositoryV1(em);  
    }   
}
```


## Â ì˜ˆì™¸ ë³€í™˜
- EntityManager ëŠ” ìˆœìˆ˜í•œ JPA ê¸°ìˆ ì´ê³ , ìŠ¤í”„ë§ê³¼ëŠ” ê´€ê³„ê°€ ì—†ë‹¤. ê·¸ë˜ì„œ JPA ê´€ë ¨ ì˜ˆì™¸ë¥¼ ë°œìƒí•¨.
- ì˜ˆì™¸ë³€í™˜ì „
=> JPA ì˜ˆì™¸ ë°œìƒì‹œí‚¤ë‹ˆê¹, JPAì— ì¢…ì†ì ì´ê²Œ ë˜ëŠ” ë¬¸ì œì  ë°œìƒ. ìŠ¤í”„ë§ ì˜ˆì™¸ ì¶”ìƒí™”ë¡œ ë³€í™˜í•´ì•¼í•¨.
![[Pasted image 20230103162401.png]]

- ì˜ˆì™¸ë³€í™˜í›„
![[Pasted image 20230103162327.png]]
