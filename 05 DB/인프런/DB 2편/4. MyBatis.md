ë§í¬ : [[[ì¸í”„ëŸ°]ìŠ¤í”„ë§DB 2í¸.pdf]]
í•´ì‹œíƒœí¬ : #MyBatis

----
## âœ” MyBatisë€?
=> SQL Mapperë¡œ, **SQLì„ XMLì— í¸ë¦¬í•˜ê²Œ ì‘ì„±**í•  ìˆ˜ ìˆê³  ë˜ **ë™ì  ì¿¼ë¦¬ë¥¼ ë§¤ìš° í¸ë¦¬í•˜ê²Œ ì‘ì„±**í•  ìˆ˜ ìˆë‹¤.

##  âœ” JdbcTemplate VS MyBatisì°¨ì´ëŠ”?
- JdbcTemplate
	- ì¥ì  : ìŠ¤í”„ë§ì— ë‚´ì¥ëœ ê¸°ëŠ¥ì´ê³ , **ë³„ë„ì˜ ì„¤ì •ì—†ì´ ì‚¬ìš©**í•  ìˆ˜ ìˆìŒ,
	- ë‹¨ì  : **ë™ì  ì¿¼ë¦¬** ì ìš©ì´ ë³µì¡í•˜ë‹¤.Â 
- MyBatis
	- ì¥ì  : **ë™ì  ì¿¼ë¦¬**ë¥¼ ë§¤ìš° í¸ë¦¬í•˜ê²Œ ì‘ì„±í•  ìˆ˜ ìˆìŒ.
	- ë‹¨ì  : **ë³„ë„ì˜ ì„¤ì •**ì´ í•„ìš”í•¨.

## (ì½”ë“œ) JdbcTemplate VS MyBatis ì½”ë“œ ì°¨ì´ëŠ”?
#### ğŸ“ŒSQL ì—¬ëŸ¬ì¤„ì¼ë•Œ
- JdbcTemplate
```sql
String sql = "update item " + 
			 "set item_name=:itemName, price=:price, quantity=:quantity " + 
			 "where id=:id";
```

- MyBatis
```xml
<update id="update"> 
	update item
	set item_name=#{itemName}, 
		price=#{price}, 
		quantity=#{quantity} 
	where id = #{id}
</update>
```


#### ğŸ“Œë™ì ì¿¼ë¦¬ì¼ë•Œ
- JdbcTemplate
```sql
String sql = "select id, item_name, price, quantity from item";  
//ë™ì  ì¿¼ë¦¬ 
if(StringUtils.hasText(itemName)||maxPrice !=null)  {  
    sql += " where";  
}  
  
boolean andFlag = false; 
if(StringUtils.hasText(itemName))  {  
    sql += " item_name like concat('%',:itemName,'%')";  
    andFlag = true;  
}  

if(maxPrice!=null)  {  
    if (andFlag) {  
        sql += " and";  
    }  
    sql += " price <= :maxPrice";  
}  

log.info("sql={}",sql);
return template.query(sql, param, itemRowMapper());
```

- MyBatis
```xml
<select id="findAll"resultType="Item">  
    select id, item_name, price, quantity  
    from item   
	<where>   
		<if test="itemName != null and itemName != ''">  
			and item_name like concat('%',# {itemName},'%')  
		</if>   
		<if test="maxPrice != null">  
			and price &lt;= #{maxPrice}  
		</if>   
	</where>  
</select>
```


## (ì½”ë“œ) MyBatis ì„¤ì •
#### ğŸ“Œbuild.gradle 
```
//MyBatis ì¶”ê°€
implementation 'org.mybatis.spring.boot:mybatis-spring-boot-starter:2.2.0'
```

#### ğŸ“Œmain - application.properties
```
...

#MyBatis
mybatis.type-aliases-package=hello.itemservice.domain 
mybatis.configuration.map-underscore-to-camel-case=true 
logging.level.hello.itemservice.repository.mybatis=trace
```

#### ğŸ“Œtest - application.properties
```
#MyBatis
mybatis.type-aliases-package=hello.itemservice.domain 
mybatis.configuration.map-underscore-to-camel-case=true 
logging.level.hello.itemservice.repository.mybatis=trace
```

- `mybatis.type-aliases-package` : ì§€ì •í•œ íŒ¨í‚¤ì§€ì™€ ê·¸ í•˜ìœ„ íŒ¨í‚¤ì§€ê°€ ìë™ìœ¼ë¡œ ì¸ì‹.
- `mybatis.configuration.map-underscore-to-camel-case` : ì–¸ë”ë°”ë¥¼ ì¹´ë©œë¡œ ìë™ ë³€ê²½í•´ì£¼ëŠ” ê¸°ëŠ¥ì„ í™œì„±í™”.
- `logging.level.hello.itemservice.repository.mybatis=trace` : MyBatisì—ì„œ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ ë¡œê·¸ë¥¼ í™•ì¸.


## (ì½”ë“œ) MyBatis SQL ì‚¬ìš©í•˜ê¸°
#### ğŸ“ŒItemMapper
=> ë§ˆì´ë°”í‹°ìŠ¤ ë§¤í•‘ XMLì„ í˜¸ì¶œí•´ì£¼ëŠ” ë§¤í¼ ì¸í„°í˜ì´ìŠ¤

```java
@Mapper  
public interface ItemMapper {  
  
    void save(Item item);  
  
    void update(@Param("id") Long id, @Param("updateParam") ItemUpdateDto updateParam);  
  
    Optional<Item> findById(Long id);  
  
    List<Item> findAll(ItemSearchCond itemSearch);  
}
```


#### ğŸ“ŒItemMapper.xml
=> ìœ„ì¹˜ëŠ” `main/resources/hello/itemservice/repository/mybatis/ItemMapper.xml`
=> ì‹¤í–‰í•  SQLì´ ìˆëŠ” XML ë§¤í•‘ íŒŒì¼ì„ ë§Œë“¤ê¸°
```xml
<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="hello.itemservice.repository.mybatis.ItemMapper">  
  
    <insert id="save" useGeneratedKeys="true" keyProperty="id">  
        insert into item (item_name, price, quantity)  
        values (#{itemName}, #{price}, #{quantity})    
    </insert>  
  
    <update id="update">  
        update item  
        set item_name=#{updateParam.itemName},            
	        price=#{updateParam.price},           
	        quantity=#{updateParam.quantity}        
        where id = #{id}    
    </update>  
  
    <select id="findById" resultType="Item">  
        select id, item_name, price, quantity  
        from item        
        where id = #{id}    
    </select>  
  
    <select id="findAll" resultType="Item">  
        select id, item_name, price, quantity  
        from item        
        <where>  
            <if test="itemName != null and itemName != ''">  
            <!-- andì—ì„œ whereë¡œ ë°”ê¿” ë¬¸ë²•ì ìœ¼ë¡œ ì˜¤ë¥˜ í•´ê²°í•´ì¤Œ -->
                and item_name like concat('%', #{itemName}, '%')  
            </if>  
            <if test="maxPrice != null">  
                and price &lt;= #{maxPrice}  
            </if>  
        </where>  
    </select>  
  
</mapper>
```

#### ğŸ“ŒMyBatisItemRepository
=> ë‹¨ìˆœíˆ ItemMapper ì— ê¸°ëŠ¥ì„ ìœ„ì„í•¨.
```java
@Repository  
@RequiredArgsConstructor  
public class MyBatisItemRepository implements ItemRepository {  
  
    private final ItemMapper itemMapper;  //ìë™ì£¼ì…ë°›ê¸°
  
    @Override  
    public Item save(Item item) {  
        log.info("itemMapper class={}", itemMapper.getClass());  
        itemMapper.save(item);  
        return item;  
    }  
  
    @Override  
    public void update(Long itemId, ItemUpdateDto updateParam) {  
        itemMapper.update(itemId, updateParam);  
    }  
  
    @Override  
    public Optional<Item> findById(Long id) {  
        return itemMapper.findById(id);  
    }  
  
    @Override  
    public List<Item> findAll(ItemSearchCond cond) {  
        return itemMapper.findAll(cond);  
    }  
}
```


#### ğŸ“ŒMyBatisConfig
=> ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ì£¼ì…
```java
@Configuration  
@RequiredArgsConstructor  
public class MyBatisConfig {  
  
    private final ItemMapper itemMapper;  //ë°ì´í„°ì†ŒìŠ¤ê°€ ì•„ë‹Œ ì•„ì´í…œë§¤í¼ ì£¼ì…ë°›ê¸°
  
    @Bean  
    public ItemService itemService() {  
        return new ItemServiceV1(itemRepository());  
    }  
  
    @Bean  
    public ItemRepository itemRepository() {  
        return new MyBatisItemRepository(itemMapper);  
    }  
}
```


## ë§¤í¼ ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ê°€ ì—†ëŠ”ë° ì–´ë–»ê²Œ ë™ì‘í•œ ê²ƒì¼ê¹Œ?
- MyBatis ìŠ¤í”„ë§ ì—°ë™ ëª¨ë“ˆì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•¨. ItemMapper ì˜ êµ¬í˜„ì²´ ë•ë¶„ì— ì¸í„°í˜ì´ìŠ¤ ë§Œìœ¼ë¡œ í¸ë¦¬í•˜ê²Œ XMLì˜ ë°ì´í„°ë¥¼ ì°¾ì•„ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤.
- ë§¤í¼ êµ¬í˜„ì²´ëŠ” ì˜ˆì™¸ ë³€í™˜ê¹Œì§€ ì²˜ë¦¬í•´ì¤Œ.

![[Pasted image 20230102152949.png]]
1. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— MyBatis ìŠ¤í”„ë§ ì—°ë™ ëª¨ë“ˆì€ `@Mapper` ê°€ ë¶™ì–´ìˆëŠ” **ì¸í„°í˜ì´ìŠ¤ë¥¼ ì¡°ì‚¬**í•œë‹¤. 
2. í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ê°€ ë°œê²¬ë˜ë©´ ë™ì  í”„ë¡ì‹œ ê¸°ìˆ ì„ ì‚¬ìš©í•´ì„œ ItemMapper **ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ë¥¼ ë§Œë“ ë‹¤.** 
3. ìƒì„±ëœ êµ¬í˜„ì²´ë¥¼ **ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡**í•œë‹¤.


## MyBatis ê¸°ëŠ¥ ì •ë¦¬
ì¶œì²˜ : [MyBatis â€“ ë§ˆì´ë°”í‹°ìŠ¤ 3 | ë™ì  SQL](https://mybatis.org/mybatis-3/ko/dynamic-sql.html)
=>ë‚´ë¶€ì˜ ë¬¸ë²•ì€ OGNLì„ ì‚¬ìš©í•¨.

#### ğŸ“Œ if
=> í•´ë‹¹ ì¡°ê±´ì— ë”°ë¼ ê°’ì„ ì¶”ê°€í• ì§€ ë§ì§€ íŒë‹¨í•¨.
```xml
<select id="findActiveBlogWithTitleLike" resultType="Blog"> 
	SELECT * FROM BLOG 
	WHERE state = â€˜ACTIVEâ€™ 
	<if test="title != null"> 
		AND title like #{title}
	</if> 
</select>
```

#### ğŸ“Œchoose, when, otherwise
=> ìë°”ì˜ switch êµ¬ë¬¸ê³¼ ìœ ì‚¬í•œ êµ¬ë¬¸ë„ ì‚¬ìš©í• ìˆ˜ ìˆìŒ.
```xml
<select id="findActiveBlogLike" resultType="Blog">  
    SELECT * FROM BLOG WHERE state = â€˜ACTIVEâ€™  
    <choose>  
        <when test="title != null">  
            AND title like #{title}  
        </when>   
		<when test="author != null and author.name != null">   
			AND author_name like #{author.name}  
        </when>  
        <otherwise>            
	        AND featured = 1   
        </otherwise>   
    </choose>  
</select>
```

#### ğŸ“Œtrim, where, set
```xml
<select id="findActiveBlogLike" resultType="Blog">  
    SELECT * FROM BLOG WHERE  
    <if test="state != null">  
        state = #{state}  
    </if>   
	<if test="title != null">   
		AND title like #{title}  
    </if>   
	<if test="author != null and author.name != null">   
		AND author_name like #{author.name}  
    </if> 
</select>
```

#### ğŸ“Œforeach
```xml
<select id="selectPostIn" resultType="domain.blog.Post">
  SELECT *
  FROM POST P
  <where>
    <foreach item="item" index="index" collection="list"
        open="ID in (" separator="," close=")" nullable="true">
          #{item}
    </foreach>
  </where>
</select>
```


#### ğŸ“Œì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ SQL ì‘ì„±
```java
@Select("select id, item_name, price, quantity from item where id=#{id}")
Optional<Item> findById(Long id);
```
-   `@Insert`Â ,Â `@Update`Â ,Â `@Delete`Â ,Â `@Select`Â ê¸°ëŠ¥ì´ ì œê³µëœë‹¤.
-   ì´ ê²½ìš° XMLì—ëŠ”Â `<select id="findById"> ~ </select>`Â ëŠ” ì œê±°í•´ì•¼ í•œë‹¤.
-   ë™ì  SQLì´ í•´ê²°ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê°„ë‹¨í•œ ê²½ìš°ì—ë§Œ ì‚¬ìš©í•œë‹¤.


#### ğŸ“Œë¬¸ìì—´ ëŒ€ì²´(String Substitution)
```java
@Select("select * from user where ${column} = #{value}")
User findByColumn(@Param("column") String column, @Param("value") String value);
```
-  íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì´ ì•„ë‹ˆë¼ ë¬¸ì ê·¸ëŒ€ë¡œë¥¼ ì²˜ë¦¬í•˜ê³  ì‹¶ì€ ê²½ìš°Â `${}`Â ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.