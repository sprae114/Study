ë§í¬ : [[[ì¸í”„ëŸ°]ìŠ¤í”„ë§DB 2í¸.pdf]]
í•´ì‹œíƒœí¬ : #DBí…ŒìŠ¤íŠ¸, #ì„ë² ë””ë“œëª¨ë“œ

----

#### ğŸ“Œ(ì½”ë“œ) ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì† ì„¤ì •ë°©ë²•ì€?
- main - application.properties
```
spring.profiles.active=local 
spring.datasource.url=jdbc:h2:tcp://localhost/~/test 
spring.datasource.username=sa

logging.level.org.springframework.jdbc=debug
```
- test - application.properties
=> í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì—ì„œë„ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì†í•  ìˆ˜ ìˆê²Œ ì„¤ì •í•¨.
```
spring.profiles.active=test
```

#### ğŸ“Œ@SpringBootTestë€?
```java
@SpringBootTest 
class ItemRepositoryTest {}
```
=> @SpringBootTest ëŠ” @SpringBootApplication ë¥¼ ì°¾ì•„ì„œ ì„¤ì •ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.

```java
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication
public class ItemServiceApplication {}
```
=> í…ŒìŠ¤íŠ¸ë„ JdbcTemplate ì„ í†µí•´ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í˜¸ì¶œí•˜ê²Œ ëœë‹¤.

#### ğŸ“Œí…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì£¼ì˜ì ì€?
1) ë°ì´í„°ë² ì´ìŠ¤ **ì„œë²„ê°€ ì‹¤í–‰**ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤.
2) í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ë©´ ì‹¤ì œ DBì— ì €ì¥ëŒ. ê·¸ë˜ì„œ ê³¼ê±°ì— ì„œë²„ë¥¼ ì‹¤í–‰í•˜ë©´ì„œ **ì €ì¥í–ˆë˜ ë°ì´í„°ê°€ ë³´ê´€**ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ì´ ë°ì´í„°ê°€ í˜„ì¬ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŒ.

#### ğŸ“Œ (ì½”ë“œ) í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ë¶„ë¦¬í•˜ëŠ” ì„¤ì •ì€?
1) ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ìƒì„±
- ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ë¥¼ ì¢…ë£Œí•˜ê³  ë‹¤ì‹œ ì‹¤í–‰í•œë‹¤. 
- ì‚¬ìš©ìëª…ì€ sa ì…ë ¥ JDBC URLì— ë‹¤ìŒ ì…ë ¥, jdbc:h2:~/testcase (ìµœì´ˆ í•œë²ˆ) 
- ~/testcase.mv.db íŒŒì¼ ìƒì„± í™•ì¸ 
- ì´í›„ë¶€í„°ëŠ” jdbc:h2:tcp://localhost/~/testcase ì´ë ‡ê²Œ ì ‘ì†

2) í…Œì´ë¸” ìƒì„±í•˜ê¸°
```sql
drop table if exists item CASCADE; 
create table item (
id bigint generated by default as identity,
item_name varchar(10), 
price integer,
quantity integer,
primary key (id)
);
```

3) ì ‘ì† ì •ë³´ ë³€ê²½
urlì„ ~/testì—ì„œ ~/testcaseë¡œ ë³€ê²½í•¨.
```
spring.profiles.active=test 
spring.datasource.url=jdbc:h2:tcp://localhost/~/testcase 
spring.datasource.username=sa
```

## í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡¤ë°±í•˜ëŠ” ë°©ë²•ì€?
í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ê³  ë‚˜ì„œ íŠ¸ëœì­ì…˜ì„ ê°•ì œë¡œ ë¡¤ë°±í•´ë²„ë¦¬ë©´ ë°ì´í„°ê°€ ê¹”ë”í•˜ê²Œ ì œê±°ëœë‹¤

#### ğŸ“Œ@BeforeEach , @AfterEach
=> í…ŒìŠ¤íŠ¸ëŠ” ê°ê°ì˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ í›„ë¡œ ë™ì‘í•˜ëŠ” @BeforeEach , @AfterEach ë¼ëŠ” í¸ë¦¬í•œ ê¸°ëŠ¥ì„ ì œê³µ

```java
@BeforeEach    
void beforeEach() {        
	//íŠ¸ëœì­ì…˜ ì‹œì‘  
	status = transactionManager.getTransaction(new DefaultTransactionDefinition());    
}

@AfterEach  
void afterEach() {  
	//MemoryItemRepository ì˜ ê²½ìš° ì œí•œì ìœ¼ë¡œ ì‚¬ìš©  
	if (itemRepository instanceof MemoryItemRepository) {  
		((MemoryItemRepository) itemRepository).clearStore();  
	}  
	//íŠ¸ëœì­ì…˜ ë¡¤ë°±  
	transactionManager.rollback(status);  
}
```

#### ğŸ“Œ@Transactional
```java
@Transactional 
@SpringBootTest 
class ItemRepositoryTest {}
```

![[Pasted image 20230102104629.png]]
-   1. @ Transactional ì• ë…¸í…Œì´ì…˜ì´ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œë‚˜ í´ë˜ìŠ¤ì— ìˆìœ¼ë©´ **ë¨¼ì € íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•¨.**  
-   2. í…ŒìŠ¤íŠ¸ë¥¼ ë¡œì§ì„ ì‹¤í–‰í•œë‹¤. í…ŒìŠ¤íŠ¸ê°€ ëë‚  ë•Œ ê¹Œì§€ **ëª¨ë“  ë¡œì§ì€ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ìˆ˜í–‰**  
-   3. @ Transactional ì´ í…ŒìŠ¤íŠ¸ì— ìˆìœ¼ë©´ **í…ŒìŠ¤íŠ¸ê°€ ëë‚ ë•Œ íŠ¸ëœì­ì…˜ì„ ê°•ì œë¡œ ë¡¤ë°±**

## ì„ë² ë””ë“œ ëª¨ë“œ

#### ğŸ“ŒEmbedded Mode VS In-Memory Modeë€?
ê³µí†µì 
- DBë¥¼ ë„ìš°ì§€ ì•Šì•„ë„Â **ì†ì‰½ê²Œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©**í•  ìˆ˜ ìˆê¸°ì— í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œ ìì£¼ ì‚¬ìš©ëœë‹¤.
- ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¢…ë£Œë˜ë©´ DBê°€ ì¢…ë£Œë˜ê³ , ë°ì´í„°ë„ ëª¨ë‘ ì‚¬ë¼ì§.

ì°¨ì´ì 
- Embedded Mode :Â  ìŠ¤í”„ë§ ë¶€íŠ¸ ì‹¤í–‰í•  ë•Œ í•¨ê»˜ H2ë¥¼ ë„ìš´ë‹¤.Â H2 DB ë°ì´í„°ë¥¼Â ë¡œì»¬ì— ì§ì ‘ ì €ì¥í•˜ê³  ì‚¬ìš©í•œë‹¤.
- In-Memory Mode : ìŠ¤í”„ë§ ë¶€íŠ¸ ì‹¤í–‰í•  ë•Œ í•¨ê»˜ H2ë¥¼ ë„ìš´ë‹¤.Â H2 DB ë°ì´í„°ë¥¼Â ë¡œì»¬ì— ì €ì¥í•˜ì§€ ì•Šê³  ë©”ëª¨ë¦¬ì—ë§Œ ê°€ì§€ê³ ìˆë‹¤.


#### ğŸ“Œ(ì½”ë“œ) ì„ë² ë””ë“œ ëª¨ë“œ ì‚¬ìš©ë°©ë²•ì€?
- ì„ë² ë””ë“œ ëª¨ë“œ ì‚¬ìš©ì„¤ì •(ì´í•´ë§Œ)
=>ë³„ë‹¤ë¥¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ì„ë² ë””ë“œ ëª¨ë“œë¡œ ì ‘ê·¼í•˜ëŠ” ë°ì´í„°ì†ŒìŠ¤( DataSource )ë¥¼ ë§Œë“¤ì–´ì„œ ì œê³µí•¨. ë¡œê·¸ë¥¼ ë³´ë©´ ë‹¤ìŒ ë¶€ë¶„ì„ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë° jdbc:h2:mem ë’¤ì— ì„ì˜ì˜ ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„ì´ ë“¤ì–´ê°€ ìˆë‹¤. 
```java
public class ItemServiceApplication {  
	...

   @Bean  
   @Profile("test")  
   public DataSource dataSource() {  
      log.info("ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”");  
      DriverManagerDataSource dataSource = new DriverManagerDataSource();  
      dataSource.setDriverClassName("org.h2.Driver");  
      dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");  
      dataSource.setUsername("sa");  
      dataSource.setPassword("");  
      return dataSource;  
   }  
}
```

```
spring.profiles.active=test  
spring.datasource.url=jdbc:h2:tcp://localhost/~/testcase  
spring.datasource.username=sa
```


- í…Œì´ë¸” ìƒì„±
test/resourcesì— ìƒì„±
```sql
drop table if exists item CASCADE; 
create table item (
id bigint generated by default as identity,
item_name varchar(10), 
price integer,
quantity integer, 
primary key (id)
);
```