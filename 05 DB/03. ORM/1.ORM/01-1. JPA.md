#JPAê°œë…, 

#ì¸í”„ëŸ°ìŠ¤í”„ë§DB2í¸05
[[Java] ORMì´ë€? MyBatisì™€ JPAì˜ ì°¨ì´, MyBatisë³´ë‹¤ JPAë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ì´ìœ ](https://mangkyu.tistory.com/20)
[(27) [10ë¶„ í…Œì½”í†¡] ë„ì´ì˜ JDBC vs SQL Mapper vs ORM - YouTube](https://www.youtube.com/watch?v=RWFtuQUx3fo&list=PLgXGHBqgT2TvpJ_p9L_yZKPifgdBOzdVH&index=35)
[(27) [10ë¶„ í…Œì½”í†¡] â° ì•„ë§ˆì°Œì˜ ORM vs SQL Mapper vs JDBC - YouTube](https://www.youtube.com/watch?v=VTqqZSuSdOk&list=PLgXGHBqgT2TvpJ_p9L_yZKPifgdBOzdVH&index=254)
[(27) [10ë¶„ í…Œì½”í†¡] ğŸ§˜â€â™‚ï¸ì½”ì¦ˆì˜ JDBC, SQLMAPPER, ORM - YouTube](https://www.youtube.com/watch?v=mezbxKGu68Y&list=PLgXGHBqgT2TvpJ_p9L_yZKPifgdBOzdVH&index=318)
[(27) [10ë¶„ í…Œì½”í†¡] ğŸ™†â€â™‚ï¸á„‹á…©á†¯á„…á…¦á„‹á…´ JPAá„‹á…ª JDBC - YouTube](https://www.youtube.com/watch?v=Ppqc3qN75EE&list=PLgXGHBqgT2TvpJ_p9L_yZKPifgdBOzdVH&index=362)
[[ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë° ì •ë¦¬], 1ì¥ JPA ì†Œê°œ (tistory.com)](https://junghyungil.tistory.com/138)

----
## JPAë€?
[[Spring JPA] JPA ë€? (tistory.com)](https://dbjh.tistory.com/77)
ìë°” ì§„ì˜ì—ì„œ **ORM**(Object-Relational Mapping) ê¸°ìˆ  í‘œì¤€ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì¸í„°í˜ì´ìŠ¤ì˜ ëª¨ìŒ. ORMì€ Â ì• í”Œë¦¬ì¼€ì´ì…˜ Classì™€ RDB(Relational DataBase)ì˜ í…Œì´ë¸”ì„ ë§¤í•‘(ì—°ê²°)í•œë‹¤ëŠ” ì˜ë¯¸ë‹¤.
![[Pasted image 20240828174234.png]]


## ì™œ JPAë¥¼ ì‚¬ìš©í•´ì•¼ í• ê¹Œ?
[ë²”ê³ ë˜, ì†Œì£¼ìº‰ì˜ JDBC, SQL Mapper, ORM](https://ysiksik.github.io/elegant-tekotok/2023-01-15-ORCA-Suzhoukang-JDBC-SQLMapper-ORM/#granularity%EC%84%B8%EB%B6%84%EC%84%B1)
[ë„ì´ì˜ JDBC vs SQL Mapper vs ORM](https://ysiksik.github.io/elegant-tekotok/2023-11-29-DOI-JDBC-SQLMapper-ORM/)
```
SQL êµ¬ë¬¸ ì‘ì„± ë° ìœ ì§€ë³´ìˆ˜ê°€ ì‹œê°„ì´ ì¤„ì–´ë“¦
```

ê°œë°œìê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë³´ë‹¤ëŠ” SQL ì‘ì„±ì´ë‚˜ ìˆ˜ì •ì— ë„ˆë¬´ ë§ì€ ì‹œê°„ì„ ì‚¬ìš©í•´ì•¼í•œë‹¤. (ê°ì²´ í•„ë“œê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ SQL ìˆ˜ì •)


1) í…Œì´ë¸” ìƒì„± SQL
```sql
CREATE TABLE User (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE
);
```

2) CRUD ìƒì„± SQL
- INSERT êµ¬ë¬¸
```sql
INSERT INTO User (name, email) VALUES ('í™ê¸¸ë™', 'hong@example.com');
```
- SELECT êµ¬ë¬¸
```sql
SELECT * FROM User WHERE id = ?;
```
 - UPDATE êµ¬ë¬¸
```sql
UPDATE User SET name = 'ê¹€ì² ìˆ˜', email = 'kim@example.com' WHERE id = ?;
```
- DELETE êµ¬ë¬¸
```sql
DELETE FROM User WHERE id = ?;
```


## ORMì¥ì ì€?
1. ì—”í‹°í‹°ì— ë§ëŠ” í…Œì´ë¸” ìƒì„± + DB ìƒì„±ì„ í¸ë¦¬
2. ê°ì²´ ì§€í–¥ ì¤‘ì‹¬ì˜ ê°œë°œ
3. í…ŒìŠ¤íŠ¸ ì‘ì„±ì´ ìš©ì´
4. ê¸°ë³¸ì ì¸ CRUD ìë™í™”


## ORMë‹¨ì ì€?
- **SQL ìµœì í™”ë‚˜ ë³µì¡í•œ ì¿¼ë¦¬ëŠ” ì§ì ‘ ì‘ì„±**í•´ì•¼í•¨. 
- **í•™ìŠµë¹„ìš©**ì´ ë¹„ìŒˆ. (ê°ì²´ì™€ DBì™€ JPA 3ê°œ ë‹¤ ì•Œê³  ìˆì–´ì•¼í•¨.)




# ì½”ë“œ
#JPAConfig , #Config

----
## (ì½”ë“œ) JPA ì„¤ì •
â–¶ build.gradle
jpa ì˜ì¡´ì„± ì¶”ê°€ ë° h2 DB ì—°ê²°
```c
implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
implementation 'com.h2database:h2' // H2 ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©
implementation 'org.springframework.boot:spring-boot-starter-web'
testImplementation 'org.springframework.boot:spring-boot-starter-test'
```

â–¶ application.yml ì„¤ì •
```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb # H2 ì¸ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ URL
    driver-class-name: org.h2.Driver # H2 ë“œë¼ì´ë²„ í´ë˜ìŠ¤ ì´ë¦„
    username: sa # ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì ì´ë¦„
    password: "" # ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸ (ë¹„ì–´ ìˆìŒ)

  jpa:
    show-sql: true # ì‹¤í–‰ë˜ëŠ” SQL ì¿¼ë¦¬ë¥¼ ì½˜ì†”ì— ì¶œë ¥
    properties:
      hibernate:
        format_sql: true # ì¶œë ¥ë˜ëŠ” SQL ì¿¼ë¦¬ë¥¼ í¬ë§·í•˜ì—¬ ê°€ë…ì„± ë†’ì„
    generate-ddl: false # ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬
    hibernate:
      ddl-auto: create-drop # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ í…Œì´ë¸” ìƒì„±, ì¢…ë£Œ ì‹œ ì‚­ì œ
```


## ì–´ë…¸í…Œì´ì…˜
```java
@Configuration 
@ComponentScan("com.sp.fc.paper") 
@EnableJpaRepositories(basePackages = { "com.sp.fc.paper.repository" }) @EntityScan(basePackages = { "com.sp.fc.paper.domain" }) 
@EnableJpaAuditing
public class PaperModule {

}
```
#### @Configuration
í•´ë‹¹ í´ë˜ìŠ¤ê°€ **Springì˜ ì„¤ì • í´ë˜ìŠ¤ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤ëŠ” ê²ƒ**ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. Spring ì»¨í…Œì´ë„ˆê°€ ì´ í´ë˜ìŠ¤ë¥¼ ì½ê³ , ê·¸ ì•ˆì— ì •ì˜ëœ ë¹ˆ(Bean)ë“¤ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.

#### @ComponentScan
Â `com.sp.fc.paper`Â íŒ¨í‚¤ì§€ ë° ê·¸ í•˜ìœ„ íŒ¨í‚¤ì§€ì—ì„œ Spring ì»´í¬ë„ŒíŠ¸ë¥¼ **ìë™ìœ¼ë¡œ ê²€ìƒ‰í•˜ê³  ë“±ë¡**í•˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤. 

#### @EnableJpaRepositories
JPA ë¦¬í¬ì§€í† ë¦¬ ê¸°ëŠ¥ì„ í™œì„±í™”í•©ë‹ˆë‹¤.Â `com.sp.fc.paper.repository`Â íŒ¨í‚¤ì§€ ë‚´ì˜ ì¸í„°í˜ì´ìŠ¤ì— ëŒ€í•´ Spring Data JPAê°€ **êµ¬í˜„ì²´ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ ìƒí˜¸ì‘ìš©**ì„ ì‰½ê²Œ í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

#### @EntityScan
JPA ì—”í‹°í‹° í´ë˜ìŠ¤ë¥¼ ìŠ¤ìº”í•˜ëŠ” ì„¤ì •ì…ë‹ˆë‹¤.Â ì´ë¥¼ í†µí•´ JPAê°€ **í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì™€ ë§¤í•‘**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### @EnableJpaAuditing
JPA ê°ì‚¬ ê¸°ëŠ¥ì„ í™œì„±í™”í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì—”í‹°í‹°ì— ëŒ€í•œ **ìƒì„±ì¼, ìˆ˜ì •ì¼ ë“±ì˜ ê°ì‚¬ë¥¼ ìë™ìœ¼ë¡œ ê´€ë¦¬**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´,Â `@CreatedDate`,Â `@LastModifiedDate`Â ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ìë™ìœ¼ë¡œ ë‚ ì§œë¥¼ ê¸°ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


# ì´ˆê¸° ë°ì´í„° ì…‹íŒ…
## @GeneratedValueë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´..
ë‹¤ìŒ sqlë¬¸ì„ ì¦ê°€ì‹œí‚¤ì§€ ì•Šìœ¼ë©´ sequenceê°’ì´ ì¦ê°€í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì¶©ëŒë°œìƒí•¨.
```sql
call next value for hibernate_sequence;
```

`@GeneratedValue` ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ë‹¤ë©´, ë‹¤ìŒê³¼ ê°™ì´ í•´ì•¼í•¨.
```sql
call next value for hibernate_sequence;
insert into user (`id`, `name`, `email`, `created_at`, `updated_at`) values (1, 'martin', 'martin@fastcampus.com', now(), now());

call next value for hibernate_sequence;
insert into user ....

```

- `@GeneratedValue(strategy = GenerationType.IDENTITY)`ì¼ë•Œ, idê°’ì€ ë„£ì§€ ì•ŠìŒ.
```sql
insert into user (name, email, created_at, updated_at) values ('Timbs', 'ztimbs0@1und1.de', '2022-09-05 10:09:55', '2023-03-06 23:08:47');
```

## data.sqlì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„¸íŒ…
[[Spring-errorí•´ê²°] data.sqlì„ ë§Œë“¤ ë•Œ ì—ëŸ¬ (velog.io)](https://velog.io/@99winnmin/Spring-error%ED%95%B4%EA%B2%B0-data.sql%EC%9D%84-%EB%A7%8C%EB%93%A4-%EB%95%8C-%EC%97%90%EB%9F%AC)
[[JPA] SpringBoot 2.5 ì´í›„ë¶€í„° data.sql ì´ˆê¸°í™” ì‹œì  (tistory.com)](https://blogshine.tistory.com/437)
[How to use Hibernate identifier sequence generators properly](https://ntsim.uk/posts/how-to-use-hibernate-identifier-sequence-generators-properly)


application.ymlì— ë‹¤ìŒ ì„¤ì •ì¶”ê°€
```yaml
spring:
	jpa:
    	defer-datasource-initialization: true

sql:  
  init:  
    mode: always  
    ## ë°‘ì—ëŠ” ìƒí™©ì— ë§ê²Œ ì„ íƒí•´ì„œ ì‚¬ìš©í•˜ì
    schema-locations: data.sql  
    data-locations: data.sql
    data-locations: initSetting/*.sql
```
1. `spring.jpa.defer-datasource-initialization: true`
ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œì ì— **ë°ì´í„° ì†ŒìŠ¤ì˜ ì´ˆê¸°í™”ë¥¼ ì§€ì—°ì‹œí‚¤ëŠ” ì„¤ì •**ì…ë‹ˆë‹¤. `true`ë¡œ ì„¤ì •í•˜ë©´, Hibernateê°€ ìŠ¤í‚¤ë§ˆë¥¼ ìƒì„±í•œ í›„ì— ë°ì´í„° ì†ŒìŠ¤ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ JPA ì—”í‹°í‹° ê¸°ë°˜ì˜ SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œ, í•´ë‹¹ ì—”í‹°í‹°ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì„ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

2. `sql.init.mode: always`
SQL **ì´ˆê¸°í™” ëª¨ë“œë¥¼ ì„¤ì •**í•©ë‹ˆë‹¤. `always`ë¡œ ì„¤ì •í•˜ë©´, ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œì‘í•  ë•Œë§ˆë‹¤ SQL ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.

3. `sql.init.schema-locations: data.sql`
**ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ì˜ ìœ„ì¹˜ë¥¼ ì„¤ì •**í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ "ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™”"ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ í…Œì´ë¸” êµ¬ì¡°ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ë³€ê²½í•˜ëŠ” ì‘ì—…ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ì—ëŠ” `CREATE TABLE`, `ALTER TABLE` ë“±ì˜ **DDL ëª…ë ¹**ì´ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

4. `sql.init.data-locations: data.sql, initSetting/*.sql`
**ë°ì´í„° ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ì˜ ìœ„ì¹˜ë¥¼ ì„¤ì •**í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ "ë°ì´í„° ì ì¬"ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ **í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ì…ë ¥í•˜ëŠ” ì‘ì—…**ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. `INSERT INTO` ë“±ì˜ **DMLëª…ë ¹**ì´ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
`data.sql` íŒŒì¼ê³¼ `initSetting` ë””ë ‰í† ë¦¬ ì•„ë˜ì˜ ëª¨ë“  `.sql` íŒŒì¼ì„ ë°ì´í„° ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ë¡œ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤