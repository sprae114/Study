#트랜잭션, 

#인프런스프링DB1편03

----

# 트랜잭션
page.47
#### 트랜잭션을 사용하는 이유는 뭘까?✔
- 하나의 논리적인 작업의 단위이기 때문에, **여러개의 작업을 하나의 논리적인 단위로 묶어서 반영과 복구를 조정**할 수 있기 위해 사용
- 예시) 계좌이체 도중 오류가 났다면? 트랜잭션을 사용하지 않은 경우 출금은 됐지만 입금이 안되는 경우 발생할 수 있음.

####  트랜잭션 ACID은?✔
- 원자성(Atomicity)
트랜잭션 내에서 실행한 작업들은 마치 **하나의 작업인 것처럼** 모두 성공 하거나 모두 실패해야한다.  

- 일관성(Consistency)
모든 트랜잭션은 일관성 있는 데이터베이스 상태를 유지해야 한다. 예를 들어 데이터베이스에서 정한 **무결성 제약 조건**을 항상 만족해야 한다.  

- 격리성(Isolation)
동시에 실행되는 트랜잭션들이 **서로에게 영향을 미치지 않도록 격리**한다. 예를 들어 동시에 같은 데이터를 수정하지 못하도록 해야 한다. 격리성은 동시성과 관련된 성능 이슈로 인해 트랜잭션 격리 수준 (Isolation level)을 선택할 수 있다.  

- 지속성(Durability)
트랜잭션을 성공적으로 끝내면 **그 결과가 항상 기록**되어야 한다. 중간에 시스템에 문제가 발생해도 데이터베이스 로그 등을 사용해서 성공한 트랜잭션 내용을 복구해야 한다.


#### 무결성 제약조건이란? 
출처 : [[DB 데이터베이스] 무결성 제약조건 ](https://iingang.github.io/posts/DB-Integrity-constraint/)
=> 데이터에 결함이 없는 상태, 즉 **데이터를 정확하고 일관되게 유지하는 것**을 의미로 다음과 같은 조간이 만족해야함.

1) 개체 무결성 : 기본키는 null 값이 될수 없음
2) 참조 무결성 : 외래키는 참조할 수 없는 값을 가질수 없음
3) 도메인 무결성 : 특정 속성값은 그 속성이 정의돈 도메인에 속한 값이어야함(enum과 같은 개념)
4) 키 무결성 : 릴레이션에는 최소한 하나의 키가 존재해야함.
5) null 무결성 : 특정 속성은 null값을 가질 수  없음
6) 고유 무결성 : 특정 속성값은 서로 달라야함.


####  서버는 DB에 어떻게 연결할까?✔
출처 : [[Oracle SQL] 트랜잭션, 세션, 데이터 정의어(DDL)](https://developer-alle.tistory.com/203)

![[Pasted image 20221203222930.png]]
- 웹 애플리케이션 서버(WAS)나 DB 접근 툴 같은 클라이언트를 사용해서 데이터베이스 서버에 접근함. **클라언트와 서버는 역할의 개념**이다!!  
- 데이터 베이스 서버은 커넥션을 통한 **모든 요청은 해당 세션**을 통해서 실행함.  
- 세션 종료하는 방법  
    - 트랜잭션을 시작하고, 커밋 또는 롤백을 통해 **트랜잭션을 종료**한다  
    - 사용자가 커넥션을 닫거나, 또는 DBA(DB 관리자)가 **세션을 강제로 종료**하면 세션은 종료된다.
-  세션이란? 데이터베이스 접속을 시작으로, 여러 작업을 수행한 후 접속 종료까지의 **전체 기간**을 의미한다.


#### (코드) 트랜잭션 계좌이체 예시
1) 두개의 다른 세션이 같은 테이블 값을 가지고 있게 만들기(기본설정)
![[Pasted image 20221203225610.png]]
```SQL
//데이터 초기화
set autocommit true;
delete from member;
insert into member(member_id, money) values ('oldId',10000);
```


2) 신규데이터 추가하면 해당 세션만 데이터 확인 가능
![[Pasted image 20221203225659.png]]
```SQL
//트랜잭션 시작
set autocommit false; //수동 커밋 모드
insert into member(member_id, money) values ('newId1',10000);
insert into member(member_id, money) values ('newId2',10000);
```


3) if 커밋하면? 다른 세션에서도 회원 테이블을 조회하면 신규 회원들을 확인할 수 있음.
![[Pasted image 20221203225738.png]]
```SQL
commit; //데이터베이스에 반영
```

4) if 롤백하면? 모두 트랜잭션을 시작하기 직전의 상태로 복구됨.
![[Pasted image 20221203225812.png]]
```SQL
rollback; //롤백으로 데이터베이스에 변경 사항을 반영하지 않는다.
```

5) if 오류가 발생하면
![[Pasted image 20221203230237.png]]
``` sql
set autocommit false;
update member set money=10000 - 2000 where member_id = 'memberA'; 
//쿼리 예외발생
update member set money=10000 + 2000 where member_iddd = 'memberB'; 
```
- memberA 의 돈은 2000원 줄어들었지만, memberB 의 돈은 2000원 증가하지 않았다는 점이다. 결과적으로 계좌이체는 실패하고 memberA 의 돈만 2000원 줄어든 상황.  
- 이때 강제로 커밋하면, 문제상황 유지  
- 롤백하면 원래 데이터로 복구


####  커밋하지 않은 데이터를 다른 곳에서 조회할 수 있으면 어떤 문제가 발생할까?
- **데이터 정합성**에 큰 문제가 발생  
- 예) A세션이 임시 상태에 있는 데이터 만들었다. 해당 데이터를 B세션이 데이터를 변경하고 저장했지만, A세션이 롤백하면 데이터 사라짐.


#### 정합성과 무결성의 차이는?✔
출처 : [무결성과 정합성이란 무엇인가? (velog.io)](https://velog.io/@yangsijun528/%EB%AC%B4%EA%B2%B0%EC%84%B1%EA%B3%BC-%EC%A0%95%ED%95%A9%EC%84%B1%EC%9D%B4%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%B8%EA%B0%80)

- 정합성(Consistency)
데이터베이스의 **모든 데이터가 일관된 상태를 유지**해야 한다는 원칙을 의미합니다. 즉, 데이터베이스의 상태는 특정 규칙을 만족해야 합니다. 
예를 들어, 은행 계좌 이체를 생각해보면, 송금자 계좌에서 돈이 빠져나가고 수신자 계좌에 돈이 들어가는 과정에서 전체 시스템의 잔액은 변하지 않아야 합니다. 이처럼 모든 거래가 완료된 후에도 데이터베이스의 상태가 일관성을 유지하는 것을 정합성이라고 합니다.

- 무결성(Integrity)
데이터의 정확성과 일관성을 보장하는 **규칙이나 제약 조건**을 의미합니다. 무결성 제약 조건은 데이터베이스에 들어갈 데이터의 유효성을 검사하며, 이를 통해 데이터베이스의 데이터가 손상되는 것을 방지합니다. 
예를 들어, '나이' 필드에는 음수가 들어갈 수 없다거나, '이메일' 필드는 특정한 형식을 따라야 한다는 등의 제약 조건을 설정할 수 있습니다. 이러한 제약 조건을 만족하는 데이터만 데이터베이스에 저장될 수 있게 하여 무결성을 보장합니다.

- 정합성 O, 무결성 X 예시
상품 A가 10개 남아있을 때, 두 명의 고객이 동시에 상품 A를 각각 7개씩 주문했다고 가정합시다. 두 주문을 모두 처리하기 위해 시스템은 상품 A의 재고를 -4개로 업데이트합니다. 이 경우, 상품 갯수가 음수로 무결성이 깨진 경우입니다.
![[Pasted image 20231026192332.png]]

- 정합성 X, 무결성 O 예시
고객 A가 고객 B에게 1000원을 보낸다고 가정해보자. 고객 A의 계좌에서 1000원이 차감되었지만, 고객 B의 계좌에 이 돈이 더해지지 않았습니다. 이 경우, 전체 시스템의 잔고가 정확하게 반영되지 않았으므로, 이는 정합성이 깨진 경우입니다.
![[Pasted image 20231026192337.png]]


#### 자동커밋 VS 수동 커밋
- 수동 커밋 모드나 자동 커밋 모드는 한번 설정하면 해당 세션에서는 계속 유지된다. 중간에 변경하는 것은 가능

▶자동 커밋 설정
``` SQL
set autocommit true; //자동 커밋 모드 설정
insert into member(member_id, money) values ('data1',10000);
insert into member(member_id, money) values ('data2',10000);
```
장점 : 커밋이나 롤백을 직접 호출하지 않아도 되는 편리함.
단점 : 원하는 트랜잭션 기능을 제대로 사용할 수 없음.

▶수동 커밋 설정
``` SQL
set autocommit false;
insert into member(member_id, money) values ('data1',10000);
insert into member(member_id, money) values ('data2',10000);
commit; //수동 커밋
```
장점 : 트랙젹션 기능 사용.
단점 : 커밋/롤백을 일일히 쳐줘야함.
