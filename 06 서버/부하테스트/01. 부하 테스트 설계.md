# 1. 부하 테스트 설계 시 고려해야 할 요소
부하 테스트의 지속 시간과 사용자 수를 결정하기 위해 다음 요소를 분석해야 합니다

✅ 테스트 목표
  - **성능 확인**: 애플리케이션이 특정 부하에서 정상 작동하는지 확인.
  - **병목 지점 파악**: CPU, 메모리, 네트워크, 데이터베이스 등의 병목 지점을 찾음.
  - **스케일링 테스트**: 최대 사용자 수와 처리량을 측정.
  - **안정성 테스트**: 장시간 안정적으로 동작하는지 확인(예: 메모리 누수).

✅ 예상 트래픽
  - 실제 사용자 수(DAU, MAU)와 피크 시간대의 동시 접속자 수를 고려.
  - 예: 웹사이트가 하루 10,000명 방문하고 피크 시간에 500명이 동시 접속한다면, 이를 기준으로 설정.

✅ 서비스 수준 목표(SLO/SLA)
  - 응답 시간(예: 95% 요청이 200ms 이내), 오류율(예: 0.1% 이하), 초당 요청 수(RPS)를 정의.
  - Grafana 대시보드에서 `http_req_duration`과 같은 메트릭으로 이를 모니터링.

✅ 인프라 리소스
  - `docker-compose.yml`에 정의된 `influxdb`, `grafana`, `k6` 컨테이너와 애플리케이션 서버(`app`)의 CPU/메모리 제한.
  
---

# 2. 부하 테스트 지속 시간 권장
지속 시간은 테스트 유형과 목표에 따라 달라집니다. 아래는 일반적인 권장 사항입니다:

## 부하 테스트 (Load Test)
- 목적: 정상 트래픽에서 성능 확인.
- VU: 예상 피크 트래픽의 80~100% (예: 200 VU for 200 RPS).
- 지속 시간: 10~20분.
```js
stages: [
  { duration: '2m', target: 200 },  // 2분 동안 200명
  { duration: '10m', target: 200 }, // 10분 유지
  { duration: '2m', target: 0 },    // 2분 감소
]
```

## 스트레스 테스트 (Stress Test)
- 목적: 시스템 한계 파악.
- VU: 피크 트래픽의 2~3배 (예: 600 VU for 200 RPS 정상 트래픽).
- 지속 시간: 15~30분.
```js
stages: [
  { duration: '5m', target: 600 },  // 5분 동안 600명
  { duration: '15m', target: 600 }, // 15분 유지
  { duration: '5m', target: 0 },    // 5분 감소
]
```


##  스파이크 테스트 (Spike Test)
- 목적: 갑작스러운 트래픽 급등 시뮬레이션.
  - VU: 정상 트래픽의 5~10배, 짧은 시간 유지 (예: 1000 VU for 10초).
  - 지속 시간: 1~5분.
```js
stages: [
  { duration: '10s', target: 1000 }, // 10초 동안 1000명
  { duration: '30s', target: 1000 }, // 30초 유지
  { duration: '10s', target: 0 },    // 10초 감소
]
```
빠른 성능 점검, 초기 병목 지점 파악, CI/CD 파이프라인 내 테스트.


## 소크 테스트 (Soak Test)
- 목적: 장시간 안정성 확인.
  - VU: 정상 트래픽 수준 (예: 200 VU).
  - 지속 시간: 2~12시간.
```js
stages: [
  { duration: '10m', target: 200 }, // 10분 동안 200명
  { duration: '6h', target: 200 },  // 6시간 유지
  { duration: '10m', target: 0 },   // 10분 감소
]
```
- **모니터링**: `docker stats`로 메모리 증가, InfluxDB 디스크 사용량 확인.


# 3. 사용자 수(VUs) 권장
사용자 수는 애플리케이션의 예상 동시 접속자와 처리량(RPS, Requests Per Second)을 기반으로 결정합니다.
✅ RPS 계산
- 실제 트래픽 데이터(예: 웹 로그, Google Analytics)에서 피크 시간대의 RPS를 추정.
- 예: 피크 시간대에 500명 동시 접속, 평균 2초마다 1 요청 → `500 / 2 = 250 RPS`.

✅ VU 계산
- k6에서 1 VU는 초당 1~2 요청을 처리(스크립트의 `sleep` 설정에 따라 다름).
- 예: `sleep(1)` 설정 시 1 VU ≈ 1 RPS.
- 250 RPS를 시뮬레이션하려면 약 250~300 VU 필요.


# 4. Docker 환경 리소스 제한 하기
- **k6 리소스**:
  - k6는 VU가 많아질수록 CPU 사용량이 증가합니다. `docker stats`로 k6 컨테이너의 CPU 사용량을 모니터링하고, 500 VU 이상에서는 `deploy` 섹션으로 CPU 제한 설정:
```yaml
k6:
  deploy:
	resources:
	  limits:
		cpus: '2.0'
		memory: 1G
```

- **InfluxDB 리소스**:
  - 대량의 메트릭 데이터가 저장되므로, InfluxDB의 디스크 I/O와 메모리 사용량 확인:
    ```bash
    docker stats myproject_influxdb_1
    ```
  - 긴 테스트(12시간 이상)에서는 `influxdb-data` 볼륨의 디스크 공간 확인:
    ```bash
    docker volume inspect myproject_influxdb-data
    ```

- **Grafana 성능**:
  - Grafana는 대시보드 쿼리로 인해 CPU/메모리가 증가할 수 있음. `http_req_duration` 등 메트릭이 많을 경우 쿼리 최적화 필요.
  - `docker stats myproject_grafana_1`로 확인.

- **네트워크**:
  - `http://app:8080/api/health`가 외부 서버라면 네트워크 대역폭 확인.
  - Docker 내부 통신(`influxdb:8086`)은 문제없으나, 대량 데이터 전송 시 지연 가능성 점검.


### 8. **추가 팁**
- **테스트 스크립트 최적화**:
  - `sleep(1)`은 1 VU당 1 RPS를 보장. 더 높은 RPS가 필요하면 `sleep(0.5)`로 조정.
  - 복잡한 요청(POST, 인증) 추가 시 VU당 RPS 감소 예상.

- **분산 테스트**:
  - 1000 VU 이상은 단일 k6 컨테이너로 어렵습니다. k6 Cloud 또는 여러 k6 인스턴스 사용:
```yaml
k6:
  image: grafana/k6
  scale: 3  # 3개 k6 컨테이너 실행
```

- **실제 데이터 활용**:
  - 웹 로그에서 피크 시간대 트래픽 분석(예: Nginx/Apache 로그).
  - Google Analytics로 동시 접속자 수 추정.

---

### 최종 권장
- **초기 테스트**:
  - VU: 50~100.
  - 지속 시간: 2~5분.
  - 목적: 설정 점검, 병목 파악.
- **프로덕션 테스트**:
  - VU: 실제 트래픽(예: 150 RPS → 150 VU).
  - 지속 시간: 15~30분.
  - 목적: 정상 트래픽 성능 확인.
- **안정성 테스트**:
  - VU: 실제 트래픽.
  - 지속 시간: 2~6시간.
  - 목적: 장시간 안정성 확인.
- **스트레스 테스트**:
  - VU: 실제 트래픽의 2~3배.
  - 지속 시간: 20~30분.
  - 목적: 한계 파악.
