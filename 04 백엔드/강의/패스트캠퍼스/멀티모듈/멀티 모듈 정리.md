# 초기설정
1) src폴더 삭제

2) api 모듈 만들기
[first 묘듈 생성](https://github.com/sprae114/multi-module/commit/afa4585086a51d68106a57a06508b06b9354c1fd)

3) common 모듈 만들기
[common모듈도 이전과 같이 진행 + Application 제거](https://github.com/sprae114/multi-module/commit/dcc507fcaefb6ce30af9793b262cc98b9d8bfd5f)

4) 루트 gradle에 어떤 모듈 가지고 있는지 알려주기
[루트에 가지고 있는 모듈 추가](https://github.com/sprae114/multi-module/commit/6894f301611d85ce8d95087ac2618960c63c477b)

5) 실행 모듈에 의존성 추가하기
[common-module을 의존성으로 추가](https://github.com/sprae114/multi-module/commit/7d8cb94b4144cf61adad2509d26e3a69be8e0100)

# 주입하기
## enum 테스트해보기
common에 enunm을 생성한 후, first-module에서 사용할 수 있는지 테스트
[enum 의존성 테스트 하기](https://github.com/sprae114/multi-module/commit/2c037aebcb63f3524919a9b08353b8c6d822bd24)

## Bean 테스트해보기
service를 추가해서 first에 의존성 주입해서 출력하려 했지만 오류 발생함.
그 이유는 first 컨텍스트에 common이 주입이 안되서 찾지 못하는 문제가 발생함.

해결방법
1) aplication을 상위로 옮겨 더 넓은 범위에 탐색 가능하도록 하기
[bean을 사용한 의존성 테스트](https://github.com/sprae114/multi-module/commit/64c508c183ed1e1f564aeb0b612b105dd8fb1327)

2) 컴포넌트 스캔 범위 추가해주기
[component 스캔하는 방법](https://github.com/sprae114/multi-module/commit/e3609b23231cb31d1615e71305f7d07d04f0f2d4)


# 예외처리
예외처리를 하기 위해서 응답코드, 응답 메시지 등.. 이런 정보가 나타나게 공통화해보자.
[예외 처리 하는 방법](https://github.com/sprae114/multi-module/commit/1663043a33a60f41d688e140ad30a2edf6c783de)


# DB 연동
[공통 module에 DB연동하는 방법 · sprae114/multi-module@977f202 (github.com)](https://github.com/sprae114/multi-module/commit/977f202028fa3f552617ffef1f15bd294390c16c)
1) gradle 및 yml 설정
▶Mysql 설정 참고
```yml
spring:  
  main:  
    allow-bean-definition-overriding: true  
  datasource:  
    url: jdbc:mysql://{{HOST}}:{{PORT}}/{{DATABASE_NAME}}  
    username: {{USER_NAME}}  
    password: {{PASSWORD}}  
    driver-class-name: com.mysql.cj.jdbc.Driver  
  jpa:  
    database: mysql  
    database-platform: org.hibernate.dialect.MySQL5InnoDBDialect  
    hibernate:  
      ddl-auto: none # or `create`  
    properties:  
      hibernate:  
        show_sql: true # to System OutDataSourceConfiguration  
        format_sql: true  
        use_sql_comments: true  
        jdbc:  
          time_zone: Asia/Seoul # @CreatedDate 필드의 Time Zone 값 설정
```

▶gradle 실수 조심
api가 아닌 implementation로 선언하면 dev.be.moduleapi.service. DemoService.memberRepository가 JpaRepository의 메소드를 사용하지 못한다. 
```
//잘못된 방식
implementation 'org.springframework.boot:spring-boot-starter-data-jpa'

//바꾼 방식
api 'org.springframework.boot:spring-boot-starter-data-jpa'
```

**api 키워드를 사용하기 위해**선 2가지 중 1가지 방법으로 선언을 해야 한다.  
- api를 사용하려는 build.gradle의 plugins에 `id 'java-library'` 추가  

- 상위 모듈(=root)에서 'java-library' 추가  
```
subprojects {  
apply plugin: 'java-library'}
```

2) 엔티티, 리포지토리 만들기
3) 스캔할 수 있게 범위 지정하기 -> 빈과 마찬가지로 범위 설정해야함.


# jar 파일 만들기
운영에서 jar파일로 실행 시키기 위해 필요한 설정
[jar파일로 실행시키기](https://github.com/sprae114/multi-module/commit/25f928d13c2b6d2084be971db676145c8b108015)

## tasks.bootJar { enabled = false }

tasks.bootJar 기본 값 : true임. `bootJar` 옵션을 true로 설정하면 'xxx.jar' 파일이 생성된다.  
ex) module-common-0.0.1-SNAPSHOT.jar  

이렇게 생성된 'jar' 파일은 그 파일 안에 Application을 실행시키는 데 필요한 `dependencies / classes / resources`을 포함하고 있어 `java -jar` 옵션으로 jar 파일을 실행시킬 수 있다.  
  
그런데 Common Module은 다른 Module에서 참조하는 목적의 Module이므로 실행 가능한 jar 파일을 생성할 필요가 없다. ex) `ModuleCommonApplication.class`는 존재 X. 그러므로 Common Module에서는 bootJar 옵션값을 false로 설정한다.  
  
만약 bootJar 옵션을 true로 주면 Main.class를 찾게 되는데 Common Module에서는 Api Module처럼 ModuleApiApplication.class가 없으므로 다음과 같은 에러가 발생한다.  
ex) `Caused by: org.gradle.api.InvalidUserDataException: Main class name has not been configured and it could not be resolved`


## tasks.jar { enabled = true }
tasks.jar 기본 값 : true임. `jar` 옵션을 true로 설정하면 'xxx-plain.jar' 파일이 생성된다.  
ex) module-common-0.0.1-SNAPSHOT-plain.jar  

이렇게 생성된 '-plain.jar' 파일은 'jar' 파일과는 다르게 'dependencies'를 제외한 classes / resources만을 포함하고 있어 `java -jar` 옵션으로 jar 파일을 실행시킬 수 없다.  
  
Common Module에서는 Api Module에서 사용할 classes / resources] 존재하면 되므로  
jar 옵션값을 true로 설정한다.


## Gradle 빌드 명령어
- root project에서 Gradle 빌드 명령어를 실행한다.  
ex) pwd 입력 시 "$HOME/xxx/yyy/Spring-Boot-2.7.1-Multi-Module-Template"

- Api module을 실행시킬 jar 파일이 생성된 경로로 이동한다.  
 ex) cd module-api/build/libs/
 
- 해당 Path로 이동 후 java -jar 명령어를 실행한다.  
ex) java -jar module-api-0.0.1-SNAPSHOT.jar  


▶Multi Module에서 Gradle 빌드 명령어 + jar 파일 실행 CLI
- Gradle 빌드 명령어 :: root project  
`./gradlew clean :module-api:buildNeeded --stacktrace --info --refresh-dependencies -x test
`
- profile 지정 X  
`java -jar module-api-0.0.1-SNAPSHOT.jar`

- profile 지정 O 
`java -jar -Dspring.profiles.active=local module-api-0.0.1-SNAPSHOT.jar`

# profile 설정
1) 두개의 프로파일 설정 만들기
[profile 설정](https://github.com/sprae114/multi-module/commit/bc7430ab7bdadb75a7311fb45b8d706925639f36)

2) 적용할 프로파일 설정
![[Pasted image 20230820133844.png]]
![[Pasted image 20230820133929.png]]

# security에서 사용된 멀티모듈
## root
- setting.gradle
```java
["comp", "web", "server"].each {  //각 요소에 대해 반복문을 수행

	//rootDir과 리스트의 각 요소를 결합하여 새 경로를 만듭니다.
    def compDir = new File(rootDir, it) 
    if(!compDir.exists()){  //해당 경로가 존재하지 않으면 해당 경로의 디렉토리를 생성
        compDir.mkdirs()  
    }  

	//`compDir` 아래의 모든 서브디렉터리에 대해 반복문을 수행합
    compDir.eachDir {subDir -> 

		//서브디렉터리 내에 `build.gradle` 파일 경로를 생성합니다.
        def gradleFile = new File(subDir.absolutePath, "build.gradle")  
        //`build.gradle` 파일이 없다면 새롭게 생성하고 초기화하는 작업을 수행
        if(!gradleFile.exists()){  
            gradleFile.text = """dependencies {}""".stripIndent(20)}  
    //이 리스트 부분에서는 주어진 소스 및 테스트 디렉터리 구조를 생성하는 작업을 수행
        [  
                "src/main/java/com/sp/fc",  
                "src/main/resources",  
                "src/test/java/com/sp/fc",  
                "src/test/resources"  
        ].each {srcDir->  
            def srcFolder = new File(subDir.absolutePath, srcDir)  
            if(!srcFolder.exists()){  
                srcFolder.mkdirs()  
            }  
        }  
  
        def projectName = ":${it}-${subDir.name}";  
        //현재 반복 중인 하위 프로젝트 이름을 포함시켜 전체 프로젝트에 등록시켜줍니다.
        include projectName 
        //등록한 하위 프로젝트의 위치(directory)를 설정해줍니다.
        project(projectName).projectDir = subDir  
    }  
}
```

- build.gradle
```java
...

//이 섹션에서는 모든 서브 프로젝트에 공통으로 적용될 설정들을 정의
allprojects {  
    group = "com.sp.fc"  
    version = "1.0.0"  
  
}

//이 섹션에서는 각각의 서브 프로젝트에 대한 설정을 정의합니다.
subprojects {  
  
    apply plugin: "java"  
    apply plugin: boot  
    apply plugin: "io.spring.dependency-management"  
    apply plugin: "idea"  
  
    repositories {  
        mavenCentral()  
    }  
  
    configurations {  
        developmentOnly  
        runtimeClasspath {  
            extendsFrom developmentOnly  
        }  
    }  
    dependencies {  
        developmentOnly("$boot:spring-boot-devtools")  
        implementation "$boot:spring-boot-starter-security"  
        implementation 'com.fasterxml.jackson.core:jackson-annotations'  
  
        compileOnly lombok  
        testCompileOnly lombok  
        annotationProcessor lombok  
        testAnnotationProcessor lombok  
  
        testImplementation "$boot:spring-boot-starter-test"  
    }  
  
    test {  
        useJUnitPlatform()  
    }
}

//["comp", "web"]와 ["server"] 반복문은 각각 comp, web, server라는 이름을 가진 하위 디렉토리를 순회하며, 그 안에 있는 각각의 서브 디렉토리를 하나의 Gradle 프로젝트로 취급하고 있습니다.
["comp", "web"].each {  
    def subProjectDir = new File(projectDir, it)  
    subProjectDir.eachDir {dir->  
        def projectName = ":${it}-${dir.name}"  
        project(projectName){  
            bootJar.enabled(false)  
            jar.enabled(true)  
        }  
    }
}  
["server"].each {  
    def subProjectDir = new File(projectDir, it)  
    subProjectDir.eachDir {dir->  
        def projectName = ":${it}-${dir.name}"  
        project(projectName){  
  
        }
    }
}  
  
help.enabled(false)
```