
#매핑, #Post

#인프런MVC_1편

inflearn-mvc1/mapping

----
#인프런MVC_1편03(page. )
# Post
## Post 매핑이란?


## Post 매핑 구현 단계
1) `@PostMapping`으로 어떤 URL post 매핑할지 정하기
2) 해당 매핑 요청받을지 구현하기(model에 값 전달 포함)
3) 반환값을 view, json, redirect 할지 정하기

![[Untitled 3.png]]



# 요청 하기
#### 1) URL로 요청하기
💥인터넷에 URL로 요청하면 GET으로 처리됌. 그래서 postman을 써서 요청해야함.
- URL로 요청하기
![[Pasted image 20230112150206.png]]


#### 2) Body로 요청하기
- 바디에 직접 입력
![[Untitled 2.png]]


#### 3) Html로 요청하기
- input버튼으로 요청하는 방법
출처 : [코딩의 시작, TCP School](http://www.tcpschool.com/html-tag-attrs/form-action), [HTML DOM Form Object (w3schools.com)](https://www.w3schools.com/jsref/dom_obj_form.asp)
```html
<!-- 생략 -->
<form action="/request-param-v1" method="post">
		username: <input type="text" name="username" />
		age: <input type="text" name="age" />
		<button type="submit">전송</button>
</form>
<!-- 생략 -->
```
    
- 어떻게 전송되는 거지?
출처 : [th:action, th:onclick 차이 - 인프런 | 질문 & 답변 (inflearn.com)](https://www.inflearn.com/questions/522237/th-action-th-onclick-%EC%B0%A8%EC%9D%B4)
	onclick ->  클릭 시 발생할 메서드(이벤트)를 지정
    action → `<form>`태그에서 사용하는 속성으로 서식 데이터(form data)를 서버로 보낼 때 해당 데이터가 도착할 URL을 지정
    method → 동작 메소드 알려줌
    submit → 버튼을 통해 post 방식으로 th:action 요청함.


#### 4) Json로 요청하기
- Postman으로 Json 요청
![[Untitled 1.png]]


# 요청 받기

## @RequestParam
String, int, Long을 요청 파라미터로 받을 때 사용함.

#### 기본값
```java
@ResponseBody  
@PostMapping("/request-param-basic")  
public String postBasic(  
        @RequestParam String username,  
        @RequestParam int age) {  
  
    log.info("postBasic : username = {}, age={}", username, age);  
  
    return "post-basic username = " + username + " , " + age;  
}
```


#### 옵션
```java
@ResponseBody  
@PostMapping("/request-param-default")  
public String requestParamDefault(  
        @RequestParam(required = true, defaultValue = "guest") String username,  
        @RequestParam(required = false, defaultValue = "-1") int age) {  
  
    log.info("ParamDefault : username = {}, age={}", username, age);  
  
    return username + " , " + age;  
}
```
- required,는 필수 값, defaultValue는 기본 값
required는 파라미터가 true면 요청 파라미터에 꼭 있어하는 것, false면 요청 파라미터에 없어도 되는 것
defaultValue는 값을 입력하지 않을 때, 기본 값 지정함.


#### Model O
```java
@PostMapping("/request-param-model")  
public String requestParamModel(  
        @RequestParam String username,  
        @RequestParam int age,  
        Model model) {  
  
    model.addAttribute("username", username);  
    model.addAttribute("age", age);  
  
    return "checkUser";  
}
```


## @ModelAttribute
#### 기본값
1)과 같은 의미지만 입력에서 객체를 받을수 있게함.
```java
@PostMapping("/request-ModelAttribute")  
public User requestModelAttribute(  
        @ModelAttribute User user,  
        Model model) {  
  
    model.addAttribute("username", user.getUsername());  
    model.addAttribute("age", user.getAge());  
  
    return user;  
}
```

▶@ModelAttribute의 역할
1. 파라미터를 요청 받기   ex) `@RequestParam String itemName`
2. 객체 생성하기   ex) `Item item = new Item();`
3. 객체에 파라미터 넣기 ex) `item.setItemName(itemName);`
4. model에 넣어서 view에 넘겨주기 ex) `model.addAttribute("item", item);`


## @PathVariable
URI 경로에 파라미터의 따라 변경하고 싶을 때

#### 단일 경로
요청 매핑 : `http://localhost:8080/mapping/kang`

```java
@ResponseBody  
@PostMapping("/mapping/{data}")  
public String mappingPath(@PathVariable String data) {  
    log.info("mappingPath userId={}", data);  
    return "data : " + data;  
}
```


#### 다중 경로
요청 매핑 :  `http://localhost:8080/mapping/kang/2`

```java
@ResponseBody  
@PostMapping("/mapping/{data}/{num}")  
public String mappingPath(@PathVariable String data, @PathVariable int num) {  
    log.info("mappingPath userId={} {}", data, num);  
    return "data, num : " + data + " , " + num;  
}
```


## @RequestBody
#### @RequestBody란?
출처 : https://mangkyu.tistory.com/72

- Json(application/json) 형태의 **HTTP Body 데이터**를 MessageConverter를 통해 **Java 객체로 변환**시킴
- 기본 생성자로 객체를 만들고, Getter나 Setter 등의 메소드로 필드를 찾아 Reflection으로 값을 설정함
- **HTTP 메시지 바디**를 통해서 데이터가 넘어올 때는 기존의 방식을 사용할 수가 없음.


#### 기본값
```java
@ResponseBody  
@PostMapping("/requestBody-user")  
public User requestBodyObject2(@RequestBody User user) {  
    log.info("username={}, age={}", user.getUsername(), user.getAge());  
    return user;  
}
```


## HttpEntity <>
#### HttpEntity란?
- **HTTP 메시지 바디**를 통해서 데이터가 넘어올때 사용함.
- **HttpEntity 를 사용하여 header, body의 정보를 편리하게 조회**
- HttpEntity , @RequestBody 를 사용하면 HTTP 메시지 컨버터가 HTTP 메시지 바디의 내용을 우리가 원하는 문자나 객체 등으로 변환해줌.
- HttpEntity는 **응답에도 사용 가능 메시지 바디 정보 직접 반환.  view 조회X**


#### 기본값
```java
@ResponseBody  
@PostMapping("/httpEntity")  
public HttpEntity<String> requestBodyStringV3(HttpEntity<String> httpEntity) throws IOException {  
    HttpHeaders headers = httpEntity.getHeaders();  
    String body = httpEntity.getBody();  
  
    log.info("messageBody={}", headers);  
    log.info("messageBody={}", body);  
  
    return new HttpEntity<>("User added successfully!", headers);  
}
```



# 응답 하기

## 1) redirect 반환
#### redirect 사용 X
post -> view를 리턴하면 멱등성 문제가 발생함.
```java

```


#### redirect 사용 O
resources에 있는 html의 이름이 매칭하여 view를 찾고 랜더링함. Post 방식은 멱등이 되지 않기 때문에 새로고침하면 결과에 영향을 줌. 따라서 redirect로 반환해야함.

Controller
```java
@PostMapping("/new-form")
public String newForm() {return "new-form";}
```


---

## 2) json 반환
view를 찾는 것이 아니라, Http 메시지 바디에 바로 입력함.

- json으로 응답하기
```java
@RequestBody
@PostMapping("/hello-go")
public String helloBasic() {return "ok";}
```
- @RestController , @ResponseBody 의 공통된 역할은?
	- 반환 값으로 뷰를 찾는것이 아니라, HTTP 메시지 바디에 바로 입력하여 보낸다.

## 3) HTTP 응답

- ResponseEntity<> 를 이용한 응답
    HttpEntity는 HTTP 메시지의 헤더, 바디 정보를 가지고 있다
```java
@PostMapping("/response-body-string-v2")
public ResponseEntity<String> responseBodyV2() {
	return new ResponseEntity<>("ok", HttpStatus.OK);
}
```


# 이론
## Redirect에 대해서
mvc1편 page.216
#### 리다이랙션이란?
**re(다시) + 지시하다(direct) 다시 지시하는 것**을 말한다.  
예를 들어 브라우저가 `www.webstone.com/blogA` URL을 웹 서버에 요청했다고 하자. 그러면 서버는 HTTP 응답 메시지를 통해 "`www.webstone.com/blogB`로 다시 요청해봐!~" 라고 브라우저에게 **다른 URL(길, 방향) 을 지시할 수 있는 것을 리다이렉트**라 한다.
![[Pasted image 20230127091621.png]]
  

#### 상품 수정할때 리다이렉션?
상품 수정후에 다시 해당 상품페이지로 가기 위해 리다이렉션이 필요함. ex) 처방을 받은 이후, 개발자 A라는 이름을 알려주고 처방전을 받아야함.


#### PRG Post/Redirect/Get 가 왜 필요할까?
상품 등록 후, 웹 브라우저의 **새로고침을 하면 상품이 계속 등록되는 문제점**(POST 멱등문제)

- 그림
![[Pasted image 20230119121019.png]]

- 코드
```java
@PostMapping ("/add")
public String addItemV4 (Item item) {
	itemRepository.save(item);
	return "basic/item";
}
```


#### 해결법은?
상품 저장 후에 뷰 템플릿으로 이동하는 것이 아니라, 상품 상세 화면으로 **리다이렉트를 호출**해주면 된다. 이러면 상품 저장 후에 실제 상품 상세 화면으로 다시 이동

- 그림
![[Pasted image 20230119121320.png]]

- 코드
```java
@PostMapping ("/add")
public String addItemV5 (Item item) {
	itemRepository.save(item);
	return "redirect: /basic/items/"
}
```

#### RedirectAttributes
상품을 저장하고 상품 상세 화면으로 리다이렉트했는데, 잘 저장되었는지 알 수가 없음.

- controller 변경
```java
@PostMapping("/add") 
public String addItemV6(Item item, RedirectAttributes redirectAttributes) { 
	Item savedItem = itemRepository.save(item); 
	redirectAttributes.addAttribute("itemId", savedItem.getId()); 
	redirectAttributes.addAttribute("status", true); 
	
	return "redirect:/basic/items/{itemId}";
}
```
 PathVariable과 같이 값을 넘겨주고, 상태를 넘겨준다.

- 뷰 템플릿 추가
```html
<div class="container">
	<div class="py-5 text-center"> 
		<h2>상품 상세</h2>
	</div>

	<!-- 추가 --> 
	<h2 th:if="${param.status}" th:text="'저장 완료!'"></h2>
```

- 결과
![[Pasted image 20230119124105.png]]
