ë§í¬ : [[ìŠ¤í”„ë§ mvc 2í¸.pdf]] (page. 237)
í•´ì‹œíƒœí¬ : #ì˜ˆì™¸ì²˜ë¦¬, #ì˜¤ë¥˜í˜ì´ì§€

----
## ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ìœ„í•œ ë°°ê²½ì§€ì‹
#### ğŸ“Œìˆœìˆ˜ ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆëŠ” ì˜ˆì™¸ì²˜ë¦¬ ë‘ê°€ì§€ ë°©ë²•ì€?
â–¶ **Exception** (ì˜ˆì™¸)
**ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ì‚¬ìš©ì ìš”ì²­ë³„ë¡œ threadê°€ í• ë‹¹**ëœë‹¤. í•´ë‹¹ threadì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí–ˆëŠ”ë°, try - catchë¡œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ì§€ ëª»í•œë‹¤ë©´ í†°ìº£ ê°™ì€ WAS ê¹Œì§€ ì˜ˆì™¸ê°€ ì „ë‹¬ëœë‹¤.

- ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì „íŒŒ íë¦„
```
WAS(ì—¬ê¸°ê¹Œì§€ ì „íŒŒ) <- í•„í„° <- ì„œë¸”ë¦¿ <- ì¸í„°ì…‰í„° <- ì»¨íŠ¸ë¡¤ëŸ¬(ì˜ˆì™¸ë°œìƒ)
```

- ëŸ°íƒ€ì„ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ê³  ì˜ˆì™¸ì²˜ë¦¬ë¥¼ ëª»í•˜ë©´? 
```java
@Slf4j  
@Controller  
public class ServletExController {  
    @GetMapping("/error-ex")  
    public void errorEx() {  
        throw new RuntimeException("ì˜ˆì™¸ ë°œìƒ!");  
    }  
}
```
![[Pasted image 20230124132306.png]]
=> ì„œë²„ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê²ƒìœ¼ë¡œ ìƒê°í•´ì„œ HTTP ìƒíƒœ ì½”ë“œ 500 ë°˜í™˜.

- í•´ë‹¹ URLì´ ì—†ìœ¼ë©´?
![[Pasted image 20230124132413.png]]
=> í†°ìº£ì´ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” 404 ì˜¤ë¥˜ í™”ë©´ ë°˜í™˜.


â–¶ **response.sendError**(HTTP ìƒíƒœ ì½”ë“œ, ì˜¤ë¥˜ ë©”ì‹œì§€)
=>ì´ê²ƒì„ í˜¸ì¶œí•œë‹¤ê³  ë‹¹ì¥ ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ” ê²ƒì€ ì•„ë‹ˆì§€ë§Œ, **ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆì—ê²Œ `HTTP ìƒíƒœ ì½”ë“œ` ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤ëŠ” ì ì„ ì „ë‹¬**í•  ìˆ˜ ìˆë‹¤.

- sendError ì „íŒŒ íë¦„
```
WAS(sendError í˜¸ì¶œ ê¸°ë¡ í™•ì¸) <- í•„í„° <- ì„œë¸”ë¦¿ <- ì¸í„°ì…‰í„° <- ì»¨íŠ¸ë¡¤ëŸ¬
```

- response.sendErrorë¡œ ì˜¤ë¥˜ë°˜í™˜
```java
@Slf4j  
@Controller  
public class ServletExController {  
	
	...
	
    @GetMapping("/error-404")  
    public void error404(HttpServletResponse response) throws IOException {  
        response.sendError(404, "404 ì˜¤ë¥˜!");  
    }  
  
    @GetMapping("/error-400")  
    public void error400(HttpServletResponse response) throws IOException {  
        response.sendError(400, "400 ì˜¤ë¥˜!");  
    }  
  
    @GetMapping("/error-500")  
    public void error500(HttpServletResponse response) throws IOException {  
        response.sendError(500);  
    }  
}
```
=> `response.sendError()` ë¥¼ í˜¸ì¶œí•˜ë©´ response ë‚´ë¶€ì—ëŠ” **ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤ëŠ” ìƒíƒœë¥¼ ì €ì¥**í•´ë‘”ë‹¤. ê·¸ë¦¬ê³  ê³ ê°ì—ê²Œ ì‘ë‹µ ì „ì— í˜¸ì¶œë˜ì—ˆë‹¤ë©´ ì„¤ì •í•œ ì˜¤ë¥˜ ì½”ë“œì— ë§ì¶”ì–´ ê¸°ë³¸ ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ë³´ì—¬ì¤€ë‹¤.

- ê²°ê³¼
![[Pasted image 20230124133358.png]]
![[Pasted image 20230124133409.png]]

#### ğŸ“Œ (ì½”ë“œ) ì˜¤ë¥˜ í™”ë©´ ë§Œë“¤ê¸°
- ì˜ˆì™¸ ë°œìƒê³¼ ì˜¤ë¥˜ í˜ì´ì§€ ìš”ì²­ íë¦„
```
1. WAS(ì—¬ê¸°ê¹Œì§€ ì „íŒŒ) <- í•„í„° <- ì„œë¸”ë¦¿ <- ì¸í„°ì…‰í„° <- ì»¨íŠ¸ë¡¤ëŸ¬(ì˜ˆì™¸ë°œìƒ)
2. WAS `/error-page/500` ë‹¤ì‹œ ìš”ì²­ -> í•„í„° -> ì„œë¸”ë¦¿ -> ì¸í„°ì…‰í„° -> ì»¨íŠ¸ë¡¤ëŸ¬(/error- page/500) -> View
```

- ì„œë¸”ë¦¿ ì˜¤ë¥˜ í˜ì´ì§€ ë“±ë¡ 
=> **í•´ë‹¹ì˜¤ë¥˜ -> ì˜¤ë¥˜ ë§¤í•‘ìœ¼ë¡œ ë³€í™˜**í•˜ëŠ” ì—­í• .
```java
@Component
public class WebServerCustomizer implements WebServerFactoryCustomizer<ConfigurableWebServerFactory> {

    @Override
    public void customize(ConfigurableWebServerFactory factory) {

        ErrorPage errorPage404 = new ErrorPage(HttpStatus.NOT_FOUND, "/error-page/404");
        ErrorPage errorPage500 = new ErrorPage(HttpStatus.INTERNAL_SERVER_ERROR, "/error-page/500");
        ErrorPage errorPageEx = new ErrorPage(RuntimeException.class, "/error-page/500");

        factory.addErrorPages(errorPage404, errorPage500, errorPageEx);
    }
}
```

- ì˜¤ë¥˜ ì²˜ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬
=>ë§¤í•‘ì„ ë°›ì•„ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
```java
@Slf4j
@Controller
public class ErrorPageController {

    @RequestMapping("/error-page/404")
    public String errorPage404(HttpServletRequest request, HttpServletResponse response){
        log.info("errorPage 404");
        return "error-page/404";
    }

    @RequestMapping("/error-page/500")
    public String errorPage500(HttpServletRequest request, HttpServletResponse response){
        log.info("errorPage 500");
        return "error-page/500";
    }
}
```

- 404 ì˜¤ë¥˜ ì²˜ë¦¬ view ì˜ˆì‹œ
```html
<!DOCTYPE HTML>  
<html xmlns:th="http://www.thymeleaf.org">  
<head>  
    <meta charset="utf-8">  
</head>  
<body>  
  
<div class="container" style="max-width: 600px">  
    <div class="py-5 text-center">  
        <h2>404 ì˜¤ë¥˜ í™”ë©´ ìŠ¤í”„ë§ ë¶€íŠ¸ ì œê³µ</h2>  
    </div>  
    <div>        
	    <p>ì˜¤ë¥˜ í™”ë©´ ì…ë‹ˆë‹¤.</p>  
    </div>  
    <hr class="my-4">  
  
</div> <!-- /container -->  
  
</body>  
</html>
```

- ê²°ê³¼
![[Pasted image 20230124134434.png]]


#### ğŸ“Œ í•„í„°ë¥¼ í™œìš©í•œ ì˜¤ë¥˜ í˜ì´ì§€ ìš”ì²­ íë¦„ì˜ ê°œì„ ë°©ë²•ì€?
â–¶ ì˜¤ë¥˜ í˜ì´ì§€ ìš”ì²­ íë¦„ì˜ ë¬¸ì œì 
```
1. WAS(ì—¬ê¸°ê¹Œì§€ ì „íŒŒ) <- í•„í„° <- ì„œë¸”ë¦¿ <- ì¸í„°ì…‰í„° <- ì»¨íŠ¸ë¡¤ëŸ¬(ì˜ˆì™¸ë°œìƒ)
2. WAS `/error-page/500` ë‹¤ì‹œ ìš”ì²­ -> í•„í„° -> ì„œë¸”ë¦¿ -> ì¸í„°ì…‰í„° -> ì»¨íŠ¸ë¡¤ëŸ¬(/error- page/500) -> View
```
=> ì´ë¯¸ í•œë²ˆ í•„í„°ë‚˜, ì¸í„°ì…‰í„°ì—ì„œ ë¡œê·¸ì¸ ì²´í¬ë¥¼ ì™„ë£Œí–ˆë‹¤. ì„œë²„ ë‚´ë¶€ì—ì„œ ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ í˜¸ì¶œí•œë‹¤ê³  í•´ì„œ **í•´ë‹¹ í•„í„°ë‚˜ ì¸í„°ì…‰íŠ¸ê°€ í•œë²ˆ ë” í˜¸ì¶œë˜ëŠ” ê²ƒì€ ë§¤ìš° ë¹„íš¨ìœ¨ì **ì„.

â–¶ í•´ê²°ë°©ì•ˆì€? 
```
1. WAS(/error-ex, dispatchType=REQUEST) -> í•„í„° -> ì„œë¸”ë¦¿ -> ì¸í„°ì…‰í„° -> ì»¨íŠ¸ë¡¤ëŸ¬
2. WAS(ì—¬ê¸°ê¹Œì§€ ì „íŒŒ) <- í•„í„° <- ì„œë¸”ë¦¿ <- ì¸í„°ì…‰í„° <- ì»¨íŠ¸ë¡¤ëŸ¬(ì˜ˆì™¸ë°œìƒ)
3. WAS ì˜¤ë¥˜ í˜ì´ì§€ í™•ì¸
4. WAS(/error-page/500, dispatchType=ERROR) -> í•„í„°(x) -> ì„œë¸”ë¦¿ -> ì¸í„°ì…‰í„°(x) -> ì»¨íŠ¸ë¡¤ëŸ¬(/error-page/500) -> View
```
=> í´ë¼ì´ì–¸íŠ¸ë¡œ ë¶€í„° ë°œìƒí•œ ì •ìƒ ìš”ì²­ì¸ì§€, ì•„ë‹ˆë©´ ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ì¶œë ¥í•˜ê¸° ìœ„í•œ ë‚´ë¶€ ìš”ì²­ì¸ì§€ êµ¬ë¶„í•˜ê¸° ìœ„í•œ **DispatcherType** ì´ë¼ëŠ” ì¶”ê°€ ì •ë³´ë¥¼ ì œê³µí•¨.
=>ê³ ê°ì´ ì²˜ìŒ ìš”ì²­ì˜¬ë•ŒëŠ” `dispatcherType=REQUESTÂ `ë¡œ ì „ë‹¬ëœë‹¤.ì´í›„ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ë°”ë¡œ ìœ„ì—ì„œ ì‚´í´ë´¤ë“¯` dispatcherType=ERROR`Â ì„ ì „ë‹¬í•œë‹¤. 

â–¶ ì½”ë“œ
- WebConfig
```java
@Component
public class WebConfig implements WebMvcConfigurer {

    @Bean
    public FilterRegistrationBean logFilter() {
        FilterRegistrationBean<Filter> filterRegistrationBean = new FilterRegistrationBean<>();
        filterRegistrationBean.setFilter(new LogFilter());
        filterRegistrationBean.setOrder(1);
        filterRegistrationBean.addUrlPatterns("/*");
        //filterRegistrationBean.setDispatcherTypes(DispatcherType.REQUEST, DispatcherType.ERROR);
        return filterRegistrationBean;
    }
}
```
- `filterRegistrationBean.setDispatcherTypes(DispatcherType.REQUEST, DispatcherType.ERROR)` : í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì€ ë¬¼ë¡ ì´ê³ , ì˜¤ë¥˜ í˜ì´ì§€ ìš”ì²­ì—ì„œë„ í•„í„°ê°€ í˜¸ì¶œëœë‹¤. ê¸°ë³¸ê°’ì€ **DispatcherType.REQUEST ì´ë¼ì„œ ê¸°ë³¸ê°’ ìœ ì§€**.


## ì‚¬ìš©í•  ì˜¤ë¥˜í˜ì´ì§€ ì§€ì‹
#### ğŸ“Œ ì¸í„°ì…‰í„°ë¥¼ í™œìš©í•œ ì˜¤ë¥˜ í˜ì´ì§€ ìš”ì²­ íë¦„ì˜ ê°œì„ ë°©ë²•ì€?
=> ì¸í„°ì…‰í„°ëŠ” DispatcherTypeì´ ì—†ë‹¤!Â ê·¸ëŸ¼ ì–´ë–»ê²Œ ì²˜ë¦¬í• ê¹Œ? **ê²½ë¡œ ì •ë³´ë¡œ ì¤‘ë³µ í˜¸ì¶œ ì œê±°** `excludePathPatterns()`

â–¶ ì½”ë“œ
- WebConfig
```java
@Component
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LogInterceptor())
                .order(1)
                .addPathPatterns("/**")
                .excludePathPatterns("/css/**", "*.ico", "/error", "/error-page/**");
    }
}
```
=>ìš”ì²­ ê²½ë¡œì— ë”°ë¼ì„œ ì¶”ê°€í•˜ê±°ë‚˜ ì œì™¸í•  ìˆ˜ ìˆìŒ


#### âœ”ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ì˜¤ë¥˜í˜ì´ì§€
â–¶ê¸°ì¡´ ì˜¤ë¥˜í˜ì´ì§€ ê³¼ì •
1) `WebServerCustomizer` ë¥¼ ë§Œë“¤ê³ 
2) ì˜ˆì™¸ ì¢…ë¥˜ì— ë”°ë¼ì„œ `ErrorPage ê°ì²´`ë¥¼ ì¶”ê°€í•˜ê³  
3) ì˜ˆì™¸ ì²˜ë¦¬ìš© ì»¨íŠ¸ë¡¤ëŸ¬ `ErrorPageController`ë¥¼ ì‚¬ìš©ìê°€ ì§ì ‘ ë§Œë“¤ì—ˆë‹¤.
4) ì´í›„ `error-page`ì— ìˆëŠ” ë·° ë°˜í™˜í•¨.

â–¶ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ì˜¤ë¥˜í˜ì´ì§€ ê³¼ì •
=> Â **ErrorPageë¥¼ ìë™ë“±ë¡ê³¼ BasicErrorControllerÂ ë¼ëŠ” ìŠ¤í”„ë§ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ìë™ìœ¼ë¡œ ë“±ë¡**í•´ì¤Œ. ë”°ë¼ì„œ ê°œë°œìëŠ” `resources/templates/error` OR `resources/static/error` ìœ„ì¹˜ì— **ì˜¤ë¥˜ í˜ì´ì§€ html íŒŒì¼ë§Œ ë“±ë¡í•˜ë©´ ëŒ.**


#### ğŸ“Œë·° ì„ íƒ ìš°ì„ ìˆœìœ„
=> 404, 500ì²˜ëŸ¼ êµ¬ì²´ì ì¸ ê²ƒì´ 5xxì²˜ëŸ¼ ëœ êµ¬ì²´ì ì¸ ê²ƒë³´ë‹¤ ìš°ì„ ìˆœìœ„ê°€ ë†’ë‹¤.
1) ë·°í…œí”Œë¦¿ : `resources/templates/error/500.html` , `resources/templates/error/5xx.html`
2) ì •ì  ë¦¬ì†ŒìŠ¤ : `resources/static/error/404.html` , `resources/static/error/4xx.html`
3) ì ìš© ëŒ€ìƒì´ ì—†ì„ë•Œ ì „ì²´ì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” ë·° ì´ë¦„(error) : `resources/templates/error.html`