ë§í¬ : [[ìŠ¤í”„ë§ mvc 2í¸.pdf]] (page. 213)
í•´ì‹œíƒœí¬ : #í•„í„°, #ì¸í„°ì…‰í„°

----
## í•„í„°ì— ëŒ€í•´ì„œ
#### âœ”í•„í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ”?
=> **ë¡œê·¸ì¸ í•œ ì‚¬ìš©ìë§Œ** ìƒí’ˆ ê´€ë¦¬ í˜ì´ì§€ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. ìƒí’ˆ ê´€ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ ì²´í¬í•˜ëŠ” ë¡œì§ì„ í•˜ë‚˜í•˜ë‚˜ ì‘ì„±í•˜ë©´ ë˜ê² ì§€ë§Œ, ë“±ë¡, ìˆ˜ì •, ì‚­ì œ, ì¡°íšŒ ë“±ë“± ìƒí’ˆê´€ë¦¬ì˜ **ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ ë¡œì§ì— ê³µí†µìœ¼ë¡œ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ í™•ì¸í•´ì•¼ í•˜ëŠ” ë¬¸ì œì **ì´ ìˆìŒ. ì• í”Œë¦¬ì¼€ì´ì…˜ ì—¬ëŸ¬ ë¡œì§ì—ì„œ ê³µí†µìœ¼ë¡œ ê´€ì‹¬ì´ ìˆëŠ” ìˆëŠ” ê²ƒì„ ê³µí†µ ê´€ì‹¬ì‚¬ë¥¼ ì„œë¸”ë¦¿ í•„í„° ë˜ëŠ” ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ë¥¼ ì‚¬ìš©í•¨.


#### âœ”ì„œë¸”ë¦¿ í•„í„°ë€?
ì¶œì²˜ : [[Servlet] ì„œë¸”ë¦¿ í•„í„° (Filter) ](https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=adamdoha&logNo=221665607853)
=> Clientë¡œ ë¶€í„° **Serverë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ê¸° ì „ì— ì„œë¸”ë¦¿ì„ ê±°ì³ì„œ í•„í„°ë§** í•˜ëŠ” ê²ƒì´ë‹¤. ê³µí†µì ì¸ ê¸°ëŠ¥ë“¤ì„ ì„œë¸”ë¦¿ì´ í˜¸ì¶œë˜ê¸° ì „ì— ìˆ˜í–‰(ì „ì²˜ë¦¬)ë˜ê²Œ í•˜ê³  ì‹¶ê±°ë‚˜ì„œë¸”ë¦¿ì´ í˜¸ì¶œ ë˜ê³  ë‚œ ë’¤ì— ìˆ˜í–‰(í›„ì²˜ë¦¬) í•˜ê³  ì‹¶ìœ¼ë©´ ê³µí†µì ì¸ ê¸°ëŠ¥ë“¤ì„ ì„œë¸”ë¦¿ í•„í„°ë¡œ êµ¬í˜„í•˜ë©´ ëœë‹¤.


#### ğŸ“Œí•„í„°ì˜ ë™ì‘ë°©ì‹ì€?
â–¶ ì •ìƒì ì¸ í•„í„° íë¦„
- HTTP ìš”ì²­ -> WAS -> í•„í„° -> ì„œë¸”ë¦¿ -> ì»¨íŠ¸ë¡¤ëŸ¬
- HTTP ìš”ì²­ -> WAS -> í•„í„°1 -> í•„í„°2 -> í•„í„°3 -> ì„œë¸”ë¦¿ -> ì»¨íŠ¸ë¡¤ëŸ¬

â–¶ í•„í„°ë¡œ ì œí•œë˜ëŠ” ê²½ìš°
- HTTP ìš”ì²­ -> WAS -> í•„í„°(ì ì ˆí•˜ì§€ ì•Šì€ ìš”ì²­ì´ë¼ íŒë‹¨, ì„œë¸”ë¦¿ í˜¸ì¶œX) 

#### ğŸ“Œ(ì½”ë“œ) í•„í„°ë¥¼ ì´ìš©í•´ ëª¨ë“  ìš”ì²­ì— ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ë²•ì€?
â–¶filter
- LogFilter : ì‚¬ìš©ìì˜ ëª¨ë“  ìš”ì²­ì— ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ì½”ë“œ
```java
@Slf4j
public class LogFilter implements Filter{

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        log.info("log filter init");
    }


    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) 
					     throws IOException, ServletException {
    
        log.info("log filter doFilter");
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        String requestURI = httpRequest.getRequestURI();

        String uuid = UUID.randomUUID().toString();

        try{
            log.info("REQUEST [{}][{}]", uuid, requestURI);
            chain.doFilter(request, response);  //ë‹¤ìŒìœ¼ë¡œ ì—°ê²°í•˜ê¸° ìœ„í•œ ë¶€ë¶„
        }catch (Exception e){
            throw e;
        }finally {
            log.info("RESPONSE [{}][{}]", uuid, requestURI);
        }
    }


    @Override
    public void destroy() {
        log.info("log filter destroy");
    }
}
```

â–¶Config
- WebConfig : Â FilterRegistrationBean ì„ ì‚¬ìš©í•´ì„œ ì‚¬ìš©ì ì •ì˜ í•„í„°ë¥¼ ë“±ë¡í•¨.
```java
@Configuration
public class WebConfig {

    @Bean
    public FilterRegistrationBean logFilter(){
        FilterRegistrationBean<Filter> filterRegistrationBean = new FilterRegistrationBean<>();
        filterRegistrationBean.setFilter(new LogFilter());
        filterRegistrationBean.setOrder(1);
        filterRegistrationBean.addUrlPatterns("/*");

        return filterRegistrationBean;
    }
}
```
- `setFilter(new LogFilter())` :Â ë“±ë¡í•  ì‚¬ìš©ì ì •ì˜ í•„í„°ë¥¼ ì§€ì •í•œë‹¤.
- `setOrder(1)` : í•„í„°ëŠ” ì²´ì¸ìœ¼ë¡œ ë™ì‘í•œë‹¤. ë”°ë¼ì„œÂ ìˆœì„œê°€ í•„ìš”í•˜ë‹¤. ë‚®ì„ ìˆ˜ë¡ ë¨¼ì € ë™ì‘í•œë‹¤.
- `addUrlPatterns("/*")` : í•„í„°ë¥¼ ì ìš©í• Â URL íŒ¨í„´ì„ ì§€ì •í•œë‹¤. í•œë²ˆì— ì—¬ëŸ¬ íŒ¨í„´ì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

â–¶ ê²°ê³¼
![[Pasted image 20230123214444.png]]


#### ğŸ“Œ(ì½”ë“œ) í•„í„°ë¥¼ ì´ìš©í•´ ë¡œê·¸ì¸ ì´ìš©ìë§Œ ì ‘ê·¼í•˜ê²Œ í•˜ëŠ” ë²•ì€?
â–¶filter
```java
@Slf4j
public class LoginCheckFilter implements Filter {

    private static final String[] whitelist = {"/", "/members/add", "/login", "/logout", "/css/*"};

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
					     FilterChain chain) throws IOException, ServletException {

        HttpServletRequest httpRequest = (HttpServletRequest) request;
        String requestURI = httpRequest.getRequestURI();

        HttpServletResponse httpResponse = (HttpServletResponse) response;

        try{
            log.info("ì¸ì¦ ì²´í¬ í•„í„° ì‹œì‘{}", requestURI);

            if(isLoginCheckPath(requestURI)){
                log.info("ì¸ì¦ ì²´í¬ ë¡œì§ ì‹¤í–‰ {}", requestURI);
                HttpSession session = httpRequest.getSession(false);
                if(session == null || session.getAttribute(SessionConst.LOGIN_MEMBER) == null){

                    log.info("ë¯¸ì¸ì¦ ì‚¬ìš©ì ìš”ì²­ {}", requestURI);
                    // ë¡œê·¸ì¸ìœ¼ë¡œ redirect
                    httpResponse.sendRedirect("/login?redirectURL=" + requestURI);
                    return;
                }
            }

            chain.doFilter(request, response);
        } catch (Exception e){
            throw e;
            
        } finally {
            log.info("ì¸ì¦ ì²´í¬ í•„í„° ì¢…ë£Œ {}", requestURI);
        }
    }

    // í™”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ì˜ ê²½ìš° ì¸ì¦ ì²´í¬X
    private boolean isLoginCheckPath(String requestURI){
        return !PatternMatchUtils.simpleMatch(whitelist, requestURI);
    }
}
```
- `whitelist` : whitelistì˜ URIì—ëŠ” ì¸ì¦ ì—†ì´ë„ ì ‘ê·¼ì´ ê°€ëŠ¥í•´ì•¼ í•œë‹¤. ì¦‰, ë¡œê·¸ì¸ ì—¬ë¶€ì— ìƒê´€ì—†ì´ **í•­ìƒ ì ‘ê·¼ í—ˆìš©**í•¨.
- `httpResponse.sendRedirect("/login?redirectURL=" + requestURI)` : ë¡œê·¸ì¸ì„ í•œ í›„,Â home í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê²Œ ë˜ë²„ë¦¬ë©´ ì‚¬ìš©ì ì…ì¥ì—ì„œëŠ” ë¶ˆí¸í•˜ë‹¤. ë¡œê·¸ì¸ì„ í–ˆìœ¼ë©´  `requestURI` ë³€ìˆ˜ë¥¼ ë³´ë‚´ **ì´ë™í•˜ë ¤ í–ˆë˜ í˜ì´ì§€ë¡œ ì´ë™í•´ì£¼ëŠ” ì—­í• **ì„í•¨.
- return : ì´í›„ í•„í„°ëŠ” ë¬¼ë¡  **ì„œë¸”ë¦¿, ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ë”ëŠ” í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.**

â–¶Config
- WebConfig
```java
@Bean
public FilterRegistrationBean logCheckFilter(){
    FilterRegistrationBean<Filter> filterRegistrationBean = new FilterRegistrationBean<>();
    filterRegistrationBean.setFilter(new LoginCheckFilter());
    filterRegistrationBean.setOrder(2);
    filterRegistrationBean.addUrlPatterns("/*");

    return filterRegistrationBean;
}
```

â–¶Controller
- LoginController
```java
@PostMapping("/login")
public String loginV4(@Validated @ModelAttribute LoginForm form, BindingResult bindingResult,
                      @RequestParam(defaultValue = "/") String redirectURL, HttpServletRequest request){

    if(bindingResult.hasErrors()){
        return "login/loginForm";
    }

    Member loginMember = loginService.login(form.getLoginId(), form.getPassword());

    if(loginMember == null){
        bindingResult.reject("loginFail", "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return "login/loginForm";
    }

    // ì„¸ì…˜ì´ ìˆìœ¼ë©´ ìˆëŠ” ì„¸ì…˜ ë°˜í™˜, ì—†ìœ¼ë©´ ì‹ ê·œ ì„¸ì…˜ì„ ìƒì„±
    HttpSession session = request.getSession();
    // ì„¸ì…˜ì— íšŒì› ì €ì¥
    session.setAttribute(SessionConst.LOGIN_MEMBER, loginMember);

    return "redirect:" + redirectURL;
}
```
- `@RequestParam(defaultValue = "/") String redirectURL` : ì›ë˜ ì´ë™í•˜ë ¤ í–ˆë˜ URL ì •ë³´ ë°›ê¸°


## ì¸í„°ì…‰í„°ì— ëŒ€í•´ì„œ
#### âœ”ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ë€?
=>**ë””ìŠ¤íŒ¨ì²˜ ì„œë¸”ë¦¿ê³¼ ì»¨íŠ¸ë¡¤ëŸ¬ ì‚¬ì´**ì—ì„œ í˜¸ì¶œë˜ì–´ ìš”ì²­ê³¼ ì‘ë‹µì„ ì°¸ì¡°í•˜ê±°ë‚˜ ê°€ê³µí• ìˆ˜ ìˆëŠ” ì¼ì¢…ì˜ **í•„í„°**


#### âœ”ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ì˜ ë™ì‘ë°©ì‹ì€?
â–¶ ì •ìƒì ì¸ íë¦„
- **HTTP ìš”ì²­ -> WAS -> í•„í„° -> ì„œë¸”ë¦¿ -> ìŠ¤í”„ë§ ì¸í„°ì…‰í„° -> ì»¨íŠ¸ë¡¤ëŸ¬**
- HTTP ìš”ì²­ -> WAS -> í•„í„° -> ì„œë¸”ë¦¿ -> ì¸í„°ì…‰í„°1 -> ì¸í„°ì…‰í„°2 -> ì»¨íŠ¸ë¡¤ëŸ¬

â–¶ ì¸í„°ì…‰í„°ë¡œ ì œí•œë˜ëŠ” ê²½ìš°
- HTTP ìš”ì²­ -> WAS -> í•„í„° -> ì„œë¸”ë¦¿ -> ìŠ¤í”„ë§ ì¸í„°ì…‰í„°(ì ì ˆí•˜ì§€ ì•Šì€ ìš”ì²­ì´ë¼ íŒë‹¨, ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œ X)


#### âœ”í•„í„° ëŒ€ì‹  ì¸í„°ì…‰í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ”?
=> ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ëŠ” ì„œë¸”ë¦¿ í•„í„°ë³´ë‹¤ í¸ë¦¬í•˜ê³ , **ë” ì •êµí•˜ê³  ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì§€ì›**í•¨.
```java
public interface HandlerInterceptor {

    default boolean preHandle(HttpServletRequest request, HttpServletResponse response, 
		Object handler) throws Exception {}

    default void postHandle(HttpServletRequest request, HttpServletResponse response, 
        Object handler, @Nullable ModelAndView modelAndView) throws Exception {}

    default void afterCompletion(HttpServletRequest request, HttpServletResponse response, 
        Object handler, @Nullable Exception ex) throws Exception {}
}
```
- ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œ ì „(Â preHandleÂ ) : **í•¸ë“¤ëŸ¬ ì–´ëŒ‘í„° í˜¸ì¶œ ì „ì— í˜¸ì¶œ**ëœë‹¤. false ì¸ ê²½ìš° ë‚˜ë¨¸ì§€ ì¸í„°ì…‰í„°, í•¸ë“¤ëŸ¬ ì–´ëŒ‘í„°ê°€ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.
- í˜¸ì¶œ í›„(Â postHandleÂ ) : **ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œ í›„ì— í˜¸ì¶œ**ëœë‹¤. (ë‹¨, **ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.**)
- ìš”ì²­ ì™„ë£Œ ì´í›„(Â afterCompletionÂ ) : ë·°ê°€ **ë Œë”ë§ ëœ ì´í›„**ì— í˜¸ì¶œëœë‹¤. (ë‹¨, **ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ í˜¸ì¶œ**ëœë‹¤.)

- ê·¸ë¦¼ìœ¼ë¡œ ë³´ëŠ” í˜¸ì¶œ íë¦„
![[Pasted image 20230123235021.png]]


#### ğŸ“Œ(ì½”ë“œ) ì¸í„°ì…‰í„°ë¥¼ ì´ìš©í•´ ëª¨ë“  ìš”ì²­ì— ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ë²•ì€?
â–¶interceptor
- LogInterceptor : ì‚¬ìš©ìê°€ ìš”ì²­ì„ ë³´ë‚´ì˜¬ë•Œ ë§ˆë‹¤ ë¡œê·¸ë¥¼ ë‚¨ê¸°ê¸°
```java
@Slf4j
public class LogInterceptor implements HandlerInterceptor {

    public static final String LOG_ID = "logId";

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, 
						     Object handler) throws Exception {
        String requestURI = request.getRequestURI();
        String uuid = UUID.randomUUID().toString();

        request.setAttribute(LOG_ID, uuid);

        if(handler instanceof HandlerMethod){
		    //í˜¸ì¶œí•  ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œì˜ ëª¨ë“  ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆìŒ.
            HandlerMethod hm = (HandlerMethod) handler;
        }

        log.info("REQUEST [{}][{}][{}]", uuid, requestURI, handler);
        return true; //ì •ìƒí˜¸ì¶œ
    }


    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, 
						   Object handler, ModelAndView modelAndView) throws Exception {
        log.info("postHandle [{}]", modelAndView);
    }


    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, 
							    Object handler, Exception ex) throws Exception {
    
        String requestURI = request.getRequestURI();
        String logId = (String) request.getAttribute(LOG_ID);
        
        log.info("RESPONSE [{}][{}][{}]", logId, requestURI, handler);
        if(ex != null){
            log.error("afterCompletion error!!", ex);
        }
    }
}
```
- `request.setAttribute()` : preHandle ì—ì„œ ì§€ì •í•œ ê°’ì„ postHandle , afterCompletion ì—ì„œ í•¨ê»˜ ì‚¬ìš©í•˜ë ¤ë©´ ì–´ë”˜ê°€ì— ë‹´ì•„ë‘ì–´ì•¼ í•˜ëŠ”ë°, ê·¸ë•Œ ì‚¬ìš©í•¨.


â–¶Config
- WebConfig : Â addInterceptors() ë¥¼ ì‚¬ìš©í•´ì„œ ì¸í„°ì…‰í„°ë¥¼ ë“±ë¡í•¨.
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LogInterceptor())
                .order(1)
                .addPathPatterns("/**")
                .excludePathPatterns("/css/", "/*.ico", "/error");
    }
}
```

â–¶ê²°ê³¼
![[Pasted image 20230124012646.png]]


#### âœ”(ì½”ë“œ) ì¸í„°ì…‰í„°ë¥¼ ì´ìš©í•´ ë¡œê·¸ì¸ ì´ìš©ìë§Œ ì ‘ê·¼í•˜ê²Œ í•˜ëŠ” ë²•ì€?
â–¶interceptor
- LoginCheckInterceptor : ë¡œê·¸ì¸ ì¸ì¦ í™•ì¸
```java
@Slf4j
public class LoginCheckInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String requestURI = request.getRequestURI();

        log.info("ì¸ì¦ ì²´í¬ ì¸í„°ì…‰í„° ì‹¤í–‰ {}", requestURI);
        HttpSession session = request.getSession();

        if(session == null || session.getAttribute(SessionConst.LOGIN_MEMBER) == null){
            log.info("ë¯¸ì¸ì¦ ì‚¬ìš©ì ìš”ì²­");
            response.sendRedirect("/login?redirectURL=" + requestURI);
            return false;
        }

        return true;
    }
}
```
- `response.sendRedirect("/login?redirectURL=" + requestURI)` : ë¡œê·¸ì¸ì„ í•œ í›„,Â home í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê²Œ ë˜ë²„ë¦¬ë©´ ì‚¬ìš©ì ì…ì¥ì—ì„œëŠ” ë¶ˆí¸í•˜ë‹¤. ë¡œê·¸ì¸ì„ í–ˆìœ¼ë©´  `requestURI` ë³€ìˆ˜ë¥¼ ë³´ë‚´ **ì´ë™í•˜ë ¤ í–ˆë˜ í˜ì´ì§€ë¡œ ì´ë™í•´ì£¼ëŠ” ì—­í• **ì„í•¨.

â–¶Config
- WebConfig : Â addInterceptors() ë¥¼ ì‚¬ìš©í•´ì„œ ì¸í„°ì…‰í„°ë¥¼ ë“±ë¡í•¨.
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
	    ...

        registry.addInterceptor(new LoginCheckInterceptor())
                .order(2)
                .addPathPatterns("/**") //ëª¨ë“  ê²½ë¡œ ì˜ë¯¸
                .excludePathPatterns("/", "/members/add", "/login", "/logout", "/css/**", "/*.ico", "/error");
    }
}
```
- ì¸í„°ì…‰í„°ë¥¼ ì ìš©í•˜ê±°ë‚˜ í•˜ì§€ ì•Šì„ ë¶€ë¶„ì€ **addPathPatterns ì™€ excludePathPatterns ì— ì‘ì„±**í•˜ë©´ ëœë‹¤.