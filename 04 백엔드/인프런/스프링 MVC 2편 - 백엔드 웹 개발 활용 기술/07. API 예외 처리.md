ë§í¬ : [[ìŠ¤í”„ë§ mvc 2í¸.pdf]] (page. 264)
í•´ì‹œíƒœí¬ : #API

----
## APIì˜ ì˜ˆì™¸ ì²˜ë¦¬ ì‹œì‘
#### âœ”API ì˜ˆì™¸ì²˜ë¦¬ëŠ” ê¸°ì¡´ ì˜ˆì™¸ì²˜ë¦¬í•˜ê³  ë¬´ì—‡ì´ ë‹¤ë¥¼ê¹Œ?
=>ê¸°ì¡´ì—ëŠ” viewë¥¼ ë°˜í™˜í•˜ì—¬ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ í–ˆì—ˆë‹¤. í•˜ì§€ë§Œ, API ë°©ì‹ì€ **ê° ì˜¤ë¥˜ ìƒí™©ì— ë§ëŠ” ì˜¤ë¥˜ ì‘ë‹µ ìŠ¤í™ì„ ì •í•˜ê³ , JSON**ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë‚´ë ¤ì£¼ì–´ì•¼ í•œë‹¤.


#### ğŸ“Œ(ì½”ë“œ) ê¸°ì¡´ ì˜ˆì™¸ì²˜ë¦¬í•˜ë©´ ìƒê¸°ëŠ” ë¬¸ì œì ì€?
=> ì˜¤ë¥˜ ìƒí™©ì—ë„ jsonìœ¼ë¡œ ë³€í™˜í•˜ê³  ì‹¶ì€ë°.. **viewë¡œ ë°˜í™˜í•˜ëŠ” ë¬¸ì œì **

â–¶WebServerCustomizer
=> WebServerCustomizerë¥¼ ë§Œë“¤ì–´ì„œ ì§ì ‘ ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë§¤ì»¤ë‹ˆì¦ˆ ì‚¬ìš©í•¨.(ì˜ˆì™¸ì²˜ë¦¬ì™€ ì˜¤ë¥˜í˜ì´ì§€ ë‚´ìš© ì°¸ì¡°)

â–¶ API ì»¨íŠ¸ë¡¤ëŸ¬
=> exë¼ëŠ” ì‚¬ìš©ìê°€ ë“¤ì–´ì˜¤ë©´ ì˜ˆì™¸ë°œìƒí•¨.
```java
@Slf4j
@RestController
public class ApiExceptionController {

    @GetMapping("/api/members/{id}")
    public MemberDto getMember(@PathVariable String id){
        if(id.equals("ex")){
            throw new RuntimeException("ì˜ëª»ëœ ì‚¬ìš©ì");
        }

        return new MemberDto(id, "hello " + id);
    }

    @Data
    @AllArgsConstructor
    static class MemberDto{
        private String memberId;
        private String name;
    }
}
```

â–¶ ê²°ê³¼
- ì •ìƒí˜¸ì¶œ
```json
{
	"memberId": "spring", 
	"name": "hello spring"
}
```

- ëŸ°íƒ€ì„ ì—ëŸ¬(ì‚¬ìš©ìê°€ ex)ì—ì„œëŠ” viewë¡œ ë°˜í™˜
![[Pasted image 20230125160907.png]]


#### ğŸ“Œ(ì½”ë“œ) í•´ê²°ì±… (ì´í•´ë§Œ)
=> **ì˜ˆì™¸ì¼ë•Œë„ Jsonì„ ë°˜í™˜**í•˜ì

â–¶WebServerCustomizer
=> WebServerCustomizerë¥¼ ë§Œë“¤ì–´ì„œ ì§ì ‘ ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë§¤ì»¤ë‹ˆì¦ˆ ì‚¬ìš©(ì˜ˆì™¸ì²˜ë¦¬ì™€ ì˜¤ë¥˜í˜ì´ì§€ ë‚´ìš© ì°¸ì¡°)

â–¶ Controller
- errorPage500Api : ì˜¤ë¥˜ë¥¼ **ì§ì ‘ Jsonìœ¼ë¡œ ë³€í™˜**í•¨.
```java
public class ErrorPageController {  

	...
	
    @RequestMapping(value = "/error-page/500", produces = MediaType.APPLICATION_JSON_VALUE)  
    public ResponseEntity<Map<String, Object>> errorPage500Api(HttpServletRequest request, HttpServletResponse response){  
  
        log.info(">> API errorPage 500");  
  
        Map<String, Object> result = new HashMap<>();  
        Exception ex = (Exception) request.getAttribute(ERROR_EXCEPTION);  
        result.put("status", request.getAttribute(ERROR_STATUS_CODE));  //ì˜¤ë¥˜ìƒíƒœ ë„£ê¸°
        result.put("message", ex.getMessage());  //ì˜¤ë¥˜ ë©”ì‹œì§€ ë„£ê¸°
  
        Integer statusCode = (Integer) request.getAttribute(RequestDispatcher.ERROR_STATUS_CODE);  
        return new ResponseEntity<>(result, HttpStatus.valueOf(statusCode));  
    }
```
=> `produces = MediaType.APPLICATION_JSON_VALUE` : í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­í•˜ëŠ” HTTP Headerì˜ Accept ì˜ ê°’ì´ application/jsonì¼ ë•Œ í•´ë‹¹ ë©”ì„œë“œê°€ í˜¸ì¶œëœë‹¤ëŠ” ê²ƒì´ë‹¤.

â–¶ ìš”ì²­
ìš”ì²­ URL : `http://localhost:8081/api/members/ex`
![[Pasted image 20230125165108.png]]

â–¶ê²°ê³¼
```json
{
Â Â Â Â "message":Â "ì˜ëª»ëœÂ ì‚¬ìš©ì",
Â Â Â Â "status":Â 500
}
```


#### ğŸ“ŒìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ë³¸ ì˜¤ë¥˜ ì²˜ë¦¬
=> ì´ì „ì—ëŠ” ì§ì ‘ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ í–ˆìŒ. ì´ì œëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì œê³µí•˜ëŠ”Â **BasicErrorController**Â ì½”ë“œë¡œ ê°„í¸í•˜ê²Œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬ë¡œ í•´ë³´ì.

- BasicErrorController ì¸í„°í˜ì´ìŠ¤
```java
@Controller  
@RequestMapping("${server.error.path:${error.path:/error}}")  
public class BasicErrorController extends AbstractErrorController {
	@RequestMapping(produces = MediaType.TEXT_HTML_VALUE)
	public ModelAndView errorHtml(HttpServletRequest request, HttpServletResponse response) {...}
	
	@RequestMapping
	public ResponseEntity<Map<String, Object>> error(HttpServletRequest request) {...}
}
```
- `errorHtml()` : `produces = MediaType.TEXT_HTML_VALUE` ì´ë‹¤. ë”°ë¼ì„œ **í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì˜ Acceptê°€ text/html ì¸ ê²½ìš°ì—ë§Œ ì´ ì»¨íŠ¸ë¡¤ëŸ¬**ê°€ ì‹¤í–‰í•¨.
- `error()` : ê·¸ì™¸ ê²½ìš°ì— í˜¸ì¶œë˜ê³  ResponseEntity ë¡œ HTTP Bodyì— **JSON ë°ì´í„°ë¥¼ ë°˜í™˜**í•¨.


#### ğŸ“Œ(ì½”ë“œ) ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ë³¸ ì˜¤ë¥˜ ì²˜ë¦¬
â–¶ API ì»¨íŠ¸ë¡¤ëŸ¬
=> exë¼ëŠ” ì‚¬ìš©ìê°€ ë“¤ì–´ì˜¤ë©´ ì˜ˆì™¸ë°œìƒí•¨.
```java
@Slf4j
@RestController
public class ApiExceptionController {

    @GetMapping("/api/members/{id}")
    public MemberDto getMember(@PathVariable String id){
        if(id.equals("ex")){
            throw new RuntimeException("ì˜ëª»ëœ ì‚¬ìš©ì");
        }

        return new MemberDto(id, "hello " + id);
    }

    @Data
    @AllArgsConstructor
    static class MemberDto{
        private String memberId;
        private String name;
    }
}
```

â–¶ `BasicErrorController`ë¡œ ì˜ˆì™¸ì²˜ë¦¬ ê²°ê³¼
=> BasicErrorControllerê°€ **ìë™ìœ¼ë¡œ JSON ì²˜ë¦¬**í•´ì¤Œ.
 

#### âœ”BasicErrorControllerì²˜ë¦¬ì˜ í•œê³„ì ì€?
=> BasicErrorController HTML í˜ì´ì§€ë¥¼ ì œê³µí•˜ê³  í™•ì¥í•˜ë©´ JSON ë©”ì‹œì§€ë„ ë³€ê²½í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ°ë° **API ì˜¤ë¥˜ ì²˜ë¦¬ëŠ” API ë§ˆë‹¤, ê°ê°ì˜ ì»¨íŠ¸ë¡¤ëŸ¬ë‚˜ ì˜ˆì™¸ë§ˆë‹¤ ì„œë¡œ ë‹¤ë¥¸ ì‘ë‹µ ê²°ê³¼ë¥¼ ì¶œë ¥**í•´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤. ì˜ˆë¥¼ ë“¤ì–´ì„œ íšŒì›ê³¼ ê´€ë ¨ëœ APIì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•  ë•Œ ì‘ë‹µê³¼, ìƒí’ˆê³¼ ê´€ë ¨ëœ APIì—ì„œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ì— ë”°ë¼ ê·¸ ê²°ê³¼ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤.


#### âœ”ExceptionResolverì˜ ë§¤ì»¤ë‹ˆì¦˜ì€?
=> ExceptionResolver(=`HandlerExceptionResolver`) ì´ë¦„ ê·¸ëŒ€ë¡œ **ì˜ˆì™¸ë¥¼ í•´ê²°í•˜ëŠ” ì—­í• **ì„ í•¨. ê¸°ì¡´ ì˜ˆì™¸ë¥¼ ë‹¤ë¥¸ ì˜ˆì™¸ë¡œ êµì²´í•˜ê±°ë‚˜ ì˜ˆì™¸íë¦„ì„ ì •ìƒíë¦„ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©í•¨.

- **ê¸°ì¡´ ì˜ˆì™¸ë¡œ êµì²´í•˜ëŠ” ê²½ìš°**
```
1. WAS(ì—¬ê¸°ê¹Œì§€ ì „íŒŒ) <- í•„í„° <- ì„œë¸”ë¦¿ <- ì¸í„°ì…‰í„° <- ì»¨íŠ¸ë¡¤ëŸ¬(5xx ì˜ˆì™¸ë°œìƒ)
2. WAS `/error-page/400` ë‹¤ì‹œ ìš”ì²­ -> í•„í„° -> ì„œë¸”ë¦¿ -> ì¸í„°ì…‰í„° -> ì»¨íŠ¸ë¡¤ëŸ¬(/error- page/400) -> View
```
=> ì˜ˆì™¸(ex. 5xx)ê°€ ì¡ì•„ì„œ  ë‹¤ë¥¸ ì˜ˆì™¸(ex. 400)ë¡œ ë°”ê¿”ì¤Œ. 
![[Pasted image 20230125182905.png]]

-  **ì •ìƒíë¦„ìœ¼ë¡œ ë°”ê¿”ì£¼ê¸°**
```
 1. WAS(ì—¬ê¸°ê¹Œì§€ ì „íŒŒ) <- í•„í„° <- ì„œë¸”ë¦¿ <- ì¸í„°ì…‰í„° <- ì»¨íŠ¸ë¡¤ëŸ¬(ì˜ˆì™¸ë°œìƒ)
 2. ì»¨íŠ¸ë¡¤ëŸ¬(ì •ìƒíë¦„ ë³€í™˜) -> View
```
=>Â **Exceptionì„ ì²˜ë¦¬í•´ì„œ ì •ìƒ íë¦„ìœ¼ë¡œ ë³€ê²½**í•¨. (ë‹¨, postHandlerëŠ” í˜¸ì¶œ X)
![[Pasted image 20230125183001.png]]

â–¶ ì¸í„°í˜ì´ìŠ¤ êµ¬ì„±
```java
public interface HandlerExceptionResolver {
	ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, 
								  Object handler, Exception ex);
}
```
- `handler` : í•¸ë“¤ëŸ¬(ì»¨íŠ¸ë¡¤ëŸ¬) ì •ë³´ 
- `Exception ex` : í•¸ë“¤ëŸ¬(ì»¨íŠ¸ë¡¤ëŸ¬)ì—ì„œ ë°œìƒí•œ ë°œìƒí•œ ì˜ˆì™¸


#### ğŸ“Œ(ì½”ë“œ) ë°œìƒí•˜ëŠ” ì˜ˆì™¸ì— ë”°ë¼ì„œ ë‹¤ë¥¸ ì˜ˆì™¸ì½”ë“œë¡œ ì²˜ë¦¬í•˜ê³  ì‹¶ë‹¤ë©´?
=> ì˜ˆë¥¼ ë“¤ì–´ ê³ ê°ì´ íƒ€ì…ì„ ì˜ëª» ì…ë ¥í•´ì„œ 5xxì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤. 5xxì˜¤ë¥˜ëŠ” ì„œë²„ ì˜¤ë¥˜ë¼ì„œ ê³ ê°ì´ ì•„ë‹Œ ì„œë²„ì˜ ë¬¸ì œê°€ ëœë‹¤. ê·¸ë˜ì„œ íƒ€ì…ì„ ì˜ëª» ì…ë ¥í•´ì¤¬ë‹¤ëŠ” ê²ƒì„ ì•Œë ¤ì£¼ê³  4xxì˜¤ë¥˜ë¡œ ê³ ì³ì•¼ í•œë‹¤.

â–¶ Controller
- ApiExceptionController
```java
@GetMapping("/api/members/{id}")
public MemberDto getMember(@PathVariable("id") String id) {  
  
    if (id.equals("ex")) {  
        throw new RuntimeException("ì˜ëª»ëœ ì‚¬ìš©ì");  
    }  
    if (id.equals("bad")) {  
        throw new IllegalArgumentException("ì˜ëª»ëœ ì…ë ¥ ê°’");  
    }  
  
    return new MemberDto(id, "hello " + id);  
}
```


â–¶ ExceptionResolver
=> `IllegalArgumentException`ëŠ” **500ì˜¤ë¥˜ì¸ë°, 400ì˜¤ë¥˜ë¡œ ë°”ê¾¸ê³  ì‹¶ìŒ.**
```java
@Slf4j
public class MyHandlerExceptionResolver implements HandlerExceptionResolver {  
  
    @Override  
    public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, 
									    Object handler, Exception ex) {  
  
        log.info("call resolver", ex);  
  
        try {  
            if (ex instanceof IllegalArgumentException) {  
                log.info("IllegalArgumentException resolver to 400");  
                response.sendError(HttpServletResponse.SC_BAD_REQUEST, ex.getMessage());  
                return new ModelAndView();  
            }  
  
        } catch (IOException e) {  
            log.error("resolver ex", e);  
        }  
  
        return null;  
    }  
}
```
- `response.sendError()` : **ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŒì„ ë‚˜íƒ€ë‚´ëŠ” ë©”ì†Œë“œ**ì´ë‹¤. ê·¸ë˜ì„œ ì—¬ê¸°ì„œëŠ” ê¸°ì¡´ ì˜¤ë¥˜ë¥¼ ë‹¤ë¥¸ ì˜¤ë¥˜ë¡œ ë°”ê¿”ì£¼ëŠ” ì—­í• ì„ í•¨. WASê°€ dispatcherType == ERROR í˜•ì‹ìœ¼ë¡œ ë‹¤ì‹œ ë‚´ë¶€ì ì¸ ìš”ì²­ì„ í•˜ê²Œ ëŒ. (ì´ê²ƒì„ BasicErrorControllerê°€ ì²˜ë¦¬)
- `new ModelAndView() ` : ë¹ˆ ModelAndView ë¥¼ ë°˜í™˜í•˜ë©´ ë·°ë¥¼ ë Œë”ë§ í•˜ì§€ ì•Šê³ , **Exceptionì„ ì²˜ë¦¬í›„, ì •ìƒ íë¦„**ìœ¼ë¡œ ì„œë¸”ë¦¿ì´ ë¦¬í„´ëœë‹¤.
- `ModelAndView ì§€ì •` : ModelAndView ì— **View , Model ë“±ì˜ ì •ë³´ë¥¼ ì§€ì •í•´ì„œ ë°˜í™˜í•˜ë©´ ë·°ë¥¼ ë Œë”ë§** í•œë‹¤.
- `null` : null ì„ ë°˜í™˜í•˜ë©´, **ë‹¤ìŒ ExceptionResolver ë¥¼ ì°¾ì•„ì„œ ì‹¤í–‰**í•œë‹¤. ë§Œì•½ ì²˜ë¦¬í•  ìˆ˜ê°€ ì—†ìœ¼ë©´ ì˜ˆì™¸ ì²˜ë¦¬ê°€ ì•ˆë˜ê³ , **ê¸°ì¡´ì— ë°œìƒí•œ ì˜ˆì™¸**ë¥¼ ì„œë¸”ë¦¿ ë°–ìœ¼ë¡œ ë˜ì§„ë‹¤.


â–¶ WebConfig
=> í•´ë‹¹ í•¸ë“¤ëŸ¬ ë“±ë¡í•˜ê¸° ìœ„í•¨.
```java
@Component
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void extendHandlerExceptionResolvers(List<HandlerExceptionResolver> resolvers) {
        resolvers.add(new MyHandlerExceptionResolver());
    }
}
```

â–¶ê²°ê³¼
- ì ìš©ì „
![[Pasted image 20230125184303.png]]

- ì ìš©í›„
![[Pasted image 20230125184641.png]]


#### ğŸ“Œ(ì½”ë“œ) ì˜ˆì™¸ë¥¼ ì •ìƒíë¦„ìœ¼ë¡œ ì‹¶ë‹¤ë©´?
â–¶Exception
=> ì˜¤ë¥˜ ë§Œë“¤ê¸°
```java
public class UserException extends RuntimeException {  
  
    public UserException() {  
        super();  
    }  
  
    public UserException(String message) {  
        super(message);  
    }  
  
    public UserException(String message, Throwable cause) {  
        super(message, cause);  
    }  
  
    public UserException(Throwable cause) {  
        super(cause);  
    }  
  
    protected UserException(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace) {  
        super(message, cause, enableSuppression, writableStackTrace);  
    }  
}
```

â–¶ Controller
=> user-exì¼ë•Œ ì˜¤ë¥˜ ì²˜ë¦¬
```java
@GetMapping("/api/members/{id}")
public MemberDto getMember(@PathVariable("id") String id) {  
  
    ... 
    
    if (id.equals("user-ex")) {  
    throw new UserException("ì‚¬ìš©ì ì˜¤ë¥˜");  
	}
  
    return new MemberDto(id, "hello " + id);  
}
```

â–¶ ExceptionResolver
=> Exceptionì„ ì²˜ë¦¬í•´ì„œ **ì •ìƒ íë¦„ìœ¼ë¡œ ë³€ê²½í•˜ê¸° ìœ„í•œ ëª©ì **.
```java
@Slf4j  
public class UserHandlerExceptionResolver implements HandlerExceptionResolver {  
  
    private final ObjectMapper objectMapper = new ObjectMapper();  
  
    @Override  
    public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, 
									    Object handler, Exception ex) {  
  
        try {  
            if (ex instanceof UserException) {  
                log.info("UserException resolver to 400");  
                String acceptHeader = request.getHeader("accept");  
                response.setStatus(HttpServletResponse.SC_BAD_REQUEST);  
  
                if ("application/json".equals(acceptHeader)) {  
                    Map<String, Object> errorResult = new HashMap<>();  
                    errorResult.put("ex", ex.getClass());  
                    errorResult.put("message", ex.getMessage());  
                    String result = objectMapper.writeValueAsString(errorResult);  
  
                    response.setContentType("application/json");  
                    response.setCharacterEncoding("utf-8");  
                    response.getWriter().write(result);  
                    return new ModelAndView();  
                } else {  
                    // TEXT/HTML  
                    return new ModelAndView("error/500");  
                }  
            }  
        } catch (IOException e) {  
            log.error("resolver ex", e);  
        }  
  
        return null;  
    }  
}
```
- `response.getWriter().write(result);` : ì˜ˆì™¸ë¥¼ Jsonìœ¼ë¡œ ì²˜ë¦¬í•´ë²„ë¦°ë‹¤. ë”°ë¼ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê¹Œì§€ ì˜ˆì™¸ê°€ ì „ë‹¬ë˜ì§€ ì•Šê³ , ìŠ¤í”„ë§ MVCì—ì„œ ì˜ˆì™¸ ì²˜ë¦¬ëŠ” ëì´ë‚œë‹¤. **ë•Œë¬¸ì— WAS ì…ì¥ì—ì„œëŠ” ì •ìƒì²˜ë¦¬ë˜ì—ˆë‹¤ê³  ìƒê°**í•œë‹¤.

â–¶ WebConfig
=> `UserHandlerExceptionResolver` ë“±ë¡í•˜ê¸° ìœ„í•¨.
```java
@Component
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void extendHandlerExceptionResolvers(List<HandlerExceptionResolver> resolvers) {
        resolvers.add(new MyHandlerExceptionResolver());
        resolvers.add(new UserHandlerExceptionResolver());
    }
}
```

â–¶ê²°ê³¼
![[Pasted image 20230130220738.png]]


#### ğŸ“ŒìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ExceptionResolver?
=> ì´ì „ì—ëŠ” ì§ì ‘ ì˜¤ë²„ë¼ì´ë”©ì„ í†µí•´ ExceptionResolver í´ë˜ìŠ¤ë¥¼ êµ¬ì„±í–ˆë‹¤. ì´ì œëŠ” ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” 3ê°€ì§€ ExceptionResolverì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì.

1. ExceptionHandlerExceptionResolver :Â **@ExceptionHandler**Â ë¥¼ ì²˜ë¦¬í•œë‹¤.
2. ResponseStatusExceptionResolver : HTTP ìƒíƒœì½”ë“œë¥¼ ì§€ì •í•´ì¤„ìˆ˜ ìˆë‹¤.
3. DefaultHandlerExceptionResolver : ìš°ì„  ìˆœìœ„ê°€ ê°€ì¥ ë‚®ë‹¤. ìŠ¤í”„ë§ ë‚´ë¶€ ê¸°ë³¸ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•œë‹¤


#### ğŸ“ŒResponseStatusExceptionResolverë€?
=> **ì• ë…¸í…Œì´ì…˜ì„ í™œìš©í•˜ì—¬ HTTP ìƒíƒœì½”ë“œë¥¼ ì§€ì •í•´ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬**í•¨. í•˜ì§€ë§Œ ì •ìƒíë¦„ìœ¼ë¡œ ë°”ê¿”ì£¼ëŠ” ì˜¤ë¥˜ X

â–¶ ResponseStatusExceptionResolverì˜ ì½”ë“œë¡œ ë³´ëŠ” ì›ë¦¬
```java
protected ModelAndView applyStatusAndReason(int statusCode, @Nullable String reason, HttpServletResponse response) 
    throws IOException {

    if (!StringUtils.hasLength(reason)) {
        response.sendError(statusCode);
    }
    else {
        String resolvedReason = (this.messageSource != null ?
                this.messageSource.getMessage(reason, null, reason, LocaleContextHolder.getLocale()) :
                reason);
        response.sendError(statusCode, resolvedReason);
    }
    return new ModelAndView();
}
```
=> ë‚´ë¶€ì ìœ¼ë¡œëŠ” **`response.sendError(statusCode, resolvedReason)`** ì„ í˜¸ì¶œí•¨. ê·¸ë˜ì„œ **WASì—ì„œ ë‹¤ì‹œ ì˜¤ë¥˜ í˜ì´ì§€**( /error )ë¥¼ ë‚´ë¶€ ìš”ì²­í•œë‹¤.

â–¶ `@ResponseStatus`ì‚¬ìš©í•˜ëŠ” ë°©ì‹
- BadRequestException
```java
@ResponseStatus(code = HttpStatus.BAD_REQUEST, reason = "ì˜ëª»ëœ ìš”ì²­ ì˜¤ë¥˜") 
//@ResponseStatus(code = HttpStatus.BAD_REQUEST, reason = "error.bad") //ë©”ì‹œì§€í™” ê°€ëŠ¥
public class BadRequestException extends RuntimeException {
}
```
=> **ì• ë…¸í…Œì´ì…˜ì„ í™œìš©í•˜ì—¬ HTTP ìƒíƒœì½”ë“œë¥¼ ì§€ì •í•´ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬**í•¨.
=> BadRequestException ì˜ˆì™¸ê°€ ì»¨íŠ¸ë¡¤ëŸ¬ ë°–ìœ¼ë¡œ ë„˜ì–´ê°€ë©´ ResponseStatusExceptionResolverê°€ í•´ë‹¹ @ResponseStatusë¥¼ í™•ì¸í•´ì„œ ì˜¤ë¥˜ ì½”ë“œë¥¼ HttpStatus.BAD_REQUEST (400)ìœ¼ë¡œ ë³€ê²½í•˜ê³ , ë©”ì‹œì§€ë„ ë‹´ëŠ”ë‹¤.
=> ì§ì ‘ ë³€ê²½í•  ìˆ˜ ì—†ëŠ” ì˜ˆì™¸ì—ëŠ” ì ìš©í•  ìˆ˜ ì—†ë‹¤. (ex. ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì˜ˆì™¸ ì½”ë“œ)

â–¶ `ResponseStatusException` ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹
```java
@GetMapping("/api/response-status-ex2")
public String responseStatusEx2() {
    throw new ResponseStatusException(HttpStatus.NOT_FOUND, "error.bad", new IllegalArgumentException());
}
```
=> **ì‚¬ìš©ìê°€ ì›í•˜ëŠ”ëŒ€ë¡œ ì„¤ì •í•˜ì—¬ Exceptionì„ ë°œìƒ**ì‹œí‚¬ìˆ˜ê°€ ìˆë‹¤.


#### ğŸ“ŒDefaultHandlerExceptionResolverë€?
=> `DefaultHandlerExceptionResolver`ëŠ”  **5xxì˜¤ë¥˜ë¥¼ 4xxì˜¤ë¥˜ë¡œ ë³€ê²½í•˜ì—¬ ì²˜ë¦¬**í•´ ì¤€ë‹¤.

â–¶ DefaultHandlerExceptionResolver
=>ì˜ˆì™¸ë¥¼ íŠ¹ì • HTTP ìƒíƒœ ì½”ë“œì— ë§¤í•‘í•˜ê³  í•´ë‹¹ ì½”ë“œì™€ ì˜¤ë¥˜ ë©”ì‹œì§€ë¡œ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤. `response.sendError`ê°€ ì‚¬ìš©ë˜ë¯€ë¡œ, ì˜ˆì™¸ê°€ ì˜¬ë¼ê°€ì„œ ì²˜ë¦¬ë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŒ.
```java
protected ModelAndView doResolveException(  
        HttpServletRequest request, HttpServletResponse response, @Nullable Object handler, Exception ex) {  
  
    try {  
        // ìƒëµ...  
        else if (ex instanceof TypeMismatchException) {  
            return handleTypeMismatch( (TypeMismatchException) ex, request, response, handler);  
        }  
        // ìƒëµ...  
    } catch (Exception handlerEx) {  
        if (logger.isWarnEnabled()) {  
            logger.warn("Failure while trying to resolve exception [" + ex.getClass().getName() + "]", handlerEx);  
        }  
    }  
    return null;  
}

protected ModelAndView handleHttpRequestMethodNotSupported(HttpRequestMethodNotSupportedException ex, 
			HttpServletRequest request, HttpServletResponse response, @Nullable Object handler) throws IOException {  

    String[] supportedMethods = ex.getSupportedMethods();  
    
    if (supportedMethods != null) {  
        response.setHeader("Allow", StringUtils.arrayToDelimitedString(supportedMethods, ", "));  
    }  
  
    response.sendError(405, ex.getMessage());  
    return new ModelAndView();  
}
```

â–¶Controller
=>ApiExceptionControllerì— ì¶”ê°€í•˜ê¸°
```java
@GetMapping("/api/default-handler-ex")
public String defaultException(@RequestParam Integer data) {
    return "ok";
}
```

â–¶ ê²°ê³¼
- ì •ìƒí˜¸ì¶œ
![[Pasted image 20230126003701.png]]

- ë°”ì¸ë”© ì‹œì  íƒ€ì…ì˜¤ë¥˜
![[Pasted image 20230126003630.png]]


#### ğŸ“ŒExceptionHandlerExceptionResolverë€?
=> ì‚¬ìš©í•  API ì§€ì‹ì—ì„œ í™•ì¸í•˜ì.


## ì‚¬ìš©í•  API ì§€ì‹

#### âœ”ì˜ˆì™¸ì²˜ë¦¬ ì–´ë–¤ ê²ƒì„ ì„ íƒí•´ì•¼í• ê¹Œ?
- **HTML í˜ì´ì§€ ì˜¤ë¥˜** : ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì œê³µí•˜ëŠ” BasicErrorControllerë¥¼ í™œìš©í•˜ì—¬ ì²˜ë¦¬í•¨. -> 6ì¥ ì°¸ê³ 
- **API ì˜¤ë¥˜** : `@ExceptionHandler`ë¥¼ ì‚¬ìš©í•¨.


#### âœ”ExceptionHandlerExceptionResolverë€?
=> **`@ExceptionHandler`** ë¼ëŠ” ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•¨. ì°¸ê³ ë¡œ ì§€ì •í•œ ì˜ˆì™¸ ë˜ëŠ” ê·¸ ì˜ˆì™¸ì˜ ìì‹ í´ë˜ìŠ¤ëŠ” ëª¨ë‘ ì¡ì„ ìˆ˜ ìˆë‹¤.

â–¶ API ì˜ˆì™¸ ì²˜ë¦¬ì˜ ì–´ë ¤ìš´ì 
- HandlerExceptionResolverë¥¼ êµ¬í˜„í• ë•Œë¥¼ ìƒê°í•´ë³´ë©´, **ModelAndViewë¥¼ ë°˜í™˜**í–ˆë‹¤. ì´ëŠ” APIì‘ë‹µì—ì„œëŠ” **ë¶ˆí•„ìš”**í•˜ë‹¤.
-  HandlerExceptionResolverë¥¼ ìƒì†í•˜ì—¬ êµ¬í˜„í• ë•Œë¥¼ ìƒê°í•´ë³´ë©´ **responseì— ì§ì ‘ ì‘ë‹µ ë°ì´í„°ë¥¼ ë‹¤ ì²˜ë¦¬**í•˜ê¸°ì— ë„ˆë¬´ ë¶ˆí¸í–ˆë‹¤.
- **íŠ¹ì • ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œë§Œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸**ë¥¼ ë³„ë„ë¡œ ì²˜ë¦¬í•˜ê¸°ëŠ” ì–´ë µë‹¤.

â–¶ì˜ˆì™¸ì²˜ë¦¬ ë§¤ì»¤ë‹ˆì¦˜
```java
@ResponseStatus(HttpStatus.BAD_REQUEST)
@ExceptionHandler(IllegalArgumentException.class)
public ErrorResult illegalExHandler(IllegalArgumentException e){
    log.error("[exceptionHandler] ex", e);
    return new ErrorResult("BAD", e.getMessage());
}
```
1) ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í˜¸ì¶œí•œ ê²°ê³¼ **IllegalArgumentException ì˜ˆì™¸**ê°€ ì»¨íŠ¸ë¡¤ëŸ¬ ë°–ìœ¼ë¡œ ì „ë‹¬ëœë‹¤.
2) ì˜ˆì™¸ê°€ ë°œìƒí–ˆìœ¼ë‹ˆ ê°€ì¥ ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ **ExceptionHandlerExceptionResolverê°€ ìˆìœ¼ë¯€ë¡œ**, í•´ë‹¹ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ IllegalArgumentExceptionì„ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” **@ExceptionHandler ê°€ ìˆëŠ”ì§€ í™•ì¸**í•œë‹¤.
3)Â illegalExHandle() ë¥¼ ì‹¤í–‰í•œë‹¤. @RestController ì´ë¯€ë¡œ illegalExHandle() ì—ë„ **@ResponseBody ê°€ ì ìš©**ëœë‹¤. ë”°ë¼ì„œ HTTP ì»¨ë²„í„°ê°€ ì‚¬ìš©ë˜ê³ , ì‘ë‹µì´ ë‹¤ìŒê³¼ ê°™ì€ **JSONìœ¼ë¡œ ë°˜í™˜**ëœë‹¤.
5)Â **@ResponseStatus(HttpStatus.BAD_REQUEST) ë¥¼ ì§€ì •**í–ˆìœ¼ë¯€ë¡œ **HTTP ìƒíƒœ ì½”ë“œ 400ìœ¼ë¡œ ì‘ë‹µ**í•œë‹¤.


#### âœ”(ì½”ë“œ) ExceptionHandlerExceptionResolverë¡œ ì˜ˆì™¸ì²˜ë¦¬í•˜ê¸°
â–¶ í´ë˜ìŠ¤
=> ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ë•Œ API ì‘ë‹µìœ¼ë¡œ ë‚˜ê°ˆ ê°ì²´
```java
@Data
@AllArgsConstructor
public class ErrorResult {
    private String code;
    private String message;
}
```

â–¶ ì»¨íŠ¸ë¡¤ëŸ¬
```java
@Slf4j
@RestController
public class ApiExceptionV2Controller {

    @ResponseStatus(HttpStatus.BAD_REQUEST)
    @ExceptionHandler(IllegalArgumentException.class) //@ExceptionHandlerì™€ ê°™ìŒ
    public ErrorResult illegalExHandler(IllegalArgumentException e){
        log.error("[exceptionHandler] ex", e);
        return new ErrorResult("BAD", e.getMessage());
    }


    @ExceptionHandler
    public ResponseEntity<ErrorResult> userExHandler(UserException e){
        log.error("[exceptionHandler] ex", e);
        ErrorResult errorResult = new ErrorResult("USER-EX", e.getMessage());
        return new ResponseEntity<ErrorResult>(errorResult, HttpStatus.BAD_REQUEST);
    }


    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    @ExceptionHandler
    public ErrorResult exHandler(Exception e){
        log.error("[exceptionHandler] ex", e);
        return new ErrorResult("EX", "ë‚´ë¶€ ì˜¤ë¥˜");
    }


    @GetMapping("/api2/members/{id}")
    public MemberDto getMember(@PathVariable String id){
        if(id.equals("ex")){
            throw new RuntimeException("ì˜ëª»ëœ ì‚¬ìš©ì");
        }
        if (id.equals("bad")){
            throw new IllegalArgumentException("ì˜ëª»ëœ ì‚¬ìš©ì ì…ë ¥");
        }
        if (id.equals("user-ex")){
            throw new UserException("ì‚¬ìš©ì ì˜¤ë¥˜");
        }

        return new MemberDto(id, "hello " + id);
    }


    @Data
    @AllArgsConstructor
    static class MemberDto{
        private String memberId;
        private String name;
    }
}
```
- `illegalExHandler` : @RestControllerì´ë¯€ë¡œ illegalExHandle() ì—ë„ **@ResponseBody ê°€ ì ìš©**ëœë‹¤. ë”°ë¼ì„œ HTTP ì»¨ë²„í„°ê°€ ì‚¬ìš©ë˜ê³ , **ì‘ë‹µì€ `new ErrorResult()`ì— ë‚´ìš©ì„ JSONìœ¼ë¡œ ë°˜í™˜**ëœë‹¤. **@ResponseStatus(HttpStatus.BAD_REQUEST) ë¥¼ ì§€ì •í–ˆìœ¼ë¯€ë¡œ HTTP ìƒíƒœ ì½”ë“œ 400ìœ¼ë¡œ ì‘ë‹µ**í•œë‹¤. 
- `userExHandler` : ResponseEntity ë¥¼ ì‚¬ìš©í•´ì„œ HTTP ë©”ì‹œì§€ ë°”ë””ì— ì§ì ‘ ì‘ë‹µí•œë‹¤. ë¬¼ë¡  HTTP ì»¨ë²„í„°ê°€ ì‚¬ìš©ëœë‹¤. **ResponseEntityë¥¼ ì‚¬ìš©í•˜ë©´ HTTP ì‘ë‹µ ì½”ë“œë¥¼ í”„ë¡œê·¸ë˜ë°í•´ì„œ ë™ì ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.**

â–¶ ê²°ê³¼
- ì •ìƒ íë¦„
![[Pasted image 20230126015134.png]]

- bad
![[Pasted image 20230126015013.png]]

- user-ex
![[Pasted image 20230126015211.png]]

- ex
![[Pasted image 20230126015041.png]]


#### âœ”@ControllerAdvice
=> **ì •ìƒ ì½”ë“œì™€ ì˜ˆì™¸ ì²˜ë¦¬ ì½”ë“œê°€ í•˜ë‚˜ì˜ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì„ì—¬ ìˆì—ˆë‹¤**. `@ControllerAdvice` ë˜ëŠ” `@RestControllerAdvice` ë¥¼ ì‚¬ìš©í•˜ë©´ ë‘˜ì„ ë¶„ë¦¬í•  ìˆ˜ ìˆë‹¤.

â–¶@ControllerAdvice
- @ControllerAdvice ëŠ” ëŒ€ìƒìœ¼ë¡œ ì§€ì •í•œ ì—¬ëŸ¬ ì»¨íŠ¸ë¡¤ëŸ¬ì—Â **@ExceptionHandler**Â , @InitBinderÂ **ê¸°ëŠ¥ì„ ë¶€ì—¬**í•´ì£¼ëŠ” ì—­í• ì„ í•œë‹¤. ëŒ€ìƒì„ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ì— ì ìš©ëœë‹¤. (ê¸€ë¡œë²Œ ì ìš©)
- @RestControllerAdvice ëŠ” @ControllerAdvice ì™€ ê°™ê³ , @ResponseBody ê°€ ì¶”ê°€ë˜ì–´ ìˆë‹¤.

â–¶ëŒ€ìƒ ì»¨íŠ¸ë¡¤ëŸ¬ ì§€ì • ë°©ë²•
```java
// ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ ë²”ìœ„ ì§€ì •
@ControllerAdvice(annotations = RestController.class) 
public class ExampleAdvice1 {}

// íŒ¨í‚¤ì§€ ë³„ë¡œ ì§€ì •
@ControllerAdvice("org.example.controllers") 
public class ExampleAdvice2 {}

// ì—¬ëŸ¬ íŒ¨í‚¤ì§€ ë³„ë¡œ ì§€ì •
@ControllerAdvice(assignableTypes = {ControllerInterface.class, AbstractController.class})
public class ExampleAdvice3 {}
```


#### âœ”(ì½”ë“œ) ì˜ˆì™¸ì½”ë“œì™€ ì •ìƒì½”ë“œ ë¶„ë¦¬í•˜ê¸°
â–¶ ExControllerAdvice
=> ì˜ˆì™¸ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ **ì˜ˆì™¸ ë¶„ë¦¬**í•˜ê¸°
```java
@Slf4j
@RestControllerAdvice
public class ExControllerAdvice {

    @ResponseStatus(HttpStatus.BAD_REQUEST)
    @ExceptionHandler(IllegalArgumentException.class)
    public ErrorResult illegalExHandler(IllegalArgumentException e){
        log.error("[exceptionHandler] ex", e);
        return new ErrorResult("BAD", e.getMessage());
    }

    @ExceptionHandler
    public ResponseEntity<ErrorResult> userExHandler(UserException e){
        log.error("[exceptionHandler] ex", e);
        ErrorResult errorResult = new ErrorResult("USER-EX", e.getMessage());
        return new ResponseEntity<ErrorResult>(errorResult, HttpStatus.BAD_REQUEST);
    }

    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    @ExceptionHandler
    public ErrorResult exHandler(Exception e){
        log.error("[exceptionHandler] ex", e);
        return new ErrorResult("EX", "ë‚´ë¶€ ì˜¤ë¥˜");
    }
}
```

â–¶ ApiExceptionV3Controller
=> ì»¨íŠ¸ë¡¤ëŸ¬ì—ëŠ” **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ** ì˜´
```java
@Slf4j  
@RestController  
public class ApiExceptionV3Controller {  
  
    @GetMapping("/api3/members/{id}")  
    public MemberDto getMember(@PathVariable("id") String id) {  
  
        if (id.equals("ex")) {  
            throw new RuntimeException("ì˜ëª»ëœ ì‚¬ìš©ì");  
        }  
        if (id.equals("bad")) {  
            throw new IllegalArgumentException("ì˜ëª»ëœ ì…ë ¥ ê°’");  
        }  
        if (id.equals("user-ex")) {  
            throw new UserException("ì‚¬ìš©ì ì˜¤ë¥˜");  
        }  
  
        return new MemberDto(id, "hello " + id);  
    }  
  
    @Data  
    @AllArgsConstructor    static class MemberDto {  
        private String memberId;  
        private String name;  
    }  
  
}
```
